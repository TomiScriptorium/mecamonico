<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Mecamonico</title>
    
    <!-- --- CONFIGURACIÓN DE ICONOS --- -->
    <link rel="icon" type="image/png" href="iconomecamonico.png">
    <link rel="shortcut icon" type="image/png" href="iconomecamonico.png">
    <link rel="apple-touch-icon" href="iconomecamonico.png">
    
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="Mecamonico">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="Mecamonico">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#171717">
    
 <script>
        // Definimos las paletas de colores en formato RGB para soportar opacidades en Tailwind
        window.themesRGB = {
            rojo: { 50: '254 242 242', 100: '254 226 226', 200: '254 202 202', 300: '252 165 165', 400: '248 113 113', 500: '239 68 68', 600: '220 38 38', 700: '185 28 28', 800: '153 27 27', 900: '127 29 29' },
            azul: { 50: '239 246 255', 100: '219 234 254', 200: '191 219 254', 300: '147 197 253', 400: '96 165 250', 500: '59 130 246', 600: '37 99 235', 700: '29 78 216', 800: '30 64 175', 900: '30 58 138' },
            verde: { 50: '240 253 244', 100: '220 252 231', 200: '187 247 208', 300: '134 239 172', 400: '74 222 128', 500: '34 197 94', 600: '22 163 74', 700: '21 128 61', 800: '22 101 52', 900: '20 83 45' },
            naranja: { 50: '255 247 237', 100: '255 237 213', 200: '254 215 170', 300: '253 186 116', 400: '251 146 60', 500: '249 115 22', 600: '234 88 12', 700: '194 65 12', 800: '154 52 18', 900: '124 45 18' },
            morado: { 50: '250 245 255', 100: '243 232 255', 200: '233 213 255', 300: '216 180 254', 400: '192 132 252', 500: '168 85 247', 600: '147 51 234', 700: '126 34 206', 800: '107 33 168', 900: '88 28 135' }
        };
        
        // Leemos desde localStorage para aplicar el tema INMEDIATAMENTE y evitar parpadeos
        const savedTheme = localStorage.getItem('mech_theme') || 'rojo';
        const palette = window.themesRGB[savedTheme] || window.themesRGB.rojo;
        
        let cssVars = ':root {\n';
        for (const [weight, rgb] of Object.entries(palette)) {
            cssVars += `  --theme-${weight}: ${rgb};\n`;
        }
        cssVars += `  --mech-primary: rgb(var(--theme-600));\n}\n`;
        document.write('<style id="theme-vars">' + cssVars + '</style>');
    </script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        // Engañamos a Tailwind: todo lo que sea "red" usará nuestras variables dinámicas
                        red: {
                            50: 'rgb(var(--theme-50) / <alpha-value>)',
                            100: 'rgb(var(--theme-100) / <alpha-value>)',
                            200: 'rgb(var(--theme-200) / <alpha-value>)',
                            300: 'rgb(var(--theme-300) / <alpha-value>)',
                            400: 'rgb(var(--theme-400) / <alpha-value>)',
                            500: 'rgb(var(--theme-500) / <alpha-value>)',
                            600: 'rgb(var(--theme-600) / <alpha-value>)',
                            700: 'rgb(var(--theme-700) / <alpha-value>)',
                            800: 'rgb(var(--theme-800) / <alpha-value>)',
                            900: 'rgb(var(--theme-900) / <alpha-value>)',
                        },
                        mech: {
                            primary: 'var(--mech-primary)',
                            dark: '#171717',
                            steel: '#a3a3a3',
                            bg: '#f5f5f5'
                        }
                    }
                }
            }
        }
    </script>
    
    <!-- JSZip -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <!-- PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        window.addEventListener('load', function() {
            if (typeof pdfjsLib !== 'undefined') {
                pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
            }
        });
    </script>

    <!-- LIBRERIAS PARA GENERAR PDF (jspdf + html2canvas) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- AutoTable para tablas limpias en PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@300;400;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --mech-primary: #dc2626;
            --mech-dark: #171717;
            --mech-steel: #a3a3a3;
            --mech-bg: #f5f5f5;
        }

        body {
            font-family: 'Roboto Condensed', sans-serif; 
            background-color: var(--mech-bg);
            background-image: 
                linear-gradient(rgba(23, 23, 23, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(23, 23, 23, 0.05) 1px, transparent 1px);
            background-size: 40px 40px;
            animation: grid-pan 20s linear infinite; 
            -webkit-tap-highlight-color: transparent;
            font-size: 1.1rem; 
            overscroll-behavior-y: none;
            transition: background-color 0.3s ease;
        }

        .dark body {
            background-color: #0a0a0a;
            background-image: 
                linear-gradient(rgba(255, 255, 255, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.05) 1px, transparent 1px);
        }

        input, textarea, button, select, .font-handwriting {
            font-family: 'Roboto Condensed', sans-serif !important;
        }

        @keyframes grid-pan {
            0% { background-position: 0 0; }
            100% { background-position: 40px 40px; }
        }
        
        .work-order {
            background: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.15), 0 2px 4px -1px rgba(0, 0, 0, 0.1);
            border: 1px solid #d4d4d4;
            position: relative;
            border-left: 4px solid var(--mech-primary);
        }

        .dark .work-order {
            background: #171717;
            border-color: #404040;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
        }

        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* --- CLASES DE TRANSICIÓN PARA FLUIDEZ GENERAL --- */
        .fade-enter { animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards; }
        .fade-leave { animation: fadeOut 0.2s cubic-bezier(0.4, 0, 0.2, 1) forwards; }
        @keyframes fadeOut { from { opacity: 1; transform: translateY(0); } to { opacity: 0; transform: translateY(10px); } }

        .item-enter { animation: slideIn 0.3s cubic-bezier(0.4, 0, 0.2, 1) forwards; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-10px); } to { opacity: 1; transform: translateX(0); } }

        .btn-pill { border-radius: 4px; transition: all 0.2s; letter-spacing: 0.02em; }
        .btn-pill:active { transform: scale(0.95); }

        .item-leave { transition: all 0.3s ease-in; opacity: 0; transform: scale(0.9); height: 0 !important; margin: 0 !important; padding: 0 !important; overflow: hidden; }
        
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .pt-safe { padding-top: env(safe-area-inset-top); }

        #pdf-scroll-container { -webkit-overflow-scrolling: touch; }
        canvas { transform-origin: 0 0; }
        
        @keyframes wrench-turn {
            0%, 100% { transform: rotate(0deg); }
            25%, 75% { transform: rotate(-15deg); }
            50% { transform: rotate(0deg); }
        }
        .wrench-anim { display: inline-block; animation: wrench-turn 2s ease-in-out infinite; }

        @keyframes spin-slow { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        @keyframes spin-reverse-slow { from { transform: rotate(360deg); } to { transform: rotate(0deg); } }
        
        .animate-spin-slow { animation: spin-slow 20s linear infinite; }
        .animate-spin-reverse-slow { animation: spin-reverse-slow 25s linear infinite; }

        #nav-menu {
            -webkit-overflow-scrolling: touch; 
            scroll-behavior: smooth; 
        }
        
        .tab-content-transition { transition: opacity 0.3s ease, transform 0.3s ease; }
        .tab-content-enter { opacity: 1; transform: translateY(0); }
        .tab-content-leave { opacity: 0; transform: translateY(10px); }

        /* Estilo para el scroll del buscador */
        .search-scroll::-webkit-scrollbar { width: 6px; }
        .search-scroll::-webkit-scrollbar-track { background: transparent; }
        .search-scroll::-webkit-scrollbar-thumb { background-color: #525252; border-radius: 10px; }

        /* Evitar zoom automático en dispositivos móviles (iOS/Android) al abrir el teclado */
        @media screen and (max-width: 768px) {
            input, select, textarea {
                font-size: 16px !important;
            }
        }

        /* --- DRAG PARA PC --- */
        .mouse-drag { cursor: grab; }
        .mouse-drag.dragging { cursor: grabbing; }
        .mouse-drag.dragging * { user-select: none; }
    </style>
</head>
<body class="text-neutral-700 dark:text-neutral-200 h-screen sm:h-screen h-[100dvh] flex flex-col overflow-hidden relative transition-colors duration-300">

    <!-- Decoración de Fondo -->
    <div class="fixed inset-0 pointer-events-none z-0 overflow-hidden opacity-10 dark:opacity-5 transition-opacity duration-300">
        <svg class="absolute -top-20 -left-20 w-[500px] h-[500px] text-neutral-800 dark:text-neutral-600 animate-spin-slow" fill="currentColor" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg">
            <path d="M256 0C114.6 0 0 114.6 0 256s114.6 256 256 256s256-114.6 256-256S397.4 0 256 0zM256 464c-114.9 0-208-93.1-208-208S141.1 48 256 48s208 93.1 208 208S370.9 464 256 464z"/>
            <path d="M256 128c-70.7 0-128 57.3-128 128s57.3 128 128 128s128-57.3 128-128S326.7 128 256 128z M256 320c-35.3 0-64-28.7-64-64s28.7-64 64-64s64 28.7 64 64S291.3 320 256 320z"/>
            <path d="M256 80V120" stroke="currentColor" stroke-width="20" stroke-linecap="round"/>
            <path d="M424 200L384 220" stroke="currentColor" stroke-width="20" stroke-linecap="round"/>
            <path d="M360 400L330 370" stroke="currentColor" stroke-width="20" stroke-linecap="round"/>
            <path d="M152 400L182 370" stroke="currentColor" stroke-width="20" stroke-linecap="round"/>
            <path d="M88 200L128 220" stroke="currentColor" stroke-width="20" stroke-linecap="round"/>
        </svg>
        <i class="fa-solid fa-wrench text-neutral-400 dark:text-neutral-600 absolute -bottom-10 left-[10%] text-[12rem] rotate-12 opacity-50"></i>
    </div>

    <!-- Header -->
    <header class="bg-neutral-900 text-white pt-safe shadow-lg z-[60] shrink-0 relative overflow-visible border-b-4 border-red-600">
        <div class="p-3 sm:p-4 flex justify-between items-center relative z-20 gap-2 sm:gap-6">
            <!-- LOGO -->
            <div class="flex items-center gap-2 sm:gap-3 shrink-0 min-w-0">
                <div class="bg-red-700 p-2 sm:p-2.5 rounded-md shadow-md border border-red-500 cursor-pointer active:scale-95 transition-transform shrink-0" onclick="renderView('dashboard')" title="Ir a Inicio">
                    <i class="fa-solid fa-car text-base sm:text-xl text-white"></i>
                </div>
                <div class="cursor-pointer group min-w-0 flex-1" onclick="openAppTitleModal()" title="Editar Encabezado">
                    <h1 class="text-base sm:text-xl lg:text-2xl font-bold flex items-center gap-1 sm:gap-2 group-hover:text-red-400 transition-colors truncate">
                        <span id="header-app-title" class="truncate">Mecamonico</span> <i class="fa-solid fa-wrench wrench-anim text-red-500 text-[10px] sm:text-sm shrink-0"></i>
                    </h1>
                    <p id="header-app-subtitle" class="text-[9px] sm:text-[10px] lg:text-xs text-neutral-400 font-bold group-hover:text-neutral-300 transition-colors truncate">Gestión de Taller & Estudio</p>
                </div>
            </div>

            <!-- BUSCADOR UNIVERSAL (Escritorio) -->
            <div class="flex-1 relative hidden md:block max-w-xl">
                <i class="fa-solid fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-neutral-400"></i>
                <input type="text" id="desktop-search-input" placeholder="Buscar vehículos, inventario, notas, manuales..." class="w-full pl-11 pr-4 py-2.5 bg-neutral-800 border border-neutral-700 rounded-lg text-base text-white focus:ring-2 focus:ring-red-500 focus:border-transparent outline-none transition-all placeholder-neutral-500 shadow-inner" oninput="handleUniversalSearch(this.value, 'desktop')" onblur="hideUniversalSearch('desktop')" onfocus="handleUniversalSearch(this.value, 'desktop')" autocomplete="off">
                <div id="desktop-search-results" class="absolute left-0 right-0 top-[110%] bg-white dark:bg-neutral-800 rounded-lg shadow-2xl border border-neutral-200 dark:border-neutral-700 overflow-y-auto z-[70] hidden flex-col max-h-[400px] search-scroll text-neutral-800 dark:text-neutral-200"></div>
            </div>

            <!-- CONTROLES DERECHA -->
            <div class="flex items-center gap-1.5 sm:gap-2 shrink-0">
                <button onclick="toggleMobileSearch()" class="md:hidden text-xs sm:text-sm font-bold bg-neutral-800 hover:bg-neutral-700 text-neutral-200 w-8 h-8 sm:w-9 sm:h-9 flex items-center justify-center rounded border border-neutral-600 active:scale-95 transition-colors" title="Buscador Universal">
                    <i class="fa-solid fa-search"></i>
                </button>
                <button onclick="toggleDarkMode()" class="text-xs sm:text-sm font-bold bg-neutral-800 hover:bg-neutral-700 text-neutral-200 w-8 h-8 sm:w-9 sm:h-9 flex items-center justify-center rounded border border-neutral-600 active:scale-95 transition-colors" title="Modo Noche">
                    <i class="fa-solid fa-moon dark:hidden"></i>
                    <i class="fa-solid fa-sun hidden dark:inline text-yellow-400"></i>
                </button>
                <button onclick="openBackupModal()" class="text-xs sm:text-sm font-bold bg-neutral-800 hover:bg-neutral-700 text-neutral-200 px-2.5 py-1.5 sm:px-3 sm:py-1.5 rounded border border-neutral-600 active:scale-95 flex items-center gap-1.5" title="Base de Datos">
                    <i class="fa-solid fa-database text-red-500"></i> <span class="hidden sm:inline">Backup</span>
                </button>
                <!-- BOTÓN CONFIGURACIÓN -->
                <button onclick="openSettingsModal()" class="text-xs sm:text-sm font-bold bg-neutral-800 hover:bg-neutral-700 text-neutral-200 w-8 h-8 sm:w-9 sm:h-9 flex items-center justify-center rounded border border-neutral-600 active:scale-95 transition-colors" title="Configuración">
                    <i class="fa-solid fa-gear"></i>
                </button>
            </div>
        </div>
        
        <!-- BUSCADOR UNIVERSAL (Móvil Expandible - Ahora como Overlay Flotante Fijo) -->
        <div id="mobile-search-container" class="hidden fixed top-0 left-0 w-full pt-safe bg-neutral-900/95 backdrop-blur-md z-[100] border-b border-neutral-800 md:hidden shadow-2xl">
            <div class="flex items-center gap-2 p-3">
                <div class="relative flex-1">
                    <i class="fa-solid fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-neutral-400"></i>
                    <input type="text" id="mobile-search-input" placeholder="Buscar en la app..." class="w-full pl-10 pr-4 py-2.5 bg-neutral-800 border border-neutral-700 rounded-lg text-[16px] text-white focus:ring-2 focus:ring-red-500 outline-none transition shadow-inner" oninput="handleUniversalSearch(this.value, 'mobile')" onblur="hideUniversalSearch('mobile')" autocomplete="off">
                    <div id="mobile-search-results" class="absolute left-0 right-0 top-[110%] bg-white dark:bg-neutral-800 rounded-lg shadow-2xl border border-neutral-200 dark:border-neutral-700 overflow-y-auto z-[80] hidden flex-col max-h-[60vh] search-scroll text-neutral-800 dark:text-neutral-200"></div>
                </div>
                <button onclick="toggleMobileSearch()" class="text-neutral-400 hover:text-white shrink-0 px-2 py-1 flex items-center justify-center"><i class="fa-solid fa-xmark text-2xl"></i></button>
            </div>
        </div>
    </header>

    <!-- Main Container -->
    <main id="app-container" class="flex-1 overflow-y-auto p-4 pb-40 relative scroll-smooth hide-scrollbar z-10"></main>

    <!-- Nav Bar -->
    <div class="fixed bottom-0 w-full z-30 pb-safe pointer-events-none">
        <nav id="nav-menu" class="bg-neutral-900 mx-4 mb-4 rounded-xl shadow-[0_8px_30px_rgb(0,0,0,0.5)] border border-neutral-700 p-1 pointer-events-auto flex justify-start items-center overflow-x-auto hide-scrollbar snap-x snap-mandatory mouse-drag">
            
            <button onclick="renderView('dashboard')" class="nav-btn group relative p-2 min-w-[25%] flex-shrink-0 snap-start flex flex-col items-center gap-1 rounded-lg hover:bg-neutral-800 transition-colors" data-target="dashboard">
                <div class="w-full h-0.5 bg-red-600 absolute bottom-0 scale-x-0 group-[.active]:scale-x-75 transition-transform duration-300"></div>
                <i class="fa-solid fa-warehouse text-xl mb-0.5 text-neutral-500 group-[.active]:text-red-500 transition-colors"></i>
                <span class="text-[10px] font-bold text-neutral-500 group-[.active]:text-white">Inicio</span>
            </button>
            
            <button onclick="renderView('work_orders')" class="nav-btn group relative p-2 min-w-[25%] flex-shrink-0 snap-start flex flex-col items-center gap-1 rounded-lg hover:bg-neutral-800 transition-colors" data-target="work_orders">
                <div class="w-full h-0.5 bg-red-600 absolute bottom-0 scale-x-0 group-[.active]:scale-x-75 transition-transform duration-300"></div>
                <i class="fa-solid fa-car-side text-xl mb-0.5 text-neutral-500 group-[.active]:text-red-500 transition-colors"></i>
                <span class="text-[10px] font-bold text-neutral-500 group-[.active]:text-white">Taller</span>
            </button>

            <button onclick="renderView('shopping_list')" class="nav-btn group relative p-2 min-w-[25%] flex-shrink-0 snap-start flex flex-col items-center gap-1 rounded-lg hover:bg-neutral-800 transition-colors" data-target="shopping_list">
                <div class="w-full h-0.5 bg-red-600 absolute bottom-0 scale-x-0 group-[.active]:scale-x-75 transition-transform duration-300"></div>
                <i class="fa-solid fa-boxes-stacked text-xl mb-0.5 text-neutral-500 group-[.active]:text-red-500 transition-colors"></i>
                <span class="text-[10px] font-bold text-neutral-500 group-[.active]:text-white">Gestión</span>
            </button>
            
            <button onclick="renderView('todo')" class="nav-btn group relative p-2 min-w-[25%] flex-shrink-0 snap-start flex flex-col items-center gap-1 rounded-lg hover:bg-neutral-800 transition-colors" data-target="todo">
                <div class="w-full h-0.5 bg-red-600 absolute bottom-0 scale-x-0 group-[.active]:scale-x-75 transition-transform duration-300"></div>
                <i class="fa-solid fa-clipboard-list text-xl mb-0.5 text-neutral-500 group-[.active]:text-red-500 transition-colors"></i>
                <span class="text-[10px] font-bold text-neutral-500 group-[.active]:text-white">Tareas</span>
            </button>
            
            <button onclick="renderView('turnario')" class="nav-btn group relative p-2 min-w-[25%] flex-shrink-0 snap-start flex flex-col items-center gap-1 rounded-lg hover:bg-neutral-800 transition-colors" data-target="turnario">
                <div class="w-full h-0.5 bg-red-600 absolute bottom-0 scale-x-0 group-[.active]:scale-x-75 transition-transform duration-300"></div>
                <i class="fa-regular fa-calendar-days text-xl mb-0.5 text-neutral-500 group-[.active]:text-red-500 transition-colors"></i>
                <span class="text-[10px] font-bold text-neutral-500 group-[.active]:text-white">Calendario</span>
            </button>
            
            <button onclick="renderView('notes')" class="nav-btn group relative p-2 min-w-[25%] flex-shrink-0 snap-start flex flex-col items-center gap-1 rounded-lg hover:bg-neutral-800 transition-colors" data-target="notes">
                <div class="w-full h-0.5 bg-red-600 absolute bottom-0 scale-x-0 group-[.active]:scale-x-75 transition-transform duration-300"></div>
                <i class="fa-solid fa-book-open text-xl mb-0.5 text-neutral-500 group-[.active]:text-red-500 transition-colors"></i>
                <span class="text-[10px] font-bold text-neutral-500 group-[.active]:text-white">Apuntes</span>
            </button>
            
            <button onclick="renderView('links')" class="nav-btn group relative p-2 min-w-[25%] flex-shrink-0 snap-start flex flex-col items-center gap-1 rounded-lg hover:bg-neutral-800 transition-colors" data-target="links">
                <div class="w-full h-0.5 bg-red-600 absolute bottom-0 scale-x-0 group-[.active]:scale-x-75 transition-transform duration-300"></div>
                <i class="fa-solid fa-toolbox text-xl mb-0.5 text-neutral-500 group-[.active]:text-red-500 transition-colors"></i>
                <span class="text-[10px] font-bold text-neutral-500 group-[.active]:text-white">Información</span>
            </button>
        </nav>
    </div>

    <!-- Modales -->
    <div id="shift-modal" class="hidden fixed inset-0 bg-neutral-900/80 z-50 flex items-center justify-center p-4 backdrop-blur-sm transition-opacity">
        <div class="bg-white dark:bg-neutral-900 rounded-sm shadow-2xl w-full max-w-sm p-0 overflow-hidden transform transition-all scale-100 border-l-4 border-red-600">
             <div class="bg-neutral-100 dark:bg-neutral-800 p-4 border-b border-neutral-200 dark:border-neutral-700 flex justify-between items-center">
                 <h3 id="modal-date-title" class="text-xl font-bold text-neutral-800 dark:text-neutral-100">Editar Fecha</h3>
                 <button onclick="closeModal()" class="w-8 h-8 rounded bg-neutral-200 dark:bg-neutral-700 text-neutral-500 dark:text-neutral-300 flex items-center justify-center hover:bg-red-500 hover:text-white transition"><i class="fa-solid fa-xmark"></i></button>
             </div>
             <div class="p-6">
                <label class="block text-sm font-bold text-neutral-400 mb-3 flex items-center gap-2"><i class="fa-solid fa-tag"></i> Tipo de Evento:</label>
                <div class="grid grid-cols-2 gap-3 mb-6">
                    <button onclick="setShiftType('guardia')" data-type="guardia" class="shift-type-btn p-3 rounded bg-white dark:bg-neutral-800 border border-neutral-300 dark:border-neutral-600 text-neutral-500 dark:text-neutral-400 hover:border-red-500 hover:text-red-600 font-bold text-sm transition-all flex flex-col items-center gap-2 shadow-sm"><i class="fa-solid fa-wrench text-xl"></i> Práctica Taller</button>
                    <button onclick="setShiftType('dia')" data-type="dia" class="shift-type-btn p-3 rounded bg-white dark:bg-neutral-800 border border-neutral-300 dark:border-neutral-600 text-neutral-500 dark:text-neutral-400 hover:border-blue-500 hover:text-blue-600 font-bold text-sm transition-all flex flex-col items-center gap-2 shadow-sm"><i class="fa-solid fa-file-export text-xl"></i> Entrega Informe</button>
                    <button onclick="setShiftType('noche')" data-type="noche" class="shift-type-btn p-3 rounded bg-white dark:bg-neutral-800 border border-neutral-300 dark:border-neutral-600 text-neutral-500 dark:text-neutral-400 hover:border-indigo-500 hover:text-indigo-600 font-bold text-sm transition-all flex flex-col items-center gap-2 shadow-sm"><i class="fa-solid fa-file-signature text-xl"></i> Certamen</button>
                    <button onclick="setShiftType('post')" data-type="post" class="shift-type-btn p-3 rounded bg-white dark:bg-neutral-800 border border-neutral-300 dark:border-neutral-600 text-neutral-500 dark:text-neutral-400 hover:border-yellow-500 hover:text-yellow-600 font-bold text-sm transition-all flex flex-col items-center gap-2 shadow-sm"><i class="fa-solid fa-book text-xl"></i> Estudio/Teoría</button>
                    <button onclick="setShiftType('libre')" data-type="libre" class="shift-type-btn p-3 rounded bg-white dark:bg-neutral-800 border border-neutral-300 dark:border-neutral-600 text-neutral-500 dark:text-neutral-400 hover:border-green-500 hover:text-green-600 font-bold text-sm transition-all flex flex-col items-center gap-2 shadow-sm"><i class="fa-solid fa-calendar-check text-xl"></i> Vehículo Agendado</button>
                    <button onclick="setShiftType(null)" data-type="null" class="shift-type-btn p-3 rounded bg-neutral-50 dark:bg-neutral-800 border border-neutral-200 dark:border-neutral-600 text-neutral-400 dark:text-neutral-500 hover:bg-neutral-100 hover:text-neutral-600 font-bold text-sm transition-all flex flex-col items-center gap-2 shadow-sm"><i class="fa-solid fa-eraser text-xl"></i> Limpiar</button>
                </div>
                <div class="space-y-4">
                    <div class="bg-neutral-50 dark:bg-neutral-800 p-3 rounded border border-neutral-200 dark:border-neutral-700 flex items-center gap-3"><i class="fa-regular fa-clock text-neutral-400"></i><input type="time" id="modal-event-time" class="bg-transparent w-full text-lg font-bold text-neutral-700 dark:text-neutral-200 focus:outline-none"></div>
                    <div class="bg-neutral-50 dark:bg-neutral-800 p-3 rounded border border-neutral-200 dark:border-neutral-700 flex items-center gap-3"><i class="fa-solid fa-pen-to-square text-neutral-400"></i><input type="text" id="modal-note-input" class="bg-transparent w-full text-lg font-semibold text-neutral-700 dark:text-neutral-200 focus:outline-none placeholder-neutral-400" placeholder="Detalle técnico / Examen..."></div>
                </div>
                <div class="flex justify-between items-center mt-6 gap-3">
                    <button onclick="deleteCurrentShift()" class="px-4 py-3 text-red-400 hover:text-red-600 hover:bg-red-50 dark:hover:bg-neutral-800 rounded font-bold text-lg transition-colors"><i class="fa-solid fa-trash-can"></i></button>
                    <button onclick="saveShift()" class="flex-1 py-3 bg-neutral-800 dark:bg-neutral-700 text-white rounded hover:bg-neutral-700 dark:hover:bg-neutral-600 shadow-lg transform active:scale-95 transition-all font-bold text-sm"><i class="fa-solid fa-floppy-disk mr-2"></i> Guardar Ficha</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Otros modales -->
    <div id="confirm-modal" class="hidden fixed inset-0 bg-neutral-900/80 z-[70] flex items-center justify-center p-4 backdrop-blur-sm"><div class="bg-white dark:bg-neutral-900 rounded shadow-xl w-full max-w-xs p-6 text-center border-t-4 border-red-500"><div class="w-14 h-14 bg-red-50 dark:bg-red-900/30 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4 border-4 border-red-100 dark:border-red-900/50"><i class="fa-solid fa-triangle-exclamation text-xl"></i></div><h3 class="text-xl font-bold text-neutral-800 dark:text-neutral-100 mb-2">¿Confirmar?</h3><p id="confirm-message" class="text-sm text-neutral-500 dark:text-neutral-400 mb-6 font-mono">Esta acción es irreversible.</p><div class="flex justify-center gap-3"><button onclick="closeConfirmModal()" class="px-5 py-2 bg-neutral-100 dark:bg-neutral-800 text-neutral-600 dark:text-neutral-300 rounded font-bold text-sm">Cancelar</button><button id="confirm-btn-action" class="px-5 py-2 bg-red-600 text-white rounded font-bold text-sm shadow-md">Confirmar</button></div></div></div>
    <div id="folder-modal" class="hidden fixed inset-0 bg-neutral-900/80 z-[60] flex items-center justify-center p-4 backdrop-blur-sm"><div class="bg-white dark:bg-neutral-900 rounded shadow-xl w-full max-w-xs p-6 border-l-4 border-red-600"><h3 class="text-xl font-bold text-neutral-800 dark:text-neutral-100 mb-4 flex items-center gap-2"><i class="fa-solid fa-folder-plus text-red-600"></i> Nueva Sección</h3><input type="text" id="new-folder-name" class="w-full p-3 bg-neutral-50 dark:bg-neutral-800 border border-neutral-300 dark:border-neutral-700 rounded mb-4 focus:ring-2 focus:ring-red-500 outline-none text-lg font-bold dark:text-white" placeholder="Ej: Motores, Electricidad..."><div class="flex justify-end gap-3"><button onclick="closeFolderModal()" class="px-4 py-2 text-neutral-400 hover:text-neutral-600 font-bold text-sm">Cancelar</button><button onclick="createFolder()" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 font-bold text-sm shadow-lg">Crear</button></div></div></div>
    <div id="name-modal" class="hidden fixed inset-0 bg-neutral-900/80 z-[60] flex items-center justify-center p-4 backdrop-blur-sm"><div class="bg-white dark:bg-neutral-900 rounded shadow-xl w-full max-w-xs p-6 border-l-4 border-neutral-800 dark:border-neutral-600"><h3 class="text-xl font-bold text-neutral-800 dark:text-neutral-100 mb-4 flex items-center gap-2"><i class="fa-solid fa-id-card text-neutral-600"></i> Credencial</h3><p class="text-sm text-neutral-400 mb-3 font-bold">Nombre del Técnico/a</p><input type="text" id="new-user-name" class="w-full p-3 bg-neutral-50 dark:bg-neutral-800 border border-neutral-300 dark:border-neutral-700 rounded mb-4 focus:ring-2 focus:ring-neutral-500 outline-none text-lg font-bold text-neutral-800 dark:text-white" placeholder="Ej: Mecánico Juan"><div class="flex justify-end gap-3"><button onclick="closeNameModal()" class="px-4 py-2 text-neutral-400 hover:text-neutral-600 font-bold text-sm">Cancelar</button><button onclick="saveName()" class="px-4 py-2 bg-neutral-800 dark:bg-neutral-700 text-white rounded hover:bg-neutral-700 font-bold text-sm shadow-lg">Guardar</button></div></div></div>
    <div id="title-modal" class="hidden fixed inset-0 bg-neutral-900/80 z-[60] flex items-center justify-center p-4 backdrop-blur-sm"><div class="bg-white dark:bg-neutral-900 rounded shadow-xl w-full max-w-xs p-6 border-l-4 border-red-600"><h3 class="text-xl font-bold text-neutral-800 dark:text-neutral-100 mb-4 flex items-center gap-2"><i class="fa-solid fa-tag text-red-600"></i> Rol / Título</h3><p class="text-sm text-neutral-400 mb-3 font-bold">Define tu cargo en el taller</p><input type="text" id="new-user-title" class="w-full p-3 bg-neutral-50 dark:bg-neutral-800 border border-neutral-300 dark:border-neutral-700 rounded mb-4 focus:ring-2 focus:ring-red-500 outline-none text-lg font-bold text-neutral-800 dark:text-white" placeholder="Ej: Estudiante"><div class="flex justify-end gap-3"><button onclick="closeTitleModal()" class="px-4 py-2 text-neutral-400 hover:text-neutral-600 font-bold text-sm">Cancelar</button><button onclick="saveTitle()" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 font-bold text-sm shadow-lg">Guardar</button></div></div></div>
    
    <div id="app-title-modal" class="hidden fixed inset-0 bg-neutral-900/80 z-[60] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white dark:bg-neutral-900 rounded shadow-xl w-full max-w-xs p-6 border-l-4 border-red-600">
            <h3 class="text-xl font-bold text-neutral-800 dark:text-neutral-100 mb-4 flex items-center gap-2"><i class="fa-solid fa-pen-to-square text-red-600"></i> Encabezado</h3>
            <p class="text-sm text-neutral-400 mb-1 font-bold">Título Principal</p>
            <input type="text" id="new-app-title" class="w-full p-3 bg-neutral-50 dark:bg-neutral-800 border border-neutral-300 dark:border-neutral-700 rounded mb-3 focus:ring-2 focus:ring-red-500 outline-none text-lg font-bold text-neutral-800 dark:text-white" placeholder="Ej: Mi Taller">
            <p class="text-sm text-neutral-400 mb-1 font-bold">Subtítulo</p>
            <input type="text" id="new-app-subtitle" class="w-full p-3 bg-neutral-50 dark:bg-neutral-800 border border-neutral-300 dark:border-neutral-700 rounded mb-4 focus:ring-2 focus:ring-red-500 outline-none text-sm font-bold text-neutral-800 dark:text-white" placeholder="Ej: Especialista Automotriz">
            <div class="flex justify-end gap-3">
                <button onclick="closeAppTitleModal()" class="px-4 py-2 text-neutral-400 hover:text-neutral-600 font-bold text-sm">Cancelar</button>
                <button onclick="saveAppTitle()" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 font-bold text-sm shadow-lg">Guardar</button>
            </div>
        </div>
    </div>
    
    <div id="history-modal" class="hidden fixed inset-0 bg-neutral-900/80 z-[60] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white dark:bg-neutral-900 rounded-xl shadow-2xl w-full max-w-2xl p-0 overflow-hidden flex flex-col max-h-[90vh] border-t-4 border-neutral-600 fade-enter">
            <div class="bg-neutral-100 dark:bg-neutral-800 p-4 border-b border-neutral-200 dark:border-neutral-700 flex justify-between items-center shrink-0">
                <h3 class="text-xl font-bold text-neutral-800 dark:text-neutral-100 flex items-center gap-2"><i class="fa-solid fa-clock-rotate-left text-neutral-500"></i> Historial de Vehículos</h3>
                <button onclick="closeHistoryModal()" class="w-8 h-8 rounded bg-neutral-200 dark:bg-neutral-700 text-neutral-500 hover:bg-red-500 hover:text-white transition flex items-center justify-center"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="p-4 border-b border-neutral-200 dark:border-neutral-700 shrink-0 bg-neutral-50 dark:bg-neutral-800/30">
                <div class="relative">
                    <i class="fa-solid fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-neutral-400"></i>
                    <input type="text" id="history-search-input" placeholder="Buscar por patente o modelo..." class="w-full pl-10 pr-4 py-3 rounded bg-white dark:bg-neutral-900 border border-neutral-300 dark:border-neutral-700 focus:ring-2 focus:ring-neutral-500 outline-none text-neutral-700 dark:text-neutral-200 font-bold transition shadow-sm" onkeyup="renderHistoryList(this.value)">
                </div>
            </div>
            <div class="flex-1 overflow-y-auto p-4 bg-neutral-50 dark:bg-neutral-900/50 hide-scrollbar" id="history-list-container">
                </div>
        </div>
    </div>
    <div id="patient-modal" class="hidden fixed inset-0 bg-neutral-900/80 z-[60] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white dark:bg-neutral-900 rounded shadow-xl w-full max-w-sm p-6 border-t-4 border-blue-600">
            <h3 class="text-xl font-bold text-neutral-800 dark:text-neutral-100 mb-4 flex items-center gap-2"><i class="fa-solid fa-car-side text-blue-600"></i> Ingresar Vehículo</h3>
            <div class="space-y-3">
                <input type="text" id="patient-name" class="w-full p-3 bg-neutral-50 dark:bg-neutral-800 border border-neutral-300 dark:border-neutral-700 rounded focus:ring-2 focus:ring-blue-600 outline-none text-lg font-bold dark:text-white" placeholder="Modelo / Cliente">
                <input type="tel" id="patient-contact" class="w-full p-3 bg-neutral-50 dark:bg-neutral-800 border border-neutral-300 dark:border-neutral-700 rounded focus:ring-2 focus:ring-blue-600 outline-none text-lg font-bold dark:text-white" placeholder="Teléfono / Whatsapp">
                <div class="flex gap-3">
                    <input type="text" id="patient-room" class="w-1/3 p-3 bg-neutral-50 dark:bg-neutral-800 border border-neutral-300 dark:border-neutral-700 rounded focus:ring-2 focus:ring-blue-600 outline-none text-lg font-bold text-center dark:text-white" placeholder="Patente">
                    <input type="text" id="patient-dx" class="w-2/3 p-3 bg-neutral-50 dark:bg-neutral-800 border border-neutral-300 dark:border-neutral-700 rounded focus:ring-2 focus:ring-blue-600 outline-none text-lg font-bold dark:text-white" placeholder="Falla / Servicio">
                </div>
            </div>
            <div class="flex justify-end gap-3 mt-6">
                <button onclick="closePatientModal()" class="px-4 py-2 text-neutral-400 hover:text-neutral-600 font-bold text-sm">Cancelar</button>
                <button onclick="createPatient()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 font-bold text-sm shadow-lg">Ingresar Orden</button>
            </div>
        </div>
    </div>
    <div id="backup-modal" class="hidden fixed inset-0 bg-neutral-900/80 z-[60] flex items-center justify-center p-4 backdrop-blur-sm"><div class="bg-white dark:bg-neutral-900 rounded shadow-xl w-full max-w-sm p-6 border-l-4 border-neutral-500"><h3 class="text-xl font-bold text-neutral-800 dark:text-neutral-100 mb-4 flex items-center gap-2"><i class="fa-solid fa-database text-neutral-500"></i> Base de Datos</h3><p class="text-sm text-neutral-500 mb-6 font-mono">Respaldo comprimido de registros e imágenes.</p><div class="grid gap-3"><button onclick="downloadBackupFile()" class="p-4 rounded border border-neutral-300 dark:border-neutral-700 hover:border-blue-500 hover:bg-blue-50 dark:hover:bg-neutral-800 transition flex items-center gap-3 group"><div class="w-10 h-10 rounded bg-blue-100 dark:bg-blue-900 text-blue-600 dark:text-blue-300 flex items-center justify-center group-hover:scale-110 transition"><i class="fa-solid fa-download"></i></div><div class="text-left"><h4 class="font-bold text-neutral-700 dark:text-neutral-200 text-sm">Descargar ZIP</h4><p class="text-xs text-neutral-400">Todo el taller</p></div></button><label class="p-4 rounded border border-neutral-300 dark:border-neutral-700 hover:border-green-500 hover:bg-green-50 dark:hover:bg-neutral-800 transition flex items-center gap-3 group"><div class="w-10 h-10 rounded bg-green-100 dark:bg-green-900 text-green-600 dark:text-green-300 flex items-center justify-center group-hover:scale-110 transition"><i class="fa-solid fa-upload"></i></div><div class="text-left"><h4 class="font-bold text-neutral-700 dark:text-neutral-200 text-sm">Restaurar ZIP</h4><p class="text-xs text-neutral-400">Cargar archivo</p></div><input type="file" id="backup-file-input" accept=".zip" class="hidden" onchange="importBackupFromFile(this)"></label><button onclick="exportDataToClipboard()" class="p-4 rounded border border-neutral-300 dark:border-neutral-700 hover:border-purple-500 hover:bg-purple-50 dark:hover:bg-neutral-800 transition flex items-center gap-3 group"><div class="w-10 h-10 rounded bg-purple-100 dark:bg-purple-900 text-purple-600 dark:text-purple-300 flex items-center justify-center group-hover:scale-110 transition"><i class="fa-solid fa-copy"></i></div><div class="text-left"><h4 class="font-bold text-neutral-700 dark:text-neutral-200 text-sm">JSON Texto</h4><p class="text-xs text-neutral-400">Portapapeles (Rápido)</p></div></button></div><div class="flex justify-end gap-3 mt-6"><button onclick="closeBackupModal()" class="px-4 py-2 text-neutral-400 hover:text-neutral-600 font-bold text-sm">Cerrar</button></div></div></div>
    <div id="pdf-reader-modal" class="hidden fixed inset-0 bg-neutral-900 z-[90] flex flex-col animate-fade-in outline-none" tabindex="0">
        <div class="bg-neutral-800 text-white pt-safe px-4 pb-3 flex justify-between items-center shadow-lg shrink-0 z-20 relative border-b border-neutral-600">
            <h3 id="pdf-reader-title" class="text-lg font-bold truncate max-w-[60%] flex items-center font-mono text-red-500"><i class="fa-solid fa-file-pdf mr-2 text-white"></i> Manual</h3>
            <div class="flex gap-2">
                <button onclick="closePdfReader()" class="w-9 h-9 rounded bg-neutral-700 hover:bg-red-600 flex items-center justify-center transition border border-neutral-600 active:scale-90"><i class="fa-solid fa-xmark"></i></button>
            </div>
        </div>
        <div class="bg-neutral-800 text-white p-2 flex justify-center items-center gap-3 shadow-md shrink-0 z-10 border-b border-neutral-700">
            <button onclick="changePdfPage(-1)" class="w-10 h-10 flex items-center justify-center bg-neutral-700 rounded hover:bg-neutral-600 transition active:scale-95 border border-neutral-600"><i class="fa-solid fa-chevron-left"></i></button>
            <div class="flex items-center gap-2 text-sm font-bold bg-neutral-900 px-3 py-1.5 rounded border border-neutral-700 font-mono text-red-500">
                <span>P.</span>
                <input type="number" id="pdf-page-num" class="w-10 bg-transparent border-b border-neutral-500 text-center text-white focus:outline-none focus:border-red-500 font-bold p-0" value="1" min="1" onchange="jumpToPdfPage(this.value)">
                <span class="text-neutral-500">/ <span id="pdf-page-count">--</span></span>
            </div>
            <button onclick="changePdfPage(1)" class="w-10 h-10 flex items-center justify-center bg-neutral-700 rounded hover:bg-neutral-600 transition active:scale-95 border border-neutral-600"><i class="fa-solid fa-chevron-right"></i></button>
            <div class="w-px h-6 bg-neutral-600 mx-1"></div>
            <button onclick="manualZoom(-0.2)" class="w-10 h-10 flex items-center justify-center bg-neutral-700 rounded hover:bg-neutral-600 transition active:scale-95 border border-neutral-600"><i class="fa-solid fa-magnifying-glass-minus text-xs"></i></button>
            <button onclick="manualZoom(0.2)" class="w-10 h-10 flex items-center justify-center bg-neutral-700 rounded hover:bg-neutral-600 transition active:scale-95 border border-neutral-600"><i class="fa-solid fa-magnifying-glass-plus text-xs"></i></button>
        </div>
        <div class="flex-1 bg-neutral-500 relative overflow-auto flex justify-center items-start p-4" id="pdf-scroll-container">
            <canvas id="the-canvas" class="shadow-2xl transition-transform duration-100 ease-out origin-top-left ring-1 ring-black/20"></canvas>
            <div id="pdf-loader" class="absolute inset-0 flex items-center justify-center bg-transparent pointer-events-none z-10 hidden">
                <div class="bg-neutral-900/90 p-3 rounded shadow-lg">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-red-500"></div>
                </div>
            </div>
        </div>
        <div class="bg-neutral-800 h-safe-bottom shrink-0 pb-safe"></div>
    </div>

    <div id="toast" class="fixed top-24 left-1/2 transform -translate-x-1/2 bg-neutral-800 dark:bg-neutral-700 text-white px-6 py-3 rounded-full shadow-xl opacity-0 transition-all duration-300 pointer-events-none z-[80] flex items-center gap-3 text-sm font-bold translate-y-4 border border-neutral-600">
        <div class="w-6 h-6 bg-red-600 rounded-full flex items-center justify-center text-xs text-white"><i class="fa-solid fa-check"></i></div>
        <span id="toast-msg">Notificación</span>
    </div>

    <!-- Modal Finanzas -->
    <div id="finance-modal" class="hidden fixed inset-0 bg-neutral-900/80 z-[80] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white dark:bg-neutral-900 rounded-xl shadow-2xl w-full max-w-md overflow-hidden flex flex-col max-h-[90vh] border border-neutral-300 dark:border-neutral-700 fade-enter">
            <!-- Header Nav -->
            <div class="bg-neutral-100 dark:bg-neutral-800 p-3 sm:p-4 border-b border-neutral-200 dark:border-neutral-700 flex justify-between items-center relative">
                <div class="flex gap-1.5 relative z-10">
                    <button onclick="changeFinanceMonth(-1)" class="w-8 h-8 flex items-center justify-center text-neutral-500 dark:text-neutral-400 hover:text-red-600 bg-white dark:bg-neutral-700 rounded shadow-sm transition"><i class="fa-solid fa-chevron-left text-sm"></i></button>
                    <button onclick="changeFinanceMonth(1)" class="w-8 h-8 flex items-center justify-center text-neutral-500 dark:text-neutral-400 hover:text-red-600 bg-white dark:bg-neutral-700 rounded shadow-sm transition"><i class="fa-solid fa-chevron-right text-sm"></i></button>
                </div>
                <div class="text-center absolute left-1/2 transform -translate-x-1/2 w-[50%] pointer-events-none">
                    <p class="text-[10px] font-bold uppercase tracking-wider text-neutral-400 dark:text-neutral-500">Resumen Financiero</p>
                    <h3 id="finance-month-title" class="text-lg font-black text-neutral-800 dark:text-neutral-100 uppercase tracking-tight pointer-events-auto">Cargando...</h3>
                </div>
                <button onclick="closeFinanceModal()" class="w-8 h-8 rounded bg-neutral-200 dark:bg-neutral-700 text-neutral-500 dark:text-neutral-400 flex items-center justify-center hover:bg-red-500 hover:text-white transition relative z-10"><i class="fa-solid fa-xmark"></i></button>
            </div>
            
            <!-- KPIs -->
            <div class="p-4 grid grid-cols-2 gap-3 shrink-0">
                <div class="bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800/50 p-3 rounded-lg text-center">
                    <p class="text-[10px] font-bold text-green-700 dark:text-green-500 uppercase tracking-wider mb-1"><i class="fa-solid fa-arrow-trend-up"></i> Ingresos</p>
                    <p id="finance-income" class="text-lg font-black text-green-700 dark:text-green-400">$0</p>
                </div>
                <div class="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800/50 p-3 rounded-lg text-center">
                    <p class="text-[10px] font-bold text-red-700 dark:text-red-500 uppercase tracking-wider mb-1"><i class="fa-solid fa-arrow-trend-down"></i> Gastos</p>
                    <p id="finance-expense" class="text-lg font-black text-red-700 dark:text-red-400">$0</p>
                </div>
                <div class="col-span-2 bg-neutral-100 dark:bg-neutral-800 border border-neutral-200 dark:border-neutral-700 p-3 rounded-lg flex justify-between items-center px-6">
                    <p class="text-xs font-bold text-neutral-500 dark:text-neutral-400 uppercase tracking-wider">Balance Mensual:</p>
                    <p id="finance-balance" class="text-xl font-black text-neutral-800 dark:text-neutral-100">$0</p>
                </div>
            </div>

            <!-- Form Nuevo Movimiento -->
            <div class="px-4 pb-4 border-b border-neutral-200 dark:border-neutral-700 bg-neutral-50 dark:bg-neutral-800/30 flex flex-col gap-3 shrink-0">
                <p class="text-[10px] font-bold uppercase tracking-wider text-neutral-400 dark:text-neutral-500"><i class="fa-solid fa-plus-circle"></i> Nuevo Registro</p>
                <div class="flex gap-2">
                    <select id="fin-type" class="flex-1 p-2 bg-white dark:bg-neutral-900 border border-neutral-300 dark:border-neutral-700 rounded text-sm font-bold text-neutral-700 dark:text-neutral-200 outline-none focus:border-red-500 focus:ring-1 focus:ring-red-500 transition">
                        <option value="income">Ingreso (+)</option>
                        <option value="expense">Gasto (-)</option>
                    </select>
                    <input type="date" id="fin-date" class="w-[45%] p-2 bg-white dark:bg-neutral-900 border border-neutral-300 dark:border-neutral-700 rounded text-sm font-bold text-neutral-700 dark:text-neutral-200 outline-none focus:border-red-500 focus:ring-1 focus:ring-red-500 transition">
                </div>
                <div class="flex gap-2">
                    <input type="text" id="fin-concept" placeholder="Concepto (ej: Ajuste frenos)" class="flex-1 p-2 bg-white dark:bg-neutral-900 border border-neutral-300 dark:border-neutral-700 rounded text-sm font-bold text-neutral-700 dark:text-neutral-200 outline-none focus:border-red-500 focus:ring-1 focus:ring-red-500 transition">
                    <input type="number" id="fin-amount" placeholder="$0" min="0" class="w-1/3 p-2 bg-white dark:bg-neutral-900 border border-neutral-300 dark:border-neutral-700 rounded text-sm font-bold text-right text-neutral-700 dark:text-neutral-200 outline-none focus:border-red-500 focus:ring-1 focus:ring-red-500 transition">
                </div>
                <button onclick="addTransaction()" class="w-full bg-neutral-800 dark:bg-neutral-700 text-white font-bold rounded py-2.5 shadow hover:bg-neutral-700 transition active:scale-95 text-sm uppercase tracking-wide"><i class="fa-solid fa-floppy-disk mr-1"></i> Guardar Movimiento</button>
            </div>

            <!-- Lista Historial -->
            <div class="flex-1 overflow-y-auto bg-white dark:bg-neutral-900 p-2 hide-scrollbar min-h-[150px]" id="finance-list">
                <!-- Items generados por JS -->
            </div>
        </div>
    </div>

    <!-- Modal Configuración -->
    <div id="settings-modal" class="hidden fixed inset-0 bg-neutral-900/80 z-[80] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white dark:bg-neutral-900 rounded-xl shadow-2xl w-full max-w-sm p-6 border border-neutral-300 dark:border-neutral-700 fade-enter relative">
            <button onclick="closeSettingsModal()" class="absolute top-4 right-4 w-8 h-8 rounded bg-neutral-100 dark:bg-neutral-800 text-neutral-500 hover:bg-red-500 hover:text-white transition flex items-center justify-center"><i class="fa-solid fa-xmark"></i></button>
            
            <h3 class="text-xl font-bold text-neutral-800 dark:text-neutral-100 flex items-center gap-2 mb-6"><i class="fa-solid fa-gear text-neutral-500"></i> Configuración</h3>
            <div class="mb-6 p-3 bg-neutral-50 dark:bg-neutral-800/50 rounded-lg border border-neutral-200 dark:border-neutral-700">
                <h4 class="text-xs font-bold text-neutral-400 uppercase tracking-wider mb-3 flex items-center gap-2"><i class="fa-solid fa-palette"></i> Tema Visual</h4>
                <div class="flex gap-4 justify-center py-2">
                    <button onclick="setAppTheme('rojo')" class="w-8 h-8 rounded-full bg-[#dc2626] shadow-md ring-2 ring-transparent hover:scale-110 transition focus:outline-none" id="theme-btn-rojo" title="Rojo"></button>
                    <button onclick="setAppTheme('azul')" class="w-8 h-8 rounded-full bg-[#2563eb] shadow-md ring-2 ring-transparent hover:scale-110 transition focus:outline-none" id="theme-btn-azul" title="Azul"></button>
                    <button onclick="setAppTheme('verde')" class="w-8 h-8 rounded-full bg-[#16a34a] shadow-md ring-2 ring-transparent hover:scale-110 transition focus:outline-none" id="theme-btn-verde" title="Verde"></button>
                    <button onclick="setAppTheme('naranja')" class="w-8 h-8 rounded-full bg-[#ea580c] shadow-md ring-2 ring-transparent hover:scale-110 transition focus:outline-none" id="theme-btn-naranja" title="Naranja"></button>
                    <button onclick="setAppTheme('morado')" class="w-8 h-8 rounded-full bg-[#9333ea] shadow-md ring-2 ring-transparent hover:scale-110 transition focus:outline-none" id="theme-btn-morado" title="Morado"></button>
                </div>
            </div>
            
            <!-- Toggle Finanzas -->
            <div class="mb-6 p-3 bg-neutral-50 dark:bg-neutral-800/50 rounded-lg border border-neutral-200 dark:border-neutral-700">
                <label class="flex items-center justify-between cursor-pointer">
                    <span class="text-sm font-bold text-neutral-700 dark:text-neutral-300 flex items-center gap-2"><i class="fa-solid fa-wallet text-green-500 w-4 text-center"></i> Balance Diario</span>
                    <input type="checkbox" id="toggle-finance-widget" onchange="toggleFinanceSetting(this.checked)" class="w-5 h-5 accent-red-600 cursor-pointer">
                </label>
                <p class="text-[10px] text-neutral-500 mt-1 ml-6">Muestra tus ganancias en la pestaña de Inicio.</p>
            </div>

            <!-- Toggles Módulos -->
            <div>
                <h4 class="text-xs font-bold text-neutral-400 uppercase tracking-wider mb-3 pl-1">Visibilidad de Módulos</h4>
                <div class="space-y-2" id="modules-settings-list">
                    <!-- Generado por JS -->
                </div>
            </div>
        </div>
    </div>

    <script>
        const APP_KEY = 'mecamonico_data_v1'; 
        let state = {
            view: 'dashboard', todos: [], notes: [], folders: [], links: [], pdfs: [], shifts: {}, patients: [], 
            shoppingList: [], shopAddress: '', shopTitle: 'Lista de Compras', shopNote: '', 
            serviceList: [], inventoryList: [], transactions: [],
            activeShopTab: 'items', 
            appTitle: 'Mecamonico', appSubtitle: 'Gestión de Taller & Estudio', 
            userProfileImage: null, userName: 'Usuario', userTitle: 'Estudiante', currentDate: new Date(), currentFolderId: 'all', editingNoteId: null, activeInfoTab: 'web',
            darkMode: false,
            showFinanceWidget: true,
            visibleModules: ['dashboard', 'work_orders', 'shopping_list', 'todo', 'turnario', 'notes', 'links']
        };
        let selectedDateKey = null; 
        let tempShiftType = null;
        let currentNoteImages = []; 
        let currentFinanceDate = new Date();

        const idbKeyval = {
            async get(key) { return new Promise((resolve, reject) => { const request = indexedDB.open('mecamonico-db', 1); request.onupgradeneeded = () => request.result.createObjectStore('store'); request.onerror = () => reject(request.error); request.onsuccess = () => { const db = request.result; const tx = db.transaction('store', 'readonly'); const store = tx.objectStore('store'); const req = store.get(key); req.onsuccess = () => resolve(req.result); req.onerror = () => reject(req.error); }; }); },
            async set(key, val) { return new Promise((resolve, reject) => { const request = indexedDB.open('mecamonico-db', 1); request.onupgradeneeded = () => request.result.createObjectStore('store'); request.onerror = () => reject(request.error); request.onsuccess = () => { const db = request.result; const tx = db.transaction('store', 'readwrite'); const store = tx.objectStore('store'); const req = store.put(val, key); req.onsuccess = () => resolve(); req.onerror = () => reject(req.error); }; }); }
        };

        async function init() {
            try {
                await loadData();
                applyTheme();
                updateHeaderUI();
                updateNavVisibility();
                setupGlobalListeners();
                state.view = null; 
                renderView('dashboard');
            } catch (e) { console.error("Error iniciando app:", e); }
        }

        async function loadData() {
            try {
                let saved = await idbKeyval.get(APP_KEY);
                if (saved) {
                    if (!saved.todos) saved.todos = [];
                    if (!saved.notes) saved.notes = [];
                    if (!saved.links) saved.links = [];
                    if (!saved.pdfs) saved.pdfs = []; 
                    if (!saved.folders) saved.folders = [{id: 'general', name: 'General'}];
                    if (!saved.patients) saved.patients = []; 
                    else saved.patients.forEach(p => { if (!p.status) p.status = 'activa'; });
                    if (!saved.transactions) saved.transactions = [];
                    
                    if (!saved.appTitle) saved.appTitle = 'Mecamonico';
                    if (!saved.appSubtitle) saved.appSubtitle = 'Gestión de Taller & Estudio';
                    if (!saved.userName) saved.userName = 'Usuario'; 
                    if (!saved.userTitle) saved.userTitle = 'Estudiante'; 
                    if (saved.darkMode === undefined) saved.darkMode = false;
                    if (!saved.appTheme) saved.appTheme = localStorage.getItem('mech_theme') || 'rojo';
                    if (saved.showFinanceWidget === undefined) saved.showFinanceWidget = true;
                    if (!saved.visibleModules) saved.visibleModules = ['dashboard', 'work_orders', 'shopping_list', 'todo', 'turnario', 'notes', 'links'];
                    
                    if (!saved.shoppingList) saved.shoppingList = [];
                    else saved.shoppingList.forEach(i => { if(!i.id) i.id = Date.now() + Math.random(); });

                    if (!saved.shopAddress) saved.shopAddress = '';
                    if (!saved.shopTitle) saved.shopTitle = 'Lista de Compras';
                    if (!saved.shopNote) saved.shopNote = '';
                    
                    if (!saved.serviceList) saved.serviceList = []; 
                    else saved.serviceList.forEach(i => { if(!i.id) i.id = Date.now() + Math.random(); });

                    if (!saved.inventoryList) saved.inventoryList = []; 
                    else saved.inventoryList.forEach(i => { if(!i.id) i.id = Date.now() + Math.random(); });

                    if (!saved.activeShopTab) saved.activeShopTab = 'items'; 

                    saved.notes = saved.notes.map(n => {
                        if (n.image && !n.images) n.images = [n.image];
                        else if (!n.images) n.images = [];
                        return n;
                    });
                    
                    state = { ...state, ...saved, currentDate: new Date() }; 
                } else {
                    state.folders = [{id: 'general', name: 'General'}];
                    state.todos = [{ id: 1, text: "Revisar niveles de aceite", done: false }];
                }
                if (!state.folders || state.folders.length === 0) state.folders = [{id: 'general', name: 'General'}];
            } catch (e) { 
                console.error("Error cargando datos:", e);
                state.folders = [{id: 'general', name: 'General'}];
            }
        }

        async function saveData() {
            const toSave = { ...state }; delete toSave.currentDate; delete toSave.editingNoteId; 
            try { await idbKeyval.set(APP_KEY, toSave); } catch (e) { showToast("Error al guardar", "fa-triangle-exclamation"); }
        }

        function toggleDarkMode() {
            state.darkMode = !state.darkMode;
            applyTheme();
            saveData();
        }

        function applyTheme() {
            if (state.darkMode) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        }

        let pdfDoc = null; let pageNum = 1; let pageRendering = false; let pageNumPending = null; let renderTask = null; let currentZoom = 1.0; let baseCanvasWidth = null;

        function renderPage(num) {
            pageRendering = true;
            if(renderTask) renderTask.cancel();
            const loader = document.getElementById('pdf-loader');
            pdfDoc.getPage(num).then(function(page) {
                const container = document.getElementById('pdf-scroll-container');
                const oldCanvas = document.getElementById('the-canvas');
                const visualWidth = Math.min(container.clientWidth - 20, 1000); 
                const dpr = window.devicePixelRatio || 1;
                const sharpFactor = (dpr < 2) ? 3 : 2; 
                const originalViewport = page.getViewport({scale: 1.0});
                const fitScale = visualWidth / originalViewport.width;
                const renderScale = fitScale * dpr * sharpFactor;
                const viewport = page.getViewport({scale: renderScale});
                const newCanvas = document.createElement('canvas');
                newCanvas.id = 'the-canvas'; 
                newCanvas.className = 'shadow-2xl transition-transform duration-100 ease-out origin-top-left ring-1 ring-black/20';
                newCanvas.width = viewport.width; newCanvas.height = viewport.height;
                newCanvas.style.width = "100%"; newCanvas.style.maxWidth = `${visualWidth}px`; newCanvas.style.height = "auto";
                baseCanvasWidth = visualWidth; 
                const ctx = newCanvas.getContext('2d');
                const renderContext = { canvasContext: ctx, viewport: viewport };
                renderTask = page.render(renderContext);
                renderTask.promise.then(function() {
                    if (oldCanvas && oldCanvas.parentNode) oldCanvas.replaceWith(newCanvas);
                    else container.insertBefore(newCanvas, loader); 
                    pageRendering = false; renderTask = null; loader.classList.add('hidden'); currentZoom = 1.0; 
                    document.getElementById('pdf-page-num').value = num;
                    if (pageNumPending !== null) { renderPage(pageNumPending); pageNumPending = null; }
                }).catch(e => { if(e.name !== "RenderingCancelledException") console.error(e); pageRendering = false; });
            });
        }

        function updateCanvasStyle(zoomLevel) {
            const canvas = document.getElementById('the-canvas'); if(!canvas || !baseCanvasWidth) return;
            currentZoom = Math.min(Math.max(zoomLevel, 1.0), 4.0);
            const newCSSWidth = baseCanvasWidth * currentZoom;
            if(currentZoom > 1.0) { canvas.style.maxWidth = 'none'; canvas.style.width = `${newCSSWidth}px`; } else { canvas.style.width = "100%"; canvas.style.maxWidth = `${baseCanvasWidth}px`; }
        }
        
        function setupGlobalListeners() {
            document.addEventListener('keydown', (e) => {
                if(!document.getElementById('pdf-reader-modal').classList.contains('hidden')) {
                    if(e.key === 'ArrowLeft') changePdfPage(-1);
                    if(e.key === 'ArrowRight') changePdfPage(1);
                    if(e.key === 'Escape') closePdfReader();
                }
            });
            const container = document.getElementById('pdf-scroll-container');
            if (container) {
                let touchStartX = 0;
                container.addEventListener('touchstart', e => { if(e.touches.length === 1) touchStartX = e.changedTouches[0].screenX; }, {passive: true});
                container.addEventListener('touchend', e => { if (e.changedTouches.length > 0 && currentZoom <= 1.05) { const touchEndX = e.changedTouches[0].screenX; if (touchEndX < touchStartX - 80) changePdfPage(1); if (touchEndX > touchStartX + 80) changePdfPage(-1); } }, {passive: true});
            }

            // --- SISTEMA DE DRAG SCROLL PARA PC ---
            let isDown = false;
            let startX;
            let scrollLeft;
            let draggedElement = null;
            let didDrag = false;

            document.addEventListener('mousedown', (e) => {
                const slider = e.target.closest('.mouse-drag');
                if (!slider) return;
                // Evitamos bloquear el click en inputs/selects dentro de las tablas
                if (['INPUT', 'TEXTAREA', 'SELECT', 'OPTION'].includes(e.target.tagName)) return;
                
                isDown = true;
                didDrag = false;
                draggedElement = slider;
                slider.classList.add('dragging');
                startX = e.pageX - slider.offsetLeft;
                scrollLeft = slider.scrollLeft;
            });

            document.addEventListener('mouseleave', () => {
                if (!isDown) return;
                isDown = false;
                if (draggedElement) draggedElement.classList.remove('dragging');
                draggedElement = null;
            });

            document.addEventListener('mouseup', () => {
                if (!isDown) return;
                isDown = false;
                if (draggedElement) draggedElement.classList.remove('dragging');
                draggedElement = null;
                setTimeout(() => { didDrag = false; }, 0); 
            });

            document.addEventListener('mousemove', (e) => {
                if (!isDown || !draggedElement) return;
                const x = e.pageX - draggedElement.offsetLeft;
                const walk = (x - startX) * 1.5; 
                if (Math.abs(walk) > 5) {
                    didDrag = true;
                    e.preventDefault(); 
                }
                draggedElement.scrollLeft = scrollLeft - walk;
            });

            // Evitar que el clic se dispare si estuviste arrastrando
            document.addEventListener('click', (e) => {
                if (didDrag) {
                    e.preventDefault();
                    e.stopPropagation();
                }
            }, true);
        }

        function manualZoom(delta) { updateCanvasStyle(currentZoom + delta); }
        function queueRenderPage(num) { if (pageRendering) pageNumPending = num; else renderPage(num); }
        function onPrevPage() { if (pageNum <= 1) return; pageNum--; queueRenderPage(pageNum); }
        function onNextPage() { if (pageNum >= pdfDoc.numPages) return; pageNum++; queueRenderPage(pageNum); }
        function changePdfPage(delta) { if (delta === -1) onPrevPage(); if (delta === 1) onNextPage(); }
        function jumpToPdfPage(numVal) { const num = parseInt(numVal); if (num >= 1 && num <= pdfDoc.numPages) { pageNum = num; queueRenderPage(pageNum); } else { document.getElementById('pdf-page-num').value = pageNum; } }

        async function openPdfReader(id) {
            const pdf = state.pdfs.find(p => p.id === id); if(!pdf) return;
            const modal = document.getElementById('pdf-reader-modal'); const title = document.getElementById('pdf-reader-title'); const loader = document.getElementById('pdf-loader');
            const oldCanvas = document.getElementById('the-canvas');
            if(oldCanvas) { const ctx = oldCanvas.getContext('2d'); ctx.clearRect(0, 0, oldCanvas.width, oldCanvas.height); oldCanvas.style.width = '100%'; }
            title.innerHTML = `<i class="fa-solid fa-file-pdf mr-2 text-white"></i> <span class="truncate">${pdf.title}</span>`;
            loader.classList.remove('hidden'); modal.classList.remove('hidden'); modal.focus(); currentZoom = 1.0; 
            try { const loadingTask = pdfjsLib.getDocument(pdf.data); pdfDoc = await loadingTask.promise; document.getElementById('pdf-page-count').textContent = pdfDoc.numPages; pageNum = 1; renderPage(pageNum); } catch (error) { console.error(error); showToast("Error al abrir PDF", "fa-bug"); closePdfReader(); }
        }
        function closePdfReader() { document.getElementById('pdf-reader-modal').classList.add('hidden'); if(renderTask) { renderTask.cancel(); renderTask = null; } pdfDoc = null; pageNum = 1; pageRendering = false; pageNumPending = null; }

        function showToast(msg, icon = 'fa-info-circle') { const toast = document.getElementById('toast'); document.getElementById('toast-msg').innerText = msg; toast.querySelector('div').innerHTML = `<i class="fa-solid ${icon}"></i>`; toast.classList.remove('opacity-0', 'translate-y-4'); toast.classList.add('translate-y-0'); setTimeout(() => { toast.classList.add('opacity-0', 'translate-y-4'); toast.classList.remove('translate-y-0'); }, 3000); }
        async function updateProfileImage(input) { if (input.files && input.files[0]) { try { const base64 = await processImage(input.files[0]); state.userProfileImage = base64; state.userProfileImage = base64; saveData(); renderView('dashboard'); showToast("Foto actualizada", "fa-camera"); } catch (e) { showToast("Error al procesar imagen", "fa-triangle-exclamation"); } } }
        
        function openNameModal() { document.getElementById('new-user-name').value = state.userName || ''; document.body.classList.add('modal-open'); document.getElementById('name-modal').classList.remove('hidden'); document.getElementById('new-user-name').focus(); }
        function closeNameModal() { document.body.classList.remove('modal-open'); document.getElementById('name-modal').classList.add('hidden'); }
        function saveName() { const name = document.getElementById('new-user-name').value.trim(); if (name) { state.userName = name; saveData(); renderView('dashboard'); closeNameModal(); showToast("Nombre actualizado", "fa-id-card"); } }
        
        function openTitleModal() { document.getElementById('new-user-title').value = state.userTitle || ''; document.body.classList.add('modal-open'); document.getElementById('title-modal').classList.remove('hidden'); document.getElementById('new-user-title').focus(); }
        function closeTitleModal() { document.body.classList.remove('modal-open'); document.getElementById('title-modal').classList.add('hidden'); }
        function saveTitle() { const title = document.getElementById('new-user-title').value.trim(); if (title) { state.userTitle = title; saveData(); renderView('dashboard'); closeTitleModal(); showToast("Título actualizado", "fa-tag"); } }

        function updateHeaderUI() { document.getElementById('header-app-title').innerText = state.appTitle || 'Mecamonico'; document.getElementById('header-app-subtitle').innerText = state.appSubtitle || 'Gestión de Taller & Estudio'; }
        function openAppTitleModal() { document.getElementById('new-app-title').value = state.appTitle || ''; document.getElementById('new-app-subtitle').value = state.appSubtitle || ''; document.body.classList.add('modal-open'); document.getElementById('app-title-modal').classList.remove('hidden'); document.getElementById('new-app-title').focus(); }
        function closeAppTitleModal() { document.body.classList.remove('modal-open'); document.getElementById('app-title-modal').classList.add('hidden'); }
        function saveAppTitle() { const t = document.getElementById('new-app-title').value.trim(); const s = document.getElementById('new-app-subtitle').value.trim(); if(t) state.appTitle = t; state.appSubtitle = s; saveData(); updateHeaderUI(); closeAppTitleModal(); showToast("Encabezado actualizado", "fa-check"); }

        function openBackupModal() { document.getElementById('backup-modal').classList.remove('hidden'); }
        function closeBackupModal() { document.getElementById('backup-modal').classList.add('hidden'); document.getElementById('backup-file-input').value = ''; }
        async function downloadBackupFile() { try { showToast("Comprimiendo...", "fa-spinner fa-spin"); const zip = new JSZip(); const dataStr = JSON.stringify(state, null, 2); zip.file("mecamonico_data.json", dataStr); const content = await zip.generateAsync({ type: "blob", compression: "DEFLATE", compressionOptions: { level: 9 } }); const downloadAnchorNode = document.createElement('a'); const fileName = "mecanica_backup_" + new Date().toISOString().slice(0,10) + ".zip"; downloadAnchorNode.href = URL.createObjectURL(content); downloadAnchorNode.setAttribute("download", fileName); document.body.appendChild(downloadAnchorNode); downloadAnchorNode.click(); document.body.removeChild(downloadAnchorNode); URL.revokeObjectURL(downloadAnchorNode.href); showToast("Backup Descargado", "fa-file-zipper"); } catch (err) { showToast("Error al comprimir", "fa-triangle-exclamation"); } }
        async function importBackupFromFile(input) { const file = input.files[0]; if (!file) return; try { showToast("Analizando ZIP...", "fa-spinner fa-spin"); const zip = await JSZip.loadAsync(file); const dataFile = zip.file("mecamonico_data.json"); if (!dataFile) throw new Error("ZIP inválido."); const content = await dataFile.async("string"); const data = JSON.parse(content); if (data && (data.todos || data.notes || data.shifts)) { showConfirmModal("Restaurar desde ZIP", "Se reemplazará toda la información actual.", "Restaurar", function() { state = { ...state, ...data, currentDate: new Date() }; saveData(); closeConfirmModal(); closeBackupModal(); state.view = null; renderView('dashboard'); showToast("Datos restaurados", "fa-check-double"); }); } else { showToast("Datos corruptos", "fa-triangle-exclamation"); } } catch (err) { showToast("Error: Archivo inválido", "fa-bug"); } input.value = ''; }
        function exportDataToClipboard() { const textArea = document.createElement("textarea"); textArea.value = JSON.stringify(state); textArea.style.position = "fixed"; textArea.style.left = "-9999px"; document.body.appendChild(textArea); textArea.select(); try { if(document.execCommand('copy')) showToast("JSON copiado", "fa-clipboard-check"); else showToast("Error al copiar", "fa-times"); } catch (err) { showToast("Error al copiar", "fa-times"); } document.body.removeChild(textArea); }
        
        function triggerPdfInput() { document.getElementById('pdf-input-file').click(); }
        async function handlePdfUpload(input) { const file = input.files[0]; if(!file) return; if(file.size > 25 * 1024 * 1024) { showToast("Máx 25MB", "fa-triangle-exclamation"); input.value = ''; return; } try { showToast("Procesando...", "fa-spinner fa-spin"); const base64 = await processFileBase64(file); const newPdf = { id: Date.now(), title: file.name.replace('.pdf', ''), data: base64 }; if(!state.pdfs) state.pdfs = []; state.pdfs.push(newPdf); await saveData(); 
            const list = document.getElementById('pdfs-list');
            if (list) {
                const emptyMsg = list.querySelector('.text-center.opacity-40');
                if(emptyMsg) emptyMsg.remove();
                list.insertAdjacentHTML('afterbegin', createPdfHTML(newPdf));
            } else {
                renderView('links'); 
            }
            showToast("Manual Agregado", "fa-file-pdf"); } catch(e) { console.error(e); showToast("Error al leer", "fa-times"); } input.value = ''; }
        function processFileBase64(file) { return new Promise((resolve, reject) => { const reader = new FileReader(); reader.readAsDataURL(file); reader.onload = () => resolve(reader.result); reader.onerror = error => reject(error); }); }
        
        function renamePdf(id) {
            const pdf = state.pdfs.find(p => p.id === id);
            if (!pdf) return;
            const newName = prompt("Nuevo nombre para el archivo:", pdf.title);
            if (newName && newName.trim() !== "") {
                pdf.title = newName.trim();
                saveData();
                renderView('links');
                showToast("Nombre actualizado", "fa-pen-to-square");
            }
        }

        function deletePdf(id) { showConfirmModal("¿Eliminar Manual?", "Acción irreversible.", "Eliminar", () => { state.pdfs = state.pdfs.filter(p => p.id !== id); saveData(); closeConfirmModal(); renderView('links'); showToast("Manual eliminado", "fa-trash"); }); }

        function setInfoTab(tab) {
            state.activeInfoTab = tab;
            const webBtn = document.getElementById('tab-btn-web'); const pdfBtn = document.getElementById('tab-btn-pdf'); const webContent = document.getElementById('tab-content-web'); const pdfContent = document.getElementById('tab-content-pdf');
            if (webBtn && pdfBtn && webContent && pdfContent) {
                webContent.classList.add('hidden'); webContent.classList.remove('fade-enter'); pdfContent.classList.add('hidden'); pdfContent.classList.remove('fade-enter');
                const inactiveClass = 'flex-1 py-2 text-sm font-bold rounded transition text-neutral-500 hover:text-neutral-700 bg-neutral-100 dark:bg-neutral-800 dark:text-neutral-400 dark:hover:text-neutral-200'; 
                const activeClass = 'flex-1 py-2 text-sm font-bold rounded transition bg-red-600 text-white shadow-md';
                webBtn.className = inactiveClass; pdfBtn.className = inactiveClass;
                if (tab === 'web') { webContent.classList.remove('hidden'); void webContent.offsetWidth; webContent.classList.add('fade-enter'); webBtn.className = activeClass; } else { pdfContent.classList.remove('hidden'); void pdfContent.offsetWidth; pdfContent.classList.add('fade-enter'); pdfBtn.className = activeClass; }
                const searchEl = document.getElementById('info-search');
                if (searchEl) { searchEl.value = ''; filterInfo(''); }
            } else { renderView('links'); }
        }
        
        function getLinksHTML() {
            const isWeb = state.activeInfoTab === 'web';
            const linksHTML = (state.links || []).map(l => createLinkHTML(l)).join('');
            const webContent = `<div class="flex flex-col lg:flex-row gap-6"><div class="lg:w-1/3 shrink-0"><div class="bg-white dark:bg-neutral-900 p-5 rounded shadow-sm border border-neutral-300 dark:border-neutral-700 sticky top-0"><h3 class="text-xs font-bold text-neutral-400 dark:text-neutral-500 mb-3">Nuevo Recurso</h3><div class="flex flex-col gap-3"><input type="text" id="link-title" placeholder="Nombre (ej: Foro, Manual)" class="p-3 bg-neutral-50 dark:bg-neutral-800 rounded border border-neutral-300 dark:border-neutral-700 focus:ring-2 focus:ring-red-500 outline-none transition w-full font-bold dark:text-white"><div class="flex flex-col gap-2"><input type="url" id="link-url" placeholder="https://..." class="p-3 bg-neutral-50 dark:bg-neutral-800 rounded border border-neutral-300 dark:border-neutral-700 focus:ring-2 focus:ring-red-500 outline-none transition w-full dark:text-white"><button onclick="addLink()" class="bg-neutral-800 dark:bg-neutral-700 text-white px-4 py-3 rounded font-bold hover:bg-neutral-700 dark:hover:bg-neutral-600 transition shadow-lg text-sm w-full mt-1"><i class="fa-solid fa-plus mr-2"></i> Guardar</button></div></div></div></div><div class="lg:w-2/3"><h3 class="hidden lg:block text-xs font-bold text-neutral-400 dark:text-neutral-500 mb-3">Biblioteca Web</h3><div id="links-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-1 xl:grid-cols-2 gap-3 pb-32">${linksHTML || '<div class="text-center opacity-40 py-10 col-span-full font-mono text-xs dark:text-white">Sin enlaces guardados</div>'}</div></div></div>`;
            const pdfsHTML = (state.pdfs || []).map(p => createPdfHTML(p)).join('');
            const pdfContent = `<div class="flex flex-col lg:flex-row gap-6"><div class="lg:w-1/3 shrink-0"><div class="bg-white dark:bg-neutral-900 p-5 rounded shadow-sm border border-neutral-300 dark:border-neutral-700 sticky top-0 text-center"><h3 class="text-xs font-bold text-neutral-400 dark:text-neutral-500 mb-3 text-left">Subir Manual Técnico</h3><div class="border-2 border-dashed border-neutral-300 dark:border-neutral-700 rounded p-8 hover:bg-neutral-50 dark:hover:bg-neutral-800 transition cursor-pointer group flex flex-col items-center justify-center gap-2 h-64" onclick="triggerPdfInput()"><div class="w-16 h-16 rounded bg-neutral-100 dark:bg-neutral-800 group-hover:bg-red-50 dark:group-hover:bg-red-900/30 flex items-center justify-center transition mb-2"><i class="fa-solid fa-file-arrow-up text-3xl text-neutral-400 dark:text-neutral-500 group-hover:text-red-500 transition"></i></div><p class="text-lg font-bold text-neutral-500 dark:text-neutral-300 group-hover:text-red-600 transition">Toca para subir</p><p class="text-xs text-neutral-400 dark:text-neutral-500 font-mono">PDF (Máx 25MB)</p><input type="file" id="pdf-input-file" accept="application/pdf" class="hidden" onchange="handlePdfUpload(this)"></div></div></div><div class="lg:w-2/3"><h3 class="hidden lg:block text-xs font-bold text-neutral-400 dark:text-neutral-500 mb-3">Manuales Guardados</h3><div id="pdfs-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-1 xl:grid-cols-2 gap-3 pb-32">${pdfsHTML || '<div class="text-center opacity-40 py-10 col-span-full font-mono text-xs dark:text-white">Sin documentos guardados</div>'}</div></div></div>`;
            
            const activeClass = "bg-red-600 text-white shadow-md";
            const inactiveClass = "bg-neutral-100 dark:bg-neutral-800 text-neutral-500 dark:text-neutral-400 hover:text-neutral-700 dark:hover:text-neutral-200";

            return `<div><h2 class="text-3xl font-bold text-neutral-800 dark:text-neutral-100 mb-4 flex items-center gap-2 tracking-tighter"><i class="fa-solid fa-toolbox text-red-600"></i> Información Técnica</h2><div class="flex p-1 bg-neutral-200 dark:bg-neutral-700 rounded mb-4 shadow-inner">
                <button id="tab-btn-web" onclick="setInfoTab('web')" class="flex-1 py-2 text-sm font-bold rounded transition ${isWeb ? activeClass : inactiveClass}">Enlaces Web</button>
                <button id="tab-btn-pdf" onclick="setInfoTab('pdf')" class="flex-1 py-2 text-sm font-bold rounded transition ${!isWeb ? activeClass : inactiveClass}">Manuales PDF</button>
            </div><div class="mb-4 relative"><i class="fa-solid fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-neutral-400"></i><input type="text" id="info-search" placeholder="Buscar manual o recurso..." class="w-full pl-10 pr-4 py-3 rounded bg-white dark:bg-neutral-900 border border-neutral-300 dark:border-neutral-700 focus:ring-2 focus:ring-red-500 outline-none text-neutral-700 dark:text-neutral-200 font-bold transition shadow-sm" onkeyup="filterInfo(this.value)"></div><div id="tab-content-web" class="${isWeb ? 'fade-enter' : 'hidden'}">${webContent}</div><div id="tab-content-pdf" class="${!isWeb ? 'fade-enter' : 'hidden'}">${pdfContent}</div></div>`;
        }
        function createPdfHTML(pdf) { 
            return `<div class="flex items-center bg-white dark:bg-neutral-900 p-4 rounded shadow-sm border border-neutral-300 dark:border-neutral-700 hover:shadow-md transition hover:border-red-400 dark:hover:border-red-500 group cursor-pointer h-full" onclick="openPdfReader(${pdf.id})"><div class="w-12 h-12 rounded bg-neutral-100 dark:bg-neutral-800 text-red-500 flex items-center justify-center mr-4 text-2xl group-hover:scale-110 transition border border-neutral-200 dark:border-neutral-700"><i class="fa-solid fa-file-pdf"></i></div><div class="flex-1 min-w-0"><h4 class="text-neutral-800 dark:text-neutral-200 font-bold truncate text-base tracking-tight">${pdf.title}</h4><p class="text-xs text-neutral-400 dark:text-neutral-500 font-mono">TOCA PARA LEER</p></div>
            <button onclick="event.stopPropagation(); renamePdf(${pdf.id})" class="w-10 h-10 flex items-center justify-center rounded text-neutral-400 dark:text-neutral-500 hover:text-blue-500 hover:bg-blue-50 dark:hover:bg-blue-900/20 transition mr-1"><i class="fa-solid fa-pen-to-square"></i></button>
            <button onclick="event.stopPropagation(); sharePdfFile(${pdf.id})" class="w-10 h-10 flex items-center justify-center rounded text-neutral-400 dark:text-neutral-500 hover:text-green-500 hover:bg-green-50 dark:hover:bg-green-900/20 transition mr-1"><i class="fa-solid fa-share-nodes"></i></button>
            <button onclick="event.stopPropagation(); deletePdf(${pdf.id})" class="w-10 h-10 flex items-center justify-center rounded text-neutral-300 dark:text-neutral-600 hover:bg-red-50 dark:hover:bg-red-900/30 hover:text-red-500 transition"><i class="fa-solid fa-trash-can text-lg"></i></button></div>`; 
        }
        
        function createLinkHTML(link) { const favicon = `https://www.google.com/s2/favicons?domain=${link.url}&sz=64`; return `<div id="link-${link.id}" class="flex items-center bg-white dark:bg-neutral-900 p-4 rounded shadow-sm border border-neutral-300 dark:border-neutral-700 hover:shadow-md transition hover:border-red-400 dark:hover:border-red-500 group h-full"><img src="${favicon}" class="w-10 h-10 rounded bg-neutral-50 dark:bg-neutral-800 p-1.5 mr-4 object-contain grayscale group-hover:grayscale-0 transition" onerror="this.src='https://via.placeholder.co/32'"><a href="${link.url}" target="_blank" class="flex-1 text-neutral-700 dark:text-neutral-200 font-bold hover:text-red-600 dark:hover:text-red-400 transition truncate pr-4"><span class="text-base tracking-tight">${link.title}</span><div class="text-xs text-neutral-400 dark:text-neutral-500 font-mono truncate mt-0.5">${link.url}</div></a>
        <button onclick="shareLink(${link.id})" class="w-10 h-10 flex items-center justify-center rounded text-neutral-400 dark:text-neutral-500 hover:text-green-500 hover:bg-green-50 dark:hover:bg-green-900/20 transition mr-1"><i class="fa-solid fa-share-nodes"></i></button>
        <button onclick="confirmDelete('link', ${link.id})" class="w-10 h-10 flex items-center justify-center rounded text-neutral-300 dark:text-neutral-600 hover:bg-red-50 dark:hover:bg-red-900/30 hover:text-red-500 transition"><i class="fa-solid fa-trash-can text-lg"></i></button></div>`; }
        
        function addLink() { const t = document.getElementById('link-title').value.trim(); let u = document.getElementById('link-url').value.trim(); if (!t || !u) return; if (!u.startsWith('http')) u = 'https://' + u; const newLink = { id: Date.now(), title: t, url: u }; state.links.push(newLink); saveData(); 
            const list = document.getElementById('links-list');
            if(list) {
                const emptyMsg = list.querySelector('.text-center.opacity-40');
                if(emptyMsg) emptyMsg.remove();
                list.insertAdjacentHTML('beforeend', createLinkHTML(newLink));
            } else {
                renderView('links'); 
            }
            showToast("Recurso añadido", "fa-bookmark"); 
            document.getElementById('link-title').value = '';
            document.getElementById('link-url').value = '';
        }
        function deleteLink(id) { state.links = state.links.filter(l => l.id !== id); saveData(); renderView('links'); }
        
        async function shareLink(id) {
            const link = state.links.find(l => l.id === id);
            if (!link) return;
            
            if (navigator.share) {
                try {
                    await navigator.share({
                        title: link.title,
                        text: `Mira este enlace: ${link.title}`,
                        url: link.url
                    });
                    showToast("Enlace compartido", "fa-check");
                } catch (err) {
                    fallbackCopy(link.url);
                }
            } else {
                fallbackCopy(link.url);
            }
        }

        async function sharePdfFile(id) {
            const pdf = state.pdfs.find(p => p.id === id);
            if (!pdf) return;

            try {
                showToast("Preparando archivo...", "fa-spinner fa-spin");
                const res = await fetch(pdf.data);
                const blob = await res.blob();
                const file = new File([blob], `${pdf.title}.pdf`, { type: "application/pdf" });

                if (navigator.canShare && navigator.canShare({ files: [file] })) {
                    await navigator.share({
                        files: [file],
                        title: pdf.title,
                        text: "Te comparto este manual técnico."
                    });
                    showToast("Archivo compartido", "fa-file-pdf");
                } else {
                    const a = document.createElement('a');
                    a.href = pdf.data;
                    a.download = `${pdf.title}.pdf`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    showToast("Descargando archivo...", "fa-download");
                }
            } catch (e) {
                console.error(e);
                showToast("Error al compartir", "fa-triangle-exclamation");
            }
        }

        function openFolderModal() { document.body.classList.add('modal-open'); document.getElementById('folder-modal').classList.remove('hidden'); document.getElementById('new-folder-name').focus(); }
        function closeFolderModal() { document.body.classList.remove('modal-open'); document.getElementById('folder-modal').classList.add('hidden'); document.getElementById('new-folder-name').value = ''; }
        function createFolder() { const name = document.getElementById('new-folder-name').value.trim(); if (!name) return; const id = 'f_' + Date.now(); state.folders.push({ id, name }); state.currentFolderId = id; saveData(); closeFolderModal(); changeFolder(id); showToast(`Sección "${name}" creada`, "fa-folder-plus"); }
        
        function deleteFolder(folderId) {
            if (folderId === 'general' || folderId === 'all') return;
            showConfirmModal("¿Borrar Carpeta?", "Las notas se moverán a 'General'.", "Borrar", function() {
                state.notes.forEach(n => {
                    if (n.folderId === folderId) n.folderId = 'general';
                });
                state.folders = state.folders.filter(f => f.id !== folderId);
                state.currentFolderId = 'all';
                saveData();
                closeConfirmModal();
                renderView('notes');
                showToast("Carpeta eliminada", "fa-trash");
            });
        }

        function processImage(file) { return new Promise((resolve, reject) => { const reader = new FileReader(); reader.readAsDataURL(file); reader.onload = (event) => { const img = new Image(); img.src = event.target.result; img.onload = () => { const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d'); const MAX_WIDTH = 800; let width = img.width; let height = img.height; if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; } canvas.width = width; canvas.height = height; ctx.drawImage(img, 0, 0, width, height); resolve(canvas.toDataURL('image/jpeg', 0.6)); }; img.onerror = reject; }; reader.onerror = reject; }); }
        
        async function handleImageSelection(input) {
             if (input.files) {
                 showToast("Procesando imágenes...", "fa-spinner fa-spin");
                 for (let i = 0; i < input.files.length; i++) {
                     try {
                         const base64 = await processImage(input.files[i]);
                         currentNoteImages.push(base64);
                     } catch(e) { console.error(e); }
                 }
                 updateImagePreview();
                 showToast("Imágenes listas", "fa-camera");
             }
             input.value = ''; 
        }

        function updateImagePreview() {
            const container = document.getElementById('image-preview-container');
            container.innerHTML = ''; 
            
            if (currentNoteImages.length > 0) {
                container.classList.remove('hidden');
                container.className = "flex gap-2 overflow-x-auto pb-2 mb-3 hide-scrollbar mouse-drag"; 
                
                currentNoteImages.forEach((imgSrc, index) => {
                    const wrap = document.createElement('div');
                    wrap.className = "relative flex-shrink-0 group w-24 h-24";
                    wrap.innerHTML = `
                        <img src="${imgSrc}" class="w-full h-full rounded border border-neutral-300 dark:border-neutral-700 object-cover shadow-sm">
                        <button onclick="removeImageFromPreview(${index})" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center transform scale-90 shadow hover:bg-red-600 transition"><i class="fa-solid fa-xmark text-xs"></i></button>
                    `;
                    container.appendChild(wrap);
                });
            } else {
                container.classList.add('hidden');
            }
        }

        function removeImageFromPreview(index) {
            currentNoteImages.splice(index, 1);
            updateImagePreview();
        }

        function clearImageInput() { 
            currentNoteImages = [];
            updateImagePreview();
        }
        
        function showConfirmModal(title, message, actionBtnText, onConfirm) { const modal = document.getElementById('confirm-modal'); modal.querySelector('h3').innerText = title; document.getElementById('confirm-message').innerText = message; const btn = document.getElementById('confirm-btn-action'); btn.innerText = actionBtnText; btn.onclick = onConfirm; document.body.classList.add('modal-open'); modal.classList.remove('hidden'); }
        function closeConfirmModal() { document.body.classList.remove('modal-open'); document.getElementById('confirm-modal').classList.add('hidden'); }
        function confirmDelete(type, id) { 
            let msg = "Esta acción es definitiva."; 
            if(type === 'todo') msg = "¿Finalizar o borrar tarea?"; 
            if(type === 'note') msg = "¿Eliminar esta anotación?"; 
            if(type === 'link') msg = "¿Eliminar este recurso?"; 
            
            showConfirmModal("¿Estás seguro?", msg, "Eliminar", function() { 
                if (type === 'todo') deleteTodo(id); 
                else if (type === 'note') deleteNote(id); 
                else if (type === 'link') deleteLink(id); 
                closeConfirmModal(); 
            }); 
        }

        function getDashboardHTML() {
            const today = new Date(); const year = today.getFullYear(); const month = String(today.getMonth() + 1).padStart(2, '0'); const day = String(today.getDate()).padStart(2, '0'); const dateKey = `${year}-${month}-${day}`; let shift = state.shifts[dateKey]; let isNextShift = false; let nextDateStr = "";
            if (!shift) { const futureDates = Object.keys(state.shifts).filter(date => date > dateKey).sort(); if (futureDates.length > 0) { const nextDateKey = futureDates[0]; shift = state.shifts[nextDateKey]; isNextShift = true; const [ny, nm, nd] = nextDateKey.split('-').map(Number); const dateObj = new Date(ny, nm - 1, nd); nextDateStr = dateObj.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' }); nextDateStr = nextDateStr.charAt(0).toUpperCase() + nextDateStr.slice(1); } }
            let nextEvent = null; const sortedDates = Object.keys(state.shifts).sort(); for (const d of sortedDates) { if (d >= dateKey && state.shifts[d].eventTime && state.shifts[d].note) { nextEvent = { date: d, ...state.shifts[d] }; break; } }
            
            let reminderHTML = ''; 
            if (nextEvent) { 
                const [y, m, d] = nextEvent.date.split('-').map(Number); const isTodayEvent = nextEvent.date === dateKey; const eventDateStr = new Date(y, m - 1, d).toLocaleDateString('es-ES', { weekday: 'short', day: 'numeric' }); 
                reminderHTML = `<div class="order-3 bg-gradient-to-r from-neutral-800 to-neutral-700 text-white p-4 rounded shadow-lg flex items-center gap-4 relative overflow-hidden shrink-0 border-l-4 border-yellow-500"><div class="bg-white/10 p-3 rounded backdrop-blur-sm"><i class="fa-solid fa-bell text-2xl text-yellow-400"></i></div><div class="flex-1 z-10"><p class="text-[10px] tracking-widest opacity-80 font-bold text-yellow-400">Recordatorio Taller</p><h4 class="font-bold text-xl leading-tight font-handwriting">${nextEvent.note}</h4><p class="text-sm mt-1 font-mono opacity-90"><i class="fa-regular fa-calendar mr-1"></i> ${isTodayEvent ? 'HOY' : eventDateStr} • ${nextEvent.eventTime}</p></div></div>`; 
            }
            
            const pendingTodos = (state.todos || []).filter(t => !t.done);
            const activeCars = (state.patients || []).filter(p => p.status !== 'archivada').length;
            
            let shiftCardClass = "bg-white dark:bg-neutral-900 border-neutral-300 dark:border-neutral-700 text-neutral-500 dark:text-neutral-400"; let shiftText = "Sin asignación"; let shiftSubText = "Calendario libre"; let shiftIcon = "fa-calendar-minus"; let cardLabel = "Jornada de Hoy";
            
            if (shift) { 
                if (shift.type === 'guardia') { 
                    shiftCardClass = "bg-white dark:bg-neutral-900 border-red-500 text-red-600 border-l-4"; 
                    shiftText = "TALLER PRÁCTICO"; shiftSubText = "Manos a la obra"; shiftIcon = "fa-wrench"; 
                } 
                else if (shift.type === 'dia') { 
                    shiftCardClass = "bg-white dark:bg-neutral-900 border-blue-500 text-blue-600 border-l-4"; 
                    shiftText = "ENTREGA INFORME"; shiftSubText = "Plazo Límite"; shiftIcon = "fa-file-export"; 
                } 
                else if (shift.type === 'noche') { 
                    shiftCardClass = "bg-white dark:bg-neutral-900 border-indigo-500 text-indigo-600 border-l-4"; 
                    shiftText = "CERTAMEN"; shiftSubText = "Evaluación"; shiftIcon = "fa-file-signature"; 
                } 
                else if (shift.type === 'post') { 
                    shiftCardClass = "bg-white dark:bg-neutral-900 border-yellow-500 text-yellow-600 border-l-4"; 
                    shiftText = "ESTUDIO / TEORÍA"; shiftSubText = "Repaso de manuales"; shiftIcon = "fa-book-open"; 
                } 
                else if (shift.type === 'libre') { 
                    shiftCardClass = "bg-white dark:bg-neutral-900 border-green-500 text-green-600 border-l-4"; 
                    shiftText = "VEHÍCULO AGENDADO"; shiftSubText = "Recepción Taller"; shiftIcon = "fa-calendar-check"; 
                } 
                if (isNextShift) { cardLabel = "Próxima Jornada"; shiftSubText = `El ${nextDateStr}`; } else { cardLabel = "Jornada de Hoy"; } 
            } else { cardLabel = "Estado Actual"; }

            // Lógica Cálculo Balance Diario
            const dailyTxs = (state.transactions || []).filter(t => t.date === dateKey);
            const dailyIncome = dailyTxs.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const dailyExpense = dailyTxs.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            const dailyProfit = dailyIncome - dailyExpense;
            const signStr = dailyProfit < 0 ? '-' : (dailyProfit > 0 ? '+' : '');
            const profitColor = dailyProfit >= 0 ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400';
            const profitBg = dailyProfit >= 0 ? 'bg-green-50 dark:bg-green-900/10 border-green-200 dark:border-green-800/50 hover:bg-green-100 dark:hover:bg-green-900/30' : 'bg-red-50 dark:bg-red-900/10 border-red-200 dark:border-red-800/50 hover:bg-red-100 dark:hover:bg-red-900/30';
            
            const displayClass = state.showFinanceWidget ? 'flex' : 'hidden';

            const financeWidgetHTML = `
                <div id="finance-widget-container" class="${displayClass} items-center justify-between p-2.5 rounded-lg border transition-all duration-300 shadow-sm group ${profitBg} relative mt-3">
                    <div class="flex items-center gap-2.5 cursor-pointer w-full" onclick="openFinanceModal()" title="Ver historial y resumen mensual">
                        <div id="finance-widget-icon-bg" class="w-10 h-10 rounded-full bg-white dark:bg-neutral-800 flex items-center justify-center shadow-sm group-hover:scale-105 transition shrink-0 ${profitColor}"><i class="fa-solid fa-wallet text-xl"></i></div>
                        <div class="${profitColor}" id="finance-widget-text-color">
                            <p class="text-[10px] font-bold uppercase tracking-widest opacity-80 leading-none mb-1 text-neutral-500 dark:text-neutral-400">Balance Hoy</p>
                            <p class="text-[11px] font-bold leading-none hover:underline opacity-90"><i class="fa-solid fa-chart-line mr-1"></i>Ver Resumen Mensual</p>
                        </div>
                    </div>
                    <div class="flex flex-col items-end shrink-0 pl-2">
                        <button onclick="hideFinanceWidgetDirectly(event)" class="absolute top-1.5 right-1.5 w-6 h-6 flex items-center justify-center text-neutral-400 hover:text-red-500 transition rounded hover:bg-black/5 dark:hover:bg-white/5" title="Ocultar Balance"><i class="fa-solid fa-eye-slash text-xs"></i></button>
                        <span id="finance-widget-amount" class="text-2xl font-black ${profitColor} tracking-tight mr-1 mt-2.5">${signStr}$${Math.abs(dailyProfit).toLocaleString('es-CL')}</span>
                    </div>
                </div>`;

            const profileImageSrc = state.userProfileImage || 'https://placehold.co/64x64/dc2626/ffffff?text=MEC'; 
            const displayUserName = state.userName || 'Usuario'; 
            const displayUserTitle = state.userTitle || 'Estudiante'; 
            
            return `<div class="flex flex-col gap-6 w-full lg:max-w-2xl mx-auto pb-20 lg:p-6 hide-scrollbar fade-enter">
            
            <div class="order-1 flex flex-col bg-white dark:bg-neutral-900 p-4 rounded shadow-sm border border-neutral-300 dark:border-neutral-700 shrink-0">
                <div class="flex items-center gap-4 ${state.showFinanceWidget ? 'border-b border-neutral-100 dark:border-neutral-800 pb-2' : ''}" id="profile-card-header">
                    <div class="relative w-20 h-20 shrink-0 group cursor-pointer"><div class="absolute inset-0 bg-neutral-200 dark:bg-neutral-800 rounded-full animate-pulse"></div><label for="profile-upload" class="cursor-pointer"><img src="${profileImageSrc}" class="w-20 h-20 rounded-full object-cover border-4 border-neutral-100 dark:border-neutral-800 shadow relative z-10 group-hover:opacity-80 transition" onerror="this.src='https://placehold.co/64x64/dc2626/ffffff?text=MEC'"><div class="absolute inset-0 z-20 flex items-center justify-center bg-black/50 rounded-full opacity-0 group-hover:opacity-100 transition"><i class="fa-solid fa-camera text-white text-sm"></i></div></label><input type="file" id="profile-upload" class="hidden" accept="image/*" onchange="updateProfileImage(this)"><div class="absolute -bottom-1 -right-1 bg-green-500 w-6 h-6 rounded-full border-2 border-white flex items-center justify-center z-20 pointer-events-none text-white"><i class="fa-solid fa-check text-xs"></i></div></div>
                    <div class="flex-1">
                        <p class="text-xs text-neutral-400 dark:text-neutral-500 font-bold tracking-widest cursor-pointer select-none" onclick="openTitleModal()">${displayUserTitle}</p>
                        <h2 class="text-2xl font-bold text-neutral-800 dark:text-neutral-100 leading-tight flex items-center gap-2 cursor-pointer hover:text-red-600 transition" onclick="openNameModal()">Hola, ${displayUserName} <i class="fa-solid fa-pen-to-square text-sm text-neutral-300"></i></h2>
                    </div>
                </div>
                ${financeWidgetHTML}
            </div>
            
            <div onclick="renderView('turnario')" class="order-2 cursor-pointer relative overflow-hidden rounded border ${shiftCardClass.replace('bg-', 'border-').replace('text-', 'border-')} p-0 transition-transform active:scale-95 shadow-sm shrink-0"><div class="${shiftCardClass} p-6 relative z-10"><div class="flex justify-between items-start"><div><span class="text-xs font-bold tracking-widest opacity-70 mb-1 block text-neutral-400 dark:text-neutral-500">${cardLabel}</span><h3 class="text-3xl font-black tracking-tighter mb-1 text-neutral-800 dark:text-neutral-100">${shiftText}</h3><p class="text-sm font-bold opacity-80 flex items-center gap-1"><i class="fa-solid fa-circle-info text-xs"></i> ${shiftSubText}</p></div><div class="w-14 h-14 rounded bg-neutral-100 dark:bg-neutral-800 flex items-center justify-center shadow-inner text-neutral-400 dark:text-neutral-500"><i class="fa-solid ${shiftIcon} text-3xl"></i></div></div></div><div class="absolute -right-4 -bottom-8 opacity-5 pointer-events-none"><i class="fa-solid fa-gears text-9xl text-neutral-900"></i></div></div>${reminderHTML}
            
            <div class="order-4 shrink-0 mt-2">
                <h3 class="text-xs font-bold text-neutral-400 dark:text-neutral-500 uppercase tracking-wider mb-3 ml-1"><i class="fa-solid fa-bolt text-yellow-500 mr-1"></i> Accesos Rápidos</h3>
                <div class="grid grid-cols-4 gap-2 sm:gap-3">
                    <div onclick="renderView('work_orders'); setTimeout(() => openPatientModal(), 100);" class="bg-white dark:bg-neutral-900 p-3 sm:p-4 rounded shadow-sm border border-neutral-300 dark:border-neutral-700 flex flex-col items-center justify-center gap-2 hover:border-blue-500 hover:shadow-md transition group cursor-pointer text-center">
                        <div class="w-10 h-10 sm:w-12 sm:h-12 rounded-full bg-blue-50 dark:bg-blue-900/20 text-blue-600 flex items-center justify-center group-hover:scale-110 group-hover:bg-blue-100 transition"><i class="fa-solid fa-car-side text-lg sm:text-xl"></i></div>
                        <span class="text-[10px] sm:text-[11px] font-bold text-neutral-600 dark:text-neutral-300 leading-tight">Nuevo<br>Vehículo</span>
                    </div>
                    
                    <div onclick="setActiveShopTab('items')" class="bg-white dark:bg-neutral-900 p-3 sm:p-4 rounded shadow-sm border border-neutral-300 dark:border-neutral-700 flex flex-col items-center justify-center gap-2 hover:border-red-500 hover:shadow-md transition group cursor-pointer text-center">
                        <div class="w-10 h-10 sm:w-12 sm:h-12 rounded-full bg-red-50 dark:bg-red-900/20 text-red-600 flex items-center justify-center group-hover:scale-110 group-hover:bg-red-100 transition"><i class="fa-solid fa-cart-shopping text-lg sm:text-xl"></i></div>
                        <span class="text-[10px] sm:text-[11px] font-bold text-neutral-600 dark:text-neutral-300 leading-tight">Lista<br>Compras</span>
                    </div>
                    
                    <div onclick="renderView('notes'); setTimeout(()=> {document.getElementById('new-note-text').focus();}, 300)" class="bg-white dark:bg-neutral-900 p-3 sm:p-4 rounded shadow-sm border border-neutral-300 dark:border-neutral-700 flex flex-col items-center justify-center gap-2 hover:border-yellow-500 hover:shadow-md transition group cursor-pointer text-center">
                        <div class="w-10 h-10 sm:w-12 sm:h-12 rounded-full bg-yellow-50 dark:bg-yellow-900/20 text-yellow-600 flex items-center justify-center group-hover:scale-110 group-hover:bg-yellow-100 transition"><i class="fa-solid fa-pen-clip text-lg sm:text-xl"></i></div>
                        <span class="text-[10px] sm:text-[11px] font-bold text-neutral-600 dark:text-neutral-300 leading-tight">Escribir<br>Apunte</span>
                    </div>
                    
                    <div onclick="setInfoTab('pdf'); if(state.view !== 'links') renderView('links');" class="bg-white dark:bg-neutral-900 p-3 sm:p-4 rounded shadow-sm border border-neutral-300 dark:border-neutral-700 flex flex-col items-center justify-center gap-2 hover:border-purple-500 hover:shadow-md transition group cursor-pointer text-center">
                        <div class="w-10 h-10 sm:w-12 sm:h-12 rounded-full bg-purple-50 dark:bg-purple-900/20 text-purple-600 flex items-center justify-center group-hover:scale-110 group-hover:bg-purple-100 transition"><i class="fa-solid fa-file-pdf text-lg sm:text-xl"></i></div>
                        <span class="text-[10px] sm:text-[11px] font-bold text-neutral-600 dark:text-neutral-300 leading-tight">Abrir<br>Manual</span>
                    </div>
                </div>
            </div>

            <div class="order-5 grid grid-cols-2 gap-3 shrink-0 mt-2">
                <div onclick="renderView('work_orders')" class="bg-white dark:bg-neutral-900 p-4 rounded shadow-sm border border-neutral-300 dark:border-neutral-700 flex flex-col items-center justify-center gap-2 hover:border-blue-400 transition group cursor-pointer">
                    <div class="text-3xl font-black text-neutral-800 dark:text-neutral-100 group-hover:scale-110 transition">${activeCars}</div>
                    <span class="text-[10px] font-bold text-neutral-500 dark:text-neutral-400 tracking-wide uppercase">En Taller</span>
                </div>
                <div onclick="renderView('todo')" class="bg-white dark:bg-neutral-900 p-4 rounded shadow-sm border border-neutral-300 dark:border-neutral-700 flex flex-col items-center justify-center gap-2 hover:border-red-400 transition group cursor-pointer">
                    <div class="text-3xl font-black text-neutral-800 dark:text-neutral-100 group-hover:scale-110 transition">${pendingTodos.length}</div>
                    <span class="text-[10px] font-bold text-neutral-500 dark:text-neutral-400 tracking-wide uppercase">Pendientes</span>
                </div>
            </div>
            </div>`;
        }

        function createPatientTaskHTML(t, patientId) { 
            const priceHTML = t.price ? `<span class="text-xs font-bold text-red-500 w-16 text-right shrink-0">$${t.price.toLocaleString('es-CL')}</span>` : `<span class="text-xs text-neutral-300 w-16 text-right shrink-0">-</span>`;
            return `<div id="patient-task-${t.id}" class="flex items-center gap-2 group/task mb-1 item-enter">
                <button onclick="togglePatientTask(${patientId}, ${t.id})" id="btn-ptask-${t.id}" class="text-sm ${t.done ? 'text-green-600' : 'text-neutral-300 dark:text-neutral-600 hover:text-blue-500'} transition"><i class="fa-${t.done ? 'solid' : 'regular'} fa-square-check"></i></button>
                <span id="txt-ptask-${t.id}" class="text-sm flex-1 truncate ${t.done ? 'text-neutral-400 dark:text-neutral-600 line-through' : 'text-neutral-600 dark:text-neutral-300 font-bold'}">${t.text}</span>
                ${priceHTML}
                <button onclick="deletePatientTask(${patientId}, ${t.id})" class="text-neutral-200 dark:text-neutral-700 hover:text-red-400 opacity-0 group-hover/task:opacity-100 transition shrink-0"><i class="fa-solid fa-xmark"></i></button>
            </div>`; 
        }

        function createPatientCardHTML(p) { 
            const tasksHTML = p.tasks.map(t => createPatientTaskHTML(t, p.id)).join(''); 
            
            let contactBtn = '';
            if (p.contact) {
                contactBtn = `<a href="tel:${p.contact}" class="ml-2 w-6 h-6 rounded-full bg-green-100 dark:bg-green-900 text-green-600 flex items-center justify-center hover:bg-green-200" title="Llamar: ${p.contact}"><i class="fa-solid fa-phone text-xs"></i></a>`;
            }

            return `<div id="patient-card-${p.id}" class="bg-white dark:bg-neutral-900 p-4 rounded shadow-sm border border-neutral-300 dark:border-neutral-700 hover:shadow-md transition group relative mb-3 fade-enter border-l-4 border-l-blue-600">
                <div class="flex justify-between items-start mb-2">
                    <div>
                        <div class="flex gap-2 mb-1">
                            <span class="bg-neutral-100 dark:bg-neutral-800 text-neutral-600 dark:text-neutral-300 px-2 py-0.5 rounded text-[10px] font-bold tracking-wider border border-neutral-200 dark:border-neutral-700"><i class="fa-solid fa-car mr-1"></i> ${p.room}</span>
                        </div>
                        <div class="flex items-center">
                            <h4 class="font-bold text-neutral-800 dark:text-neutral-100 text-xl leading-none tracking-tight">${p.name}</h4>
                            ${contactBtn}
                        </div>
                        <p class="text-sm font-bold text-red-600 mt-1"><i class="fa-solid fa-screwdriver-wrench text-xs"></i> ${p.dx}</p>
                    </div>
                    <button onclick="deletePatient(${p.id})" class="text-neutral-300 dark:text-neutral-600 hover:text-red-500 transition px-2"><i class="fa-solid fa-trash-can text-lg"></i></button>
                </div>
                <div class="mt-3 pl-1 border-l-2 border-neutral-100 dark:border-neutral-800">
                    <div id="patient-tasks-${p.id}">${tasksHTML}</div>
                    <div class="flex items-center gap-2 mt-2">
                        <input type="text" id="new-task-input-${p.id}" placeholder="+ Tarea (ej: Cambiar filtro)..." class="bg-transparent text-sm outline-none w-full placeholder-neutral-400 dark:placeholder-neutral-500 focus:placeholder-blue-400 text-neutral-700 dark:text-neutral-200 font-bold" onkeypress="if(event.key === 'Enter') addPatientTask(${p.id})">
                        <button onclick="addPatientTask(${p.id})" class="text-blue-500 hover:text-blue-700 text-lg"><i class="fa-solid fa-plus-square"></i></button>
                    </div>
                </div>
            </div>`; 
        }

        function generatePatientsHTML() { 
            const activePatients = (state.patients || []).filter(p => p.status !== 'archivada');
            if (activePatients.length === 0) {
                return `<div id="empty-patients-msg" class="bg-white dark:bg-neutral-900 p-8 rounded border-2 border-dashed border-neutral-300 dark:border-neutral-700 text-center flex flex-col items-center justify-center h-48 fade-enter"><i class="fa-solid fa-car-on text-4xl text-neutral-300 dark:text-neutral-700 mb-2"></i><p class="text-neutral-400 dark:text-neutral-500 font-bold text-sm">Sin vehículos en taller</p><p class="text-neutral-400 dark:text-neutral-600 text-xs">Ingresa una orden para comenzar</p></div>`;
            }
            return activePatients.map(p => createPatientCardHTML(p)).join('');
        }

        function getWorkOrdersHTML() {
            const patients = (state.patients || []).filter(p => p.status !== 'archivada');
            const totalCars = patients.length;
            const totalTasks = patients.reduce((acc, p) => acc + p.tasks.length, 0);
            const doneTasks = patients.reduce((acc, p) => acc + p.tasks.filter(t => t.done).length, 0);
            const globalProgress = totalTasks === 0 ? 0 : Math.round((doneTasks / totalTasks) * 100);

            const cardsHTML = patients.length === 0 
                ? `<div class="col-span-full text-center py-20 opacity-50 fade-enter">
                    <div class="w-24 h-24 bg-neutral-100 dark:bg-neutral-800 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fa-solid fa-car-side text-5xl text-neutral-300 dark:text-neutral-600"></i>
                    </div>
                    <h3 class="text-xl font-bold text-neutral-400 dark:text-neutral-500">Taller Vacío</h3>
                    <p class="text-sm text-neutral-400 dark:text-neutral-600">Ingresa un vehículo para comenzar.</p>
                    <button onclick="openPatientModal()" class="mt-4 bg-blue-600 text-white px-6 py-2 rounded-full font-bold shadow-lg hover:bg-blue-700 transition">Ingresar Vehículo</button>
                   </div>`
                : patients.map(p => createWorkOrderCardHTML(p)).join('');

            return `
                <div class="flex flex-col h-full fade-enter">
                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 mb-6 shrink-0">
                        <div class="bg-white dark:bg-neutral-900 p-4 rounded shadow-sm border border-neutral-300 dark:border-neutral-700 border-l-4 border-l-blue-600">
                            <span class="text-xs font-bold text-neutral-400 dark:text-neutral-500 uppercase tracking-wider">Vehículos</span>
                            <div class="text-3xl font-black text-neutral-800 dark:text-neutral-100">${totalCars}</div>
                        </div>
                        <div class="bg-white dark:bg-neutral-900 p-4 rounded shadow-sm border border-neutral-300 dark:border-neutral-700 border-l-4 border-l-green-500">
                            <span class="text-xs font-bold text-neutral-400 dark:text-neutral-500 uppercase tracking-wider">Progreso Global</span>
                            <div class="text-3xl font-black text-neutral-800 dark:text-neutral-100">${globalProgress}<span class="text-base align-top text-neutral-400">%</span></div>
                        </div>
                        <div class="col-span-2 bg-gradient-to-r from-neutral-800 to-neutral-900 text-white p-4 rounded shadow-lg flex justify-between items-center cursor-pointer hover:shadow-xl transition relative overflow-hidden group" onclick="openPatientModal()">
                            <div class="relative z-10">
                                <h3 class="font-bold text-lg"><i class="fa-solid fa-plus-circle text-blue-400 mr-2"></i>Nueva Orden</h3>
                                <p class="text-xs text-neutral-400">Ingresar vehículo a taller</p>
                            </div>
                            <i class="fa-solid fa-wrench text-6xl absolute -right-2 -bottom-4 opacity-10 group-hover:opacity-20 transition rotate-12"></i>
                        </div>
                    </div>
                    <div class="mb-4 flex gap-2 relative">
                        <div class="relative flex-1">
                            <i class="fa-solid fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-neutral-400"></i>
                            <input type="text" placeholder="Buscar por modelo o patente..." class="w-full pl-10 pr-4 py-3 rounded bg-white dark:bg-neutral-900 border border-neutral-300 dark:border-neutral-700 focus:ring-2 focus:ring-blue-500 outline-none text-neutral-700 dark:text-neutral-200 font-bold transition shadow-sm" onkeyup="filterWorkOrders(this.value)">
                        </div>
                        <button onclick="openHistoryModal()" class="w-[46px] h-[46px] bg-neutral-800 dark:bg-neutral-700 text-white rounded flex items-center justify-center hover:bg-neutral-700 transition shadow-sm shrink-0" title="Ver Historial">
                            <i class="fa-solid fa-clock-rotate-left text-xl"></i>
                        </button>
                    </div>
                    <div id="work-orders-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 pb-32">
                        ${cardsHTML}
                    </div>
                </div>
            `;
        }

        function createWorkOrderCardHTML(p) {
            const totalTasks = p.tasks.length;
            const done = p.tasks.filter(t => t.done).length;
            const pct = totalTasks === 0 ? 0 : Math.round((done / totalTasks) * 100);
            
            // Calculadora de Totales
            const subtotal = p.tasks.reduce((sum, t) => sum + (parseFloat(t.price) || 0), 0);
            const iva = Math.round(subtotal * 0.19);
            const total = subtotal + iva;
            
            let progressColor = 'bg-blue-600';
            let borderColor = 'border-l-blue-600';
            if (pct === 100 && totalTasks > 0) { progressColor = 'bg-green-500'; borderColor = 'border-l-green-500'; }
            else if (totalTasks === 0) { progressColor = 'bg-neutral-400'; borderColor = 'border-l-neutral-400'; }

            const tasksHTML = p.tasks.map(t => createPatientTaskHTML(t, p.id)).join('');

            let contactDisplay = '';
            if (p.contact) {
                contactDisplay = `<a href="tel:${p.contact}" class="flex items-center gap-1 text-xs font-bold text-green-600 bg-green-50 dark:bg-green-900/30 px-2 py-1 rounded border border-green-200 dark:border-green-800 hover:bg-green-100 transition mt-1 w-fit">
                    <i class="fa-solid fa-phone"></i> ${p.contact}
                </a>`;
            }

            return `<div id="wo-card-${p.id}" class="work-order-card bg-white dark:bg-neutral-900 rounded shadow-sm hover:shadow-lg transition-all duration-300 border border-neutral-300 dark:border-neutral-700 border-l-4 ${borderColor} p-0 overflow-hidden flex flex-col group" data-search="${p.name.toLowerCase()} ${p.room.toLowerCase()}">
                    <div class="p-4 border-b border-neutral-100 dark:border-neutral-800 bg-neutral-50 dark:bg-neutral-800/50 flex justify-between items-start">
                        <div>
                            <span class="inline-block px-2 py-0.5 rounded bg-neutral-200 dark:bg-neutral-700 text-neutral-600 dark:text-neutral-300 text-[10px] font-bold tracking-widest mb-1 shadow-sm">${p.room}</span>
                            <div class="flex items-center">
                                <h4 class="text-xl font-black text-neutral-800 dark:text-neutral-100 leading-none">${p.name}</h4>
                            </div>
                            ${contactDisplay}
                            <p class="text-sm font-bold text-neutral-500 dark:text-neutral-400 mt-1 truncate"><i class="fa-solid fa-wrench text-xs mr-1 opacity-70"></i> ${p.dx}</p>
                        </div>
                        <button onclick="deletePatient(${p.id})" class="w-8 h-8 flex items-center justify-center rounded-full text-neutral-300 hover:bg-red-50 hover:text-red-500 transition"><i class="fa-solid fa-trash-can"></i></button>
                    </div>
                    <div class="h-1.5 w-full bg-neutral-200 dark:bg-neutral-700">
                        <div class="h-full ${progressColor} transition-all duration-500" style="width: ${pct}%"></div>
                    </div>
                    <div class="p-4 flex-1 flex flex-col min-h-[150px]">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-xs font-bold text-neutral-400 uppercase tracking-wider">Detalles (${done}/${totalTasks})</span>
                            <span class="text-xs font-bold ${pct === 100 && totalTasks > 0 ? 'text-green-500' : 'text-blue-500'}">${pct}%</span>
                        </div>
                        <div class="flex-1 overflow-y-auto hide-scrollbar max-h-[200px] space-y-1 mb-3" id="wo-tasks-${p.id}">
                            ${tasksHTML.length ? tasksHTML : '<p class="text-center text-xs text-neutral-300 italic py-4">Sin repuestos o servicios</p>'}
                        </div>
                        <div class="mt-auto pt-2 border-t border-dashed border-neutral-200 dark:border-neutral-700">
                            <div class="flex justify-between items-end mb-3">
                                <div class="text-[10px] text-neutral-500 font-bold uppercase">Sub: $${subtotal.toLocaleString('es-CL')} | IVA: $${iva.toLocaleString('es-CL')}</div>
                                <div class="text-sm font-black text-red-600 bg-red-50 dark:bg-red-900/20 px-2 py-0.5 rounded border border-red-100 dark:border-red-900">Total: $${total.toLocaleString('es-CL')}</div>
                            </div>
                            <div class="flex items-center gap-2 mb-3">
                                <input type="text" id="new-task-input-${p.id}-lg" placeholder="+ Detalle/Servicio..." class="bg-transparent text-sm outline-none flex-1 placeholder-neutral-400 text-neutral-700 dark:text-neutral-200 font-bold" onkeypress="if(event.key === 'Enter') document.getElementById('new-task-price-${p.id}-lg').focus()">
                                <input type="number" id="new-task-price-${p.id}-lg" placeholder="$ Valor" class="w-20 bg-transparent text-sm outline-none placeholder-neutral-400 text-right text-red-500 font-bold" onkeypress="if(event.key === 'Enter') addPatientTaskWrapper(${p.id})">
                                <button onclick="addPatientTaskWrapper(${p.id})" class="text-blue-500 hover:text-blue-700"><i class="fa-solid fa-paper-plane"></i></button>
                            </div>
                            <button onclick="downloadWorkOrderPDF(${p.id})" class="w-full bg-neutral-800 dark:bg-neutral-800 text-white text-xs py-2 rounded font-bold hover:bg-neutral-700 transition shadow flex items-center justify-center gap-2"><i class="fa-solid fa-file-pdf text-red-400"></i> Cotización / OT PDF</button>
                        </div>
                    </div>
                </div>`;
        }

        function addPatientTaskWrapper(patientId) {
            const inputLg = document.getElementById(`new-task-input-${patientId}-lg`);
            const priceLg = document.getElementById(`new-task-price-${patientId}-lg`);
            
            if (inputLg && inputLg.value.trim()) {
                const text = inputLg.value.trim();
                const price = priceLg ? (parseFloat(priceLg.value) || 0) : 0;
                const patient = state.patients.find(p => p.id === patientId);
                
                if(patient) {
                    const newTask = { id: Date.now(), text, price, done: false };
                    patient.tasks.push(newTask);
                    saveData();
                    
                    if(state.view === 'work_orders') {
                        const oldCard = document.getElementById(`wo-card-${patientId}`);
                        if(oldCard) oldCard.outerHTML = createWorkOrderCardHTML(patient);
                        setTimeout(() => {
                            const newInp = document.getElementById(`new-task-input-${patientId}-lg`);
                            if(newInp) newInp.focus();
                        }, 50);
                    } else {
                        const tasksContainer = document.getElementById(`patient-tasks-${patientId}`); 
                        if(tasksContainer) tasksContainer.insertAdjacentHTML('beforeend', createPatientTaskHTML(newTask, patientId)); 
                    }
                }
            } else {
                addPatientTask(patientId); 
            }
        }

        function filterWorkOrders(query) {
            const term = query.toLowerCase();
            document.querySelectorAll('.work-order-card').forEach(card => {
                const searchData = card.dataset.search;
                if(searchData.includes(term)) card.classList.remove('hidden');
                else card.classList.add('hidden');
            });
        }
        
        function updateCardProgress(patientId) {
            const patient = state.patients.find(p => p.id === patientId);
            if (!patient) return;
            const card = document.getElementById(`wo-card-${patientId}`);
            if (!card) return;
            const total = patient.tasks.length;
            const done = patient.tasks.filter(t => t.done).length;
            const pct = total === 0 ? 0 : Math.round((done / total) * 100);
            const progressBar = card.querySelector('.transition-all.duration-500');
            if (progressBar) {
                progressBar.style.width = `${pct}%`;
                if (pct === 100 && total > 0) {
                    progressBar.className = 'h-full bg-green-500 transition-all duration-500';
                    card.classList.remove('border-l-blue-600', 'border-l-neutral-400');
                    card.classList.add('border-l-green-500');
                } else if (total === 0) {
                    progressBar.className = 'h-full bg-neutral-400 transition-all duration-500';
                    card.classList.remove('border-l-blue-600', 'border-l-green-500');
                    card.classList.add('border-l-neutral-400');
                } else {
                    progressBar.className = 'h-full bg-blue-600 transition-all duration-500';
                    card.classList.remove('border-l-green-500', 'border-l-neutral-400');
                    card.classList.add('border-l-blue-600');
                }
            }
            const counterText = card.querySelector('.uppercase.tracking-wider');
            if (counterText) counterText.innerText = `Tareas (${done}/${total})`;
            const pctText = card.querySelector('.text-xs.font-bold:not(.uppercase)');
            if (pctText) {
                pctText.innerText = `${pct}%`;
                pctText.className = `text-xs font-bold ${pct === 100 && total > 0 ? 'text-green-500' : 'text-blue-500'}`;
            }
        }

        function openPatientModal() { 
            document.getElementById('patient-modal').classList.remove('hidden'); 
            document.body.classList.add('modal-open'); 
            document.getElementById('patient-name').value = ''; 
            document.getElementById('patient-contact').value = ''; 
            document.getElementById('patient-room').value = ''; 
            document.getElementById('patient-dx').value = ''; 
            document.getElementById('patient-name').focus(); 
        }
        function closePatientModal() { document.getElementById('patient-modal').classList.add('hidden'); document.body.classList.remove('modal-open'); }
        
        function createPatient() { 
            const name = document.getElementById('patient-name').value.trim(); 
            const contact = document.getElementById('patient-contact').value.trim(); 
            const room = document.getElementById('patient-room').value.trim(); 
            const dx = document.getElementById('patient-dx').value.trim(); 
            if (!name) return; 
            
            const newPatient = { id: Date.now(), name, contact: contact || '', room: room || '---', dx: dx || 'Revisión', tasks: [], status: 'activa', archiveDate: null };
            state.patients.unshift(newPatient); 
            saveData(); 
            closePatientModal(); 
            
            if (state.view === 'work_orders') {
                const grid = document.getElementById('work-orders-grid');
                if (grid) {
                    if (state.patients.length === 1) {
                        grid.innerHTML = ''; 
                    }
                    grid.insertAdjacentHTML('afterbegin', createWorkOrderCardHTML(newPatient));
                    const newCard = document.getElementById(`wo-card-${newPatient.id}`);
                    if (newCard) {
                        newCard.classList.add('fade-enter');
                        newCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                } else {
                    renderView('work_orders'); 
                }
            } else {
                const container = document.getElementById('patients-list-container'); 
                if (container) { 
                    const emptyMsg = document.getElementById('empty-patients-msg'); 
                    if (emptyMsg) emptyMsg.remove(); 
                    container.insertAdjacentHTML('afterbegin', createPatientCardHTML(newPatient)); 
                } else { 
                    renderView('dashboard'); 
                } 
            }
            showToast("Vehículo Ingresado", "fa-check"); 
        }

        function deletePatient(id) { 
            showConfirmModal("¿Archivar Orden?", "El vehículo pasará al historial.", "Archivar", () => { 
                const p = state.patients.find(x => x.id === id); 
                if (p) { p.status = 'archivada'; p.archiveDate = new Date().toISOString(); }
                saveData(); 
                closeConfirmModal(); 
                
                const card = document.getElementById(`patient-card-${id}`); 
                const woCard = document.getElementById(`wo-card-${id}`);

                if (state.view === 'work_orders' && woCard) {
                    woCard.style.transition = 'all 0.3s';
                    woCard.style.opacity = '0';
                    woCard.style.transform = 'scale(0.9)';
                    setTimeout(() => { 
                        woCard.remove(); 
                        const grid = document.getElementById('work-orders-grid');
                        if(grid && grid.children.length === 0) renderView('work_orders');
                    }, 300);
                } else if (card) { 
                    card.classList.add('item-leave'); 
                    setTimeout(() => { 
                        card.remove(); 
                        const container = document.getElementById('patients-list-container'); 
                        if (container && container.children.length === 0) container.innerHTML = generatePatientsHTML(); 
                    }, 300); 
                } else { 
                    renderView('dashboard'); 
                } 
                showToast("Orden Finalizada", "fa-check-double"); 
            }); 
        }

        function addPatientTask(patientId) { 
            const input = document.getElementById(`new-task-input-${patientId}`); 
            if(!input) return; 
            const text = input.value.trim(); 
            if(!text) return; 
            const patient = state.patients.find(p => p.id === patientId); 
            if(patient) { 
                const newTask = { id: Date.now(), text, done: false }; 
                patient.tasks.push(newTask); 
                saveData(); 
                const tasksContainer = document.getElementById(`patient-tasks-${patientId}`); 
                if(tasksContainer) tasksContainer.insertAdjacentHTML('beforeend', createPatientTaskHTML(newTask, patientId)); 
                input.value = ''; 
                input.focus(); 
            } 
        }

        function togglePatientTask(patientId, taskId) { 
            const patient = state.patients.find(p => p.id === patientId); 
            if(patient) { 
                const task = patient.tasks.find(t => t.id === taskId); 
                if(task) { 
                    task.done = !task.done; 
                    saveData(); 
                    
                    const btn = document.getElementById(`btn-ptask-${taskId}`); 
                    const txt = document.getElementById(`txt-ptask-${taskId}`); 
                    if(btn && txt) { 
                        btn.className = `text-sm ${task.done ? 'text-green-600' : 'text-neutral-300 dark:text-neutral-600 hover:text-blue-500'} transition`; 
                        btn.innerHTML = `<i class="fa-${task.done ? 'solid' : 'regular'} fa-square-check"></i>`; 
                        txt.className = `text-sm flex-1 ${task.done ? 'text-neutral-400 dark:text-neutral-600 line-through' : 'text-neutral-600 dark:text-neutral-300 font-bold'}`; 
                    }
                    
                    if (state.view === 'work_orders') {
                        updateCardProgress(patientId);
                    }
                } 
            } 
        }

        function deletePatientTask(patientId, taskId) { 
            const patient = state.patients.find(p => p.id === patientId); 
            if(patient) { 
                patient.tasks = patient.tasks.filter(t => t.id !== taskId); 
                saveData(); 
                const taskEl = document.getElementById(`patient-task-${taskId}`); 
                if(taskEl) taskEl.remove(); 
                
                if (state.view === 'work_orders') {
                    updateCardProgress(patientId);
                }
            } 
        }

        function deleteCurrentShift() { if (selectedDateKey) { delete state.shifts[selectedDateKey]; saveData(); closeModal(); if (state.view === 'turnario') renderView('turnario'); else renderView('dashboard'); showToast("Evento eliminado", "fa-trash"); } }
        
        function getTurnarioHTML() { 
            const year = state.currentDate.getFullYear(); 
            const month = state.currentDate.getMonth(); 
            const firstDay = new Date(year, month, 1); 
            const lastDay = new Date(year, month + 1, 0); 
            const daysInMonth = lastDay.getDate(); 
            
            let startingDay = firstDay.getDay() === 0 ? 6 : firstDay.getDay() - 1; 

            const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"]; 
            
            let html = `<div class="bg-white dark:bg-neutral-900 rounded-lg shadow-sm border border-neutral-300 dark:border-neutral-700 overflow-hidden"><div class="bg-neutral-100 dark:bg-neutral-800 p-4 border-b border-neutral-200 dark:border-neutral-700 flex justify-between items-center"><button onclick="changeMonth(-1)" class="w-10 h-10 flex items-center justify-center text-neutral-500 dark:text-neutral-400 hover:text-red-600 dark:hover:text-red-500 hover:bg-white dark:hover:bg-neutral-700 rounded transition shadow-sm border border-transparent hover:border-neutral-300"><i class="fa-solid fa-chevron-left text-lg"></i></button><div class="text-center"><h2 class="text-xl font-black text-neutral-800 dark:text-neutral-100 tracking-wide">${monthNames[month]}</h2><p class="text-sm text-neutral-500 dark:text-neutral-400 font-bold font-mono">${year}</p></div><button onclick="changeMonth(1)" class="w-10 h-10 flex items-center justify-center text-neutral-500 dark:text-neutral-400 hover:text-red-600 dark:hover:text-red-500 hover:bg-white dark:hover:bg-neutral-700 rounded transition shadow-sm border border-transparent hover:border-neutral-300"><i class="fa-solid fa-chevron-right text-lg"></i></button></div><div class="p-3"><div class="grid grid-cols-7 gap-1 mb-2 text-center"><div class="text-xs font-bold text-neutral-400 dark:text-neutral-500">L</div><div class="text-xs font-bold text-neutral-400 dark:text-neutral-500">M</div><div class="text-xs font-bold text-neutral-400 dark:text-neutral-500">X</div><div class="text-xs font-bold text-neutral-400 dark:text-neutral-500">J</div><div class="text-xs font-bold text-neutral-400 dark:text-neutral-500">V</div><div class="text-xs font-bold text-red-400">S</div><div class="text-xs font-bold text-red-400">D</div></div><div class="grid grid-cols-7 gap-1.5">`; 
            
            for (let i = 0; i < startingDay; i++) { html += `<div></div>`; } 
            
            for (let day = 1; day <= daysInMonth; day++) { 
                const dateKey = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`; 
                html += createDayCellHTML(dateKey, day); 
            } 
            
            html += `</div></div><div class="bg-neutral-100 dark:bg-neutral-800 p-3 border-t border-neutral-200 dark:border-neutral-700 grid grid-cols-3 gap-2 text-[10px] font-bold text-neutral-500 dark:text-neutral-400 tracking-wide"><span class="flex items-center gap-1"><span class="w-2 h-2 rounded bg-red-500"></span> Taller</span><span class="flex items-center gap-1"><span class="w-2 h-2 rounded bg-blue-500"></span> Informe</span><span class="flex items-center gap-1"><span class="w-2 h-2 rounded bg-indigo-600"></span> Certamen</span><span class="flex items-center gap-1"><span class="w-2 h-2 rounded bg-yellow-500"></span> Teoría</span><span class="flex items-center gap-1"><span class="w-2 h-2 rounded bg-green-500"></span> Agendado</span></div></div>`; 
            
            return html; 
        }

        function createDayCellHTML(dateKey, day) { 
            const shift = state.shifts[dateKey]; 
            let bgClass = "bg-white dark:bg-neutral-900 text-neutral-600 dark:text-neutral-300 hover:bg-neutral-50 dark:hover:bg-neutral-800 border border-neutral-200 dark:border-neutral-700"; 
            let content = `<span class="text-lg font-bold z-10 relative font-mono">${day}</span>`; 
            
            const [year, month, dayOfMonth] = dateKey.split('-').map(Number);
            const dateObj = new Date(year, month - 1, dayOfMonth);
            const dayOfWeek = dateObj.getDay() === 0 ? 6 : dateObj.getDay() - 1; 

            if (dayOfWeek >= 5) { bgClass += " text-red-500 dark:text-red-400"; }
            
            if (shift) { 
                if (shift.type === 'guardia') { 
                    bgClass = "bg-red-500 text-white border-red-600 shadow-md"; 
                } else if (shift.type === 'dia') { 
                    bgClass = "bg-blue-600 text-white border-blue-700 shadow-md"; 
                } else if (shift.type === 'noche') { 
                    bgClass = "bg-indigo-600 text-white border-indigo-700 shadow-md"; 
                } else if (shift.type === 'post') { 
                    bgClass = "bg-yellow-100 dark:bg-yellow-900/50 text-yellow-700 dark:text-yellow-400 border-yellow-300 dark:border-yellow-800"; 
                    content += `<i class="fa-solid fa-book absolute text-xs bottom-1 opacity-50"></i>`; 
                } else if (shift.type === 'libre') { 
                    bgClass = "bg-green-100 dark:bg-green-900/50 text-green-700 dark:text-green-400 border-green-300 dark:border-green-800"; 
                    content += `<i class="fa-solid fa-calendar-check absolute text-xs bottom-1 opacity-50"></i>`; 
                }
                
                if (shift.type === 'post' || shift.type === 'libre') {
                } else if (shift.type !== null) {
                    bgClass = bgClass.replace(' text-red-500 dark:text-red-400', '');
                } else if (dayOfWeek >= 5) {
                    bgClass = bgClass.replace('bg-white dark:bg-neutral-900 text-neutral-600 dark:text-neutral-300', '');
                    bgClass += " text-red-500 dark:text-red-400";
                }
            } 
            
            const todayKey = new Date().toISOString().split('T')[0]; 
            if (dateKey === todayKey) { bgClass += " ring-2 ring-red-500 ring-offset-1 z-20"; } 
            
            let dots = ""; 
            if (shift && (shift.note || shift.eventTime)) { dots = `<div class="absolute top-1 right-1 w-2 h-2 rounded-full bg-red-500 border border-white dark:border-neutral-800"></div>`; } 
            
            return `<div onclick="openShiftModal('${dateKey}')" class="aspect-square rounded flex items-center justify-center relative cursor-pointer transition-transform active:scale-90 ${bgClass}">${content}${dots}</div>`; 
        }

        function changeMonth(delta) { state.currentDate.setMonth(state.currentDate.getMonth() + delta); renderView('turnario'); }
        function openShiftModal(dateKey) { selectedDateKey = dateKey; const shift = state.shifts[dateKey]; const [y, m, d] = dateKey.split('-'); const dateObj = new Date(y, m-1, d); const dateTitle = dateObj.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' }); document.getElementById('modal-date-title').innerText = dateTitle; document.getElementById('modal-note-input').value = shift ? (shift.note || '') : ''; document.getElementById('modal-event-time').value = shift ? (shift.eventTime || '') : ''; tempShiftType = shift ? shift.type : null; updateShiftTypeUI(); document.body.classList.add('modal-open'); document.getElementById('shift-modal').classList.remove('hidden'); }
        function setShiftType(type) { tempShiftType = type; updateShiftTypeUI(); }
        function updateShiftTypeUI() { document.querySelectorAll('.shift-type-btn').forEach(btn => { btn.classList.remove('ring-2', 'ring-red-500', 'bg-red-50', 'text-red-600', 'border-red-200'); if (String(tempShiftType) === btn.dataset.type) { btn.classList.add('ring-2', 'ring-red-500', 'bg-red-50', 'text-red-600', 'border-red-200'); btn.classList.remove('text-neutral-500', 'bg-white'); } }); }
        function closeModal() { document.body.classList.remove('modal-open'); document.getElementById('shift-modal').classList.add('hidden'); }
        function saveShift() { const note = document.getElementById('modal-note-input').value.trim(); const eventTime = document.getElementById('modal-event-time').value; if (!tempShiftType && !note && !eventTime) { delete state.shifts[selectedDateKey]; } else { state.shifts[selectedDateKey] = { type: tempShiftType, note: note, eventTime: eventTime }; } saveData(); closeModal(); if (state.view === 'turnario') { renderView('turnario'); } else if (state.view === 'dashboard') { renderView('dashboard'); } showToast("Agenda Actualizada", "fa-check"); }

        function getNotesHTML() { const foldersHTML = `<div class="flex overflow-x-auto gap-2 pb-2 mb-0 hide-scrollbar mouse-drag" id="folders-container">${generateFoldersHTML()}</div>`; return `<div class="lg:h-full min-h-full flex flex-col"><div class="flex justify-between items-end mb-4 shrink-0"><h2 class="text-3xl font-black text-neutral-800 dark:text-neutral-100 tracking-tighter">Bitácora Técnica</h2><i class="fa-solid fa-wrench text-neutral-300 dark:text-neutral-700 text-2xl"></i></div><div class="flex flex-col lg:flex-row gap-6 flex-1 lg:overflow-hidden"><div class="lg:w-1/3 lg:min-w-[320px] shrink-0"><div id="note-editor" class="bg-white dark:bg-neutral-900 p-5 rounded shadow-sm border border-neutral-300 dark:border-neutral-700 relative lg:h-auto transition-all"><div class="absolute top-0 left-4 w-full h-1 bg-gradient-to-r from-red-400 via-red-500 to-red-400"></div><div class="flex justify-between items-center mb-3"><span id="editor-title" class="text-xs font-bold text-neutral-400 dark:text-neutral-500 tracking-widest">Nueva Entrada</span><button id="editor-cancel-btn" onclick="cancelEdit()" class="text-neutral-400 dark:text-neutral-500 hover:text-red-400 text-sm hidden font-bold"><i class="fa-solid fa-times"></i> Cancelar</button></div><textarea id="new-note-text" class="w-full p-2 border border-neutral-200 dark:border-neutral-700 rounded focus:ring-2 focus:ring-red-200 focus:border-red-300 dark:focus:ring-red-900 outline-none resize-none mb-3 font-handwriting text-2xl text-neutral-700 dark:text-neutral-200 bg-yellow-50/50 dark:bg-neutral-800 leading-relaxed placeholder-neutral-300 dark:placeholder-neutral-600 transition-all" rows="6" placeholder="Anotaciones técnicas..."></textarea><div id="image-preview-container" class="hidden mb-3 relative group w-fit"><img id="image-preview" src="" class="h-24 rounded border border-neutral-300 dark:border-neutral-700 object-cover shadow-sm"><button onclick="clearImageInput()" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center transform scale-90 shadow"><i class="fa-solid fa-xmark text-xs"></i></button></div><div class="flex justify-between items-center pt-3 border-t border-neutral-100 dark:border-neutral-800"><label for="new-note-images" class="cursor-pointer text-neutral-500 dark:text-neutral-400 hover:text-red-600 transition flex items-center gap-2 text-xs font-bold bg-neutral-100 dark:bg-neutral-800 border border-neutral-200 dark:border-neutral-700 px-3 py-2 rounded hover:bg-red-50 dark:hover:bg-red-900/30 hover:border-red-200 tracking-wide"><i class="fa-solid fa-camera"></i> Fotos</label><input type="file" id="new-note-images" accept="image/*" multiple class="hidden" onchange="handleImageSelection(this)"><button id="editor-save-btn" onclick="saveNote()" class="bg-neutral-800 dark:bg-neutral-700 text-white px-6 py-2 rounded text-xs font-bold hover:bg-neutral-700 dark:hover:bg-neutral-600 transform active:scale-95 transition-all shadow-lg tracking-wide"><i class="fa-solid fa-check mr-1"></i> Guardar</button></div></div><p class="hidden lg:block text-center text-xs text-neutral-400 dark:text-neutral-500 mt-4 italic"><i class="fa-solid fa-lightbulb text-yellow-500 dark:text-yellow-600/50 mr-1"></i> Selecciona una nota para editar.</p></div><div class="lg:w-2/3 flex flex-col lg:h-full h-auto min-h-0"><div class="mb-4 relative shrink-0"><i class="fa-solid fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-neutral-400"></i><input type="text" id="notes-search" placeholder="Buscar en bitácora..." class="w-full pl-10 pr-4 py-3 rounded bg-white dark:bg-neutral-900 border border-neutral-300 dark:border-neutral-700 focus:ring-2 focus:ring-red-500 outline-none text-neutral-700 dark:text-neutral-200 font-bold transition shadow-sm" onkeyup="filterNotes(this.value)"></div><div class="mb-4 shrink-0 bg-[#f5f5f5] dark:bg-neutral-950 sticky top-0 z-10 pb-2">${foldersHTML}</div><div class="flex-1 lg:overflow-y-auto pr-1 pb-28 lg:pb-0 hide-scrollbar"><div id="notes-list" class="grid grid-cols-1 md:grid-cols-2 gap-4 auto-rows-min">${generateNotesListHTML()}</div></div></div></div></div>`; }
        
        function generateFoldersHTML() { 
            return `<button onclick="changeFolder('all')" class="whitespace-nowrap px-4 py-1.5 rounded text-xs font-bold transition-all border ${state.currentFolderId === 'all' ? 'bg-neutral-800 text-white border-neutral-800 shadow-md' : 'bg-white dark:bg-neutral-900 text-neutral-500 dark:text-neutral-400 border-neutral-300 dark:border-neutral-700 hover:border-red-400'}" data-id="all">Todo</button>${(state.folders || []).map(f => {
                const isGeneral = f.id === 'general';
                const deleteBtn = isGeneral ? '' : `<span onclick="event.stopPropagation(); deleteFolder('${f.id}')" class="ml-2 hover:text-red-300 text-white/50 cursor-pointer px-1">×</span>`;
                const activeClass = "bg-red-600 text-white border-red-600 shadow-md";
                const inactiveClass = "bg-white dark:bg-neutral-900 text-neutral-500 dark:text-neutral-400 border-neutral-300 dark:border-neutral-700 hover:border-red-400";
                
                return `<button onclick="changeFolder('${f.id}')" class="whitespace-nowrap px-4 py-1.5 rounded text-xs font-bold transition-all border flex items-center ${state.currentFolderId === f.id ? activeClass : inactiveClass}" data-id="${f.id}">${f.name} ${state.currentFolderId === f.id ? deleteBtn : ''}</button>`;
            }).join('')}<button onclick="openFolderModal()" class="w-8 h-8 rounded bg-neutral-200 dark:bg-neutral-800 text-neutral-500 dark:text-neutral-400 hover:bg-neutral-300 dark:hover:bg-neutral-700 flex items-center justify-center border border-neutral-300 dark:border-neutral-700 transition"><i class="fa-solid fa-plus text-xs"></i></button>`; 
        }

        function generateNotesListHTML(searchQuery = '') { 
            let filteredNotes = state.notes || []; 
            if (state.currentFolderId !== 'all') { 
                filteredNotes = filteredNotes.filter(n => n.folderId === state.currentFolderId); 
            } 
            if (searchQuery) {
                const term = searchQuery.toLowerCase();
                filteredNotes = filteredNotes.filter(n => n.text.toLowerCase().includes(term));
            }
            if (filteredNotes.length === 0) return `<div class="text-center py-10 opacity-40 col-span-full"><i class="fa-solid fa-file-signature text-4xl mb-2 text-neutral-300 dark:text-neutral-600"></i><p class="text-sm font-bold text-neutral-400 dark:text-neutral-500">Sin apuntes</p></div>`; 
            return filteredNotes.map(n => createNoteHTML(n)).join(''); 
        }

        function createNoteHTML(note) { 
            let imagesHTML = '';
            if (note.images && note.images.length > 0) {
                imagesHTML = `<div class="flex overflow-x-auto gap-2 pb-2 mb-3 hide-scrollbar snap-x mouse-drag">
                    ${note.images.map(src => `<img src="${src}" class="flex-shrink-0 h-40 w-auto rounded border border-neutral-200 dark:border-neutral-700 snap-center object-cover">`).join('')}
                </div>`;
            } else if (note.image) {
                imagesHTML = `<img src="${note.image}" class="w-full h-auto rounded mb-3 border border-neutral-200 dark:border-neutral-700">`;
            }

            const folderName = (state.folders || []).find(f => f.id === note.folderId)?.name || 'General'; 
            
            return `<div id="note-${note.id}" class="work-order p-5 rounded item-enter group hover:-translate-y-1 transition-transform duration-300">
                <div class="absolute top-3 right-3 opacity-20 group-hover:opacity-100 transition text-neutral-400 dark:text-neutral-600 text-2xl rotate-12"><i class="fa-solid fa-wrench"></i></div>
                ${imagesHTML}
                <p class="text-neutral-700 dark:text-neutral-200 whitespace-pre-wrap font-handwriting text-2xl leading-relaxed relative z-10">${note.text}</p>
                <div class="flex justify-between items-center mt-4 pt-3 border-t border-dashed border-neutral-300 dark:border-neutral-700">
                    <span class="text-[10px] font-bold text-neutral-400 dark:text-neutral-500 tracking-wider bg-neutral-100 dark:bg-neutral-800 px-2 py-1 rounded border border-neutral-200 dark:border-neutral-700">${folderName}</span>
                    <div class="flex gap-2 opacity-60 group-hover:opacity-100 transition">
                        <button onclick="shareNote(${note.id})" class="text-neutral-400 dark:text-neutral-500 hover:text-green-500 px-1" title="Compartir"><i class="fa-solid fa-share-nodes"></i></button>
                        <button onclick="startEditNote(${note.id})" class="text-neutral-400 dark:text-neutral-500 hover:text-blue-500 px-1"><i class="fa-solid fa-pen"></i></button>
                        <button onclick="confirmDelete('note', ${note.id})" class="text-neutral-400 dark:text-neutral-500 hover:text-red-500 px-1"><i class="fa-solid fa-trash"></i></button>
                    </div>
                </div>
            </div>`; 
        }

        function changeFolder(folderId) { 
            state.currentFolderId = folderId; 
            document.getElementById('folders-container').innerHTML = generateFoldersHTML(); 
            const searchEl = document.getElementById('notes-search');
            document.getElementById('notes-list').innerHTML = generateNotesListHTML(searchEl ? searchEl.value : ''); 
        }
        
        function startEditNote(id) { 
            state.editingNoteId = id; 
            const note = state.notes.find(n => n.id === id); 
            if(!note) return; 
            document.getElementById('editor-title').innerText = "Editando Registro"; 
            document.getElementById('editor-save-btn').innerHTML = `<i class="fa-solid fa-rotate mr-1"></i> Actualizar`; 
            document.getElementById('editor-cancel-btn').classList.remove('hidden'); 
            document.getElementById('new-note-text').value = note.text; 
            
            currentNoteImages = note.images ? [...note.images] : (note.image ? [note.image] : []);
            updateImagePreview();
            
            document.getElementById('note-editor').scrollIntoView({ behavior: 'smooth', block: 'center' }); 
        }

        function cancelEdit() { 
            state.editingNoteId = null; 
            document.getElementById('editor-title').innerText = "Nueva Entrada"; 
            document.getElementById('editor-save-btn').innerHTML = `<i class="fa-solid fa-check mr-1"></i> Guardar`; 
            document.getElementById('editor-cancel-btn').classList.add('hidden'); 
            document.getElementById('new-note-text').value = ''; 
            clearImageInput(); 
        }

        async function saveNote() { 
            const textInput = document.getElementById('new-note-text'); 
            const text = textInput.value.trim(); 
            
            if (!text && currentNoteImages.length === 0) return showToast("Nota vacía", "fa-pen"); 
            
            if (state.editingNoteId) { 
                const noteIndex = state.notes.findIndex(n => n.id === state.editingNoteId); 
                if (noteIndex > -1) { 
                    state.notes[noteIndex].text = text; 
                    state.notes[noteIndex].images = [...currentNoteImages];
                    state.notes[noteIndex].image = currentNoteImages.length > 0 ? currentNoteImages[0] : null;

                    const oldEl = document.getElementById(`note-${state.editingNoteId}`);
                    if (oldEl) oldEl.outerHTML = createNoteHTML(state.notes[noteIndex]);
                } 
                cancelEdit(); 
                showToast("Registro actualizado", "fa-rotate"); 
            } else { 
                const targetFolder = state.currentFolderId === 'all' ? 'general' : state.currentFolderId; 
                const newNote = { 
                    id: Date.now(), 
                    text, 
                    images: [...currentNoteImages], 
                    image: currentNoteImages.length > 0 ? currentNoteImages[0] : null,
                    folderId: targetFolder 
                }; 
                state.notes.unshift(newNote); 
                
                const list = document.getElementById('notes-list');
                const emptyMsg = list.querySelector('.text-center.opacity-40');
                if(emptyMsg) emptyMsg.remove();
                list.insertAdjacentHTML('afterbegin', createNoteHTML(newNote));

                textInput.value = ''; 
                clearImageInput(); 
                showToast("Nota guardada", "fa-check"); 
            } 
            saveData(); 
        }

        function deleteNote(id) { state.notes = state.notes.filter(n => n.id !== id); saveData(); const el = document.getElementById(`note-${id}`); if(el) { el.classList.add('item-leave'); setTimeout(() => el.remove(), 300); } showToast("Nota eliminada", "fa-trash"); }
        
        function getTodoHTML() { const todosHTML = state.todos.length === 0 ? `<div id="empty-todo-msg" class="text-center py-12 opacity-50"><i class="fa-solid fa-clipboard-check text-4xl mb-2 text-neutral-300 dark:text-neutral-600"></i><p class="text-sm font-bold text-neutral-400 dark:text-neutral-500">Sin tareas pendientes</p></div>` : state.todos.sort((a,b) => a.done - b.done).map(t => createTodoItemHTML(t)).join(''); return `<div><div class="bg-blue-600 text-white p-6 rounded mb-6 shadow-lg relative overflow-hidden border-l-4 border-red-500"><div class="relative z-10"><h2 class="text-3xl font-black mb-1 tracking-tighter">Lista de Tareas</h2><p class="text-blue-100 text-sm font-mono">Objetivos y mantenimientos.</p></div><i class="fa-solid fa-list-check absolute -right-2 -bottom-4 text-9xl text-blue-800 opacity-30 rotate-12"></i></div><div class="flex gap-2 mb-6 bg-white dark:bg-neutral-900 p-2 rounded shadow-sm border border-neutral-300 dark:border-neutral-700"><input type="text" id="new-todo" placeholder="Agregar nueva tarea..." class="flex-1 p-3 bg-transparent outline-none text-neutral-700 dark:text-neutral-200 font-bold placeholder-neutral-400 dark:placeholder-neutral-500 text-sm" onkeypress="if(event.key === 'Enter') addTodo()"><button onclick="addTodo()" class="bg-red-500 text-white w-12 rounded hover:bg-red-600 transition shadow-sm font-bold text-xl">+</button></div><ul id="todo-list" class="space-y-3 pb-32">${todosHTML}</ul></div>`; }
        function createTodoItemHTML(todo) { const doneClass = todo.done ? "opacity-60 bg-neutral-100 dark:bg-neutral-800 border-neutral-200 dark:border-neutral-700" : "bg-white dark:bg-neutral-900 border-neutral-300 dark:border-neutral-700 border-l-4 border-l-blue-500"; const textClass = todo.done ? "line-through text-neutral-400 dark:text-neutral-500" : "text-neutral-800 dark:text-neutral-200 font-bold"; const iconClass = todo.done ? "fa-solid fa-square-check text-green-500" : "fa-regular fa-square text-neutral-400 dark:text-neutral-500 group-hover:text-blue-500"; return `<li id="todo-${todo.id}" class="flex items-center gap-4 p-4 rounded shadow-sm border ${doneClass} transition-all group item-enter"><button onclick="toggleTodo(${todo.id})" class="text-2xl focus:outline-none transform active:scale-90 transition"><i id="icon-${todo.id}" class="${iconClass}"></i></button><span id="text-${todo.id}" class="flex-1 ${textClass} text-sm cursor-pointer select-none" onclick="toggleTodo(${todo.id})">${todo.text}</span><button onclick="confirmDelete('todo', ${todo.id})" class="w-8 h-8 rounded-full flex items-center justify-center text-neutral-300 dark:text-neutral-600 hover:bg-red-50 dark:hover:bg-red-900/30 hover:text-red-500 transition"><i class="fa-solid fa-trash text-xs"></i></button></li>`; }
        
        function addTodo() { 
            const input = document.getElementById('new-todo'); 
            const text = input.value.trim(); 
            if (!text) return; 
            const newTodo = { id: Date.now(), text, done: false }; 
            state.todos.unshift(newTodo); 
            saveData(); 
            
            const list = document.getElementById('todo-list'); 
            if(list) { 
                const emptyMsg = document.getElementById('empty-todo-msg'); 
                if(emptyMsg) emptyMsg.remove(); 
                list.insertAdjacentHTML('afterbegin', createTodoItemHTML(newTodo)); 
            } 
            input.value = ''; 
            showToast("Tarea añadida", "fa-plus"); 
        }

        function toggleTodo(id) { const todo = state.todos.find(t => t.id === id); if (!todo) return; todo.done = !todo.done; saveData(); const item = document.getElementById(`todo-${id}`); const icon = document.getElementById(`icon-${id}`); const textSpan = document.getElementById(`text-${id}`); if(item && icon && textSpan) { if(todo.done) { item.className = "flex items-center gap-4 p-4 rounded shadow-sm border opacity-60 bg-neutral-100 dark:bg-neutral-800 border-neutral-200 dark:border-neutral-700 transition-all group"; icon.className = "fa-solid fa-square-check text-green-500"; textSpan.className = "flex-1 line-through text-neutral-400 dark:text-neutral-500 text-sm cursor-pointer select-none"; } else { item.className = "flex items-center gap-4 p-4 rounded shadow-sm border bg-white dark:bg-neutral-900 border-neutral-300 dark:border-neutral-700 border-l-4 border-l-blue-500 transition-all group"; icon.className = "fa-regular fa-square text-neutral-400 dark:text-neutral-500 group-hover:text-blue-500"; textSpan.className = "flex-1 text-neutral-800 dark:text-neutral-200 font-bold text-sm cursor-pointer select-none"; } } }
        function deleteTodo(id) { state.todos = state.todos.filter(t => t.id !== id); saveData(); const el = document.getElementById(`todo-${id}`); if (el) { el.classList.add('item-leave'); setTimeout(() => { el.remove(); const list = document.getElementById('todo-list'); if(list && list.children.length === 0) { list.innerHTML = `<div id="empty-todo-msg" class="text-center py-12 opacity-50 fade-enter"><i class="fa-solid fa-clipboard-check text-4xl mb-2 text-neutral-300 dark:text-neutral-600"></i><p class="text-sm font-bold text-neutral-400 dark:text-neutral-500">Sin tareas pendientes</p></div>`; } }, 300); } }
        
        function getShoppingRowHTML(item) {
            const price = parseFloat(item.price) || 0;
            const qty = parseFloat(item.qty) || 1;
            return `
                <tr id="shop-row-${item.id}" class="border-b border-neutral-200 dark:border-neutral-800 hover:bg-neutral-50 dark:hover:bg-neutral-800/50 transition item-enter">
                    <td class="p-2 sm:p-3 min-w-[150px]">
                        <input type="text" value="${item.product}" oninput="updateShoppingItem(${item.id}, 'product', this.value)" class="w-full bg-transparent outline-none font-bold text-neutral-800 dark:text-neutral-200" placeholder="Producto">
                    </td>
                    <td class="p-2 sm:p-3 w-20 min-w-[70px]">
                        <input type="number" value="${qty}" oninput="updateShoppingItem(${item.id}, 'qty', this.value)" class="w-full bg-transparent outline-none font-bold text-center text-neutral-600 dark:text-neutral-400" placeholder="Cant." min="1">
                    </td>
                    <td class="p-2 sm:p-3 w-28 min-w-[90px]">
                        <input type="number" value="${price}" oninput="updateShoppingItem(${item.id}, 'price', this.value)" class="w-full bg-transparent outline-none font-bold text-right text-red-600 dark:text-red-400" placeholder="Precio Un." min="0">
                    </td>
                    <td class="p-2 sm:p-3 w-10 text-center min-w-[50px]">
                        <button onclick="deleteShoppingItem(${item.id})" class="text-neutral-300 dark:text-neutral-600 hover:text-red-500 transition p-1"><i class="fa-solid fa-trash-can"></i></button>
                    </td>
                </tr>
            `;
        }

        function updateShoppingItem(id, field, value) {
            const item = state.shoppingList.find(i => i.id === id);
            if (!item) return;
            if (field === 'price' || field === 'qty') {
                item[field] = parseFloat(value) || 0;
            } else {
                item[field] = value;
            }
            saveData();
            updateShoppingTotal();
        }

        function deleteShoppingItem(id) {
            state.shoppingList = state.shoppingList.filter(i => i.id !== id);
            saveData();
            const row = document.getElementById(`shop-row-${id}`);
            if (row) {
                row.classList.add('opacity-0', 'scale-95');
                setTimeout(() => {
                    row.remove();
                    const tbody = document.getElementById('shopping-table-body');
                    if (tbody && tbody.children.length === 0) {
                        tbody.innerHTML = `<tr id="empty-shop-msg"><td colspan="4" class="text-center py-8 text-neutral-400 dark:text-neutral-500 text-sm italic font-bold">La lista está vacía</td></tr>`;
                    }
                }, 300);
            }
            updateShoppingTotal();
        }
        
        function addShoppingItem() {
            const prodInput = document.getElementById('new-item-product');
            const qtyInput = document.getElementById('new-item-qty');
            const priceInput = document.getElementById('new-item-price');
            const product = prodInput.value.trim();
            const qty = parseFloat(qtyInput.value) || 1;
            const price = parseFloat(priceInput.value) || 0;

            if (!product) return;

            const newItem = { id: Date.now() + Math.random(), product, qty, price };
            state.shoppingList.push(newItem);
            saveData();
            
            const tbody = document.getElementById('shopping-table-body');
            if (tbody) {
                const emptyMsg = document.getElementById('empty-shop-msg');
                if (emptyMsg) emptyMsg.remove();
                tbody.insertAdjacentHTML('beforeend', getShoppingRowHTML(newItem));
            }

            prodInput.value = '';
            qtyInput.value = '1';
            if (priceInput) priceInput.value = '';
            prodInput.focus();
            
            showToast("Producto agregado", "fa-cart-plus");
            updateShoppingTotal();
        }

        function updateShoppingTotal() {
            const subtotal = state.shoppingList.reduce((sum, item) => sum + ((parseFloat(item.price) || 0) * (parseFloat(item.qty) || 1)), 0);
            const iva = Math.round(subtotal * 0.19);
            const total = subtotal + iva;
            const totalEl = document.getElementById('shopping-total');
            if (totalEl) {
                totalEl.innerHTML = `$${total.toLocaleString('es-CL', { minimumFractionDigits: 0 })}<div class="text-[10px] text-neutral-500 font-normal mt-1 leading-none tracking-normal">+ IVA (19%): $${iva.toLocaleString('es-CL')} | Sub: $${subtotal.toLocaleString('es-CL')}</div>`;
            }
        }

        function getServiceRowHTML(item) {
            const price = parseFloat(item.price) || 0;
            return `
                <tr id="service-row-${item.id}" class="border-b border-neutral-200 dark:border-neutral-800 hover:bg-neutral-50 dark:hover:bg-neutral-800/50 transition item-enter">
                    <td class="p-2 sm:p-3 min-w-[180px]">
                        <input type="text" value="${item.service}" oninput="updateServiceItem(${item.id}, 'service', this.value)" class="w-full bg-transparent outline-none font-bold text-neutral-800 dark:text-neutral-200" placeholder="Descripción del Servicio">
                    </td>
                    <td class="p-2 sm:p-3 w-32 min-w-[100px]">
                        <input type="number" value="${price}" oninput="updateServiceItem(${item.id}, 'price', this.value)" class="w-full bg-transparent outline-none font-bold text-right text-red-600 dark:text-red-400" placeholder="Precio" min="0">
                    </td>
                    <td class="p-2 sm:p-3 w-10 text-center min-w-[50px]">
                        <button onclick="deleteServiceItem(${item.id})" class="text-neutral-300 dark:text-neutral-600 hover:text-red-500 transition p-1"><i class="fa-solid fa-trash-can"></i></button>
                    </td>
                </tr>
            `;
        }

        function updateServiceItem(id, field, value) {
            const item = state.serviceList.find(i => i.id === id);
            if (!item) return;
            if (field === 'price') {
                item[field] = parseFloat(value) || 0;
            } else {
                item[field] = value;
            }
            saveData();
            updateServiceTotal();
        }

        function deleteServiceItem(id) {
            state.serviceList = state.serviceList.filter(i => i.id !== id);
            saveData();
            const row = document.getElementById(`service-row-${id}`);
            if (row) {
                row.classList.add('opacity-0', 'scale-95');
                setTimeout(() => {
                    row.remove();
                    const tbody = document.getElementById('service-table-body');
                    if (tbody && tbody.children.length === 0) {
                        tbody.innerHTML = `<tr id="empty-service-msg"><td colspan="3" class="text-center py-8 text-neutral-400 dark:text-neutral-500 text-sm italic font-bold">La lista de servicios está vacía</td></tr>`;
                    }
                }, 300);
            }
            updateServiceTotal();
        }
        
        function addServiceItem() {
            const serviceInput = document.getElementById('new-service-desc');
            const priceInput = document.getElementById('new-service-price');
            const service = serviceInput.value.trim();
            const price = parseFloat(priceInput.value) || 0;

            if (!service) return;

            const newItem = { id: Date.now() + Math.random(), service, price };
            state.serviceList.push(newItem);
            saveData();
            
            const tbody = document.getElementById('service-table-body');
            if (tbody) {
                const emptyMsg = document.getElementById('empty-service-msg');
                if (emptyMsg) emptyMsg.remove();
                tbody.insertAdjacentHTML('beforeend', getServiceRowHTML(newItem));
            }

            serviceInput.value = '';
            priceInput.value = '';
            serviceInput.focus();
            
            showToast("Servicio agregado", "fa-tools");
            updateServiceTotal();
        }

        function updateServiceTotal() {
            const subtotal = state.serviceList.reduce((sum, item) => sum + (parseFloat(item.price) || 0), 0);
            const iva = Math.round(subtotal * 0.19);
            const total = subtotal + iva;
            const totalEl = document.getElementById('service-total');
            if (totalEl) {
                totalEl.innerHTML = `$${total.toLocaleString('es-CL', { minimumFractionDigits: 0 })}<div class="text-[10px] text-neutral-500 font-normal mt-1 leading-none tracking-normal">+ IVA (19%): $${iva.toLocaleString('es-CL')} | Sub: $${subtotal.toLocaleString('es-CL')}</div>`;
            }
        }

        function clearServiceList() {
            if (state.serviceList.length === 0) return;
            showConfirmModal("¿Limpiar Servicios?", "Se borrarán todos los costos de servicio.", "Limpiar Todo", function() {
                state.serviceList = [];
                saveData();
                closeConfirmModal();
                const tbody = document.getElementById('service-table-body');
                if (tbody) {
                    tbody.innerHTML = `<tr id="empty-service-msg"><td colspan="3" class="text-center py-8 text-neutral-400 dark:text-neutral-500 text-sm italic font-bold">La lista de servicios está vacía</td></tr>`;
                }
                updateServiceTotal();
                showToast("Lista de servicios limpia", "fa-eraser");
            });
        }
        
        // --- FUNCIONES DE INVENTARIO (INVENTORY) ---
        function getStatusBadgeHTML(qty, minQty) {
            if (qty <= 0) return `<span class="bg-red-100 text-red-600 px-2 py-0.5 rounded text-[10px] font-bold tracking-wider mt-1 border border-red-200">AGOTADO</span>`;
            if (qty <= minQty) return `<span class="bg-yellow-100 text-yellow-700 px-2 py-0.5 rounded text-[10px] font-bold tracking-wider mt-1 border border-yellow-200">BAJO STOCK</span>`;
            return `<span class="bg-green-100 text-green-600 px-2 py-0.5 rounded text-[10px] font-bold tracking-wider mt-1 border border-green-200">ÓPTIMO</span>`;
        }

        function getInventoryRowHTML(item) {
            const price = parseFloat(item.price) || 0;
            const salePrice = parseFloat(item.salePrice) || 0;
            const qty = parseFloat(item.qty) || 0;
            const minQty = parseFloat(item.minQty) || 0;
            const soldQty = parseFloat(item.soldQty) || 0;
            
            const realProfit = soldQty * (salePrice - price);
            
            const sku = item.sku || 'N/A';
            const category = item.category || 'Sin categoría';

            const badgeHTML = getStatusBadgeHTML(qty, minQty);

            return `
                <tr id="inventory-row-${item.id}" class="border-b border-neutral-200 dark:border-neutral-800 hover:bg-neutral-50 dark:hover:bg-neutral-800/50 transition duration-300 item-enter group">
                    <td class="p-2 sm:p-3 lg:w-[30%] min-w-[180px]">
                        <div class="flex flex-col">
                            <span class="text-[10px] text-neutral-400 font-mono mb-1"><i class="fa-solid fa-barcode mr-1"></i>${sku} <span class="mx-1">&bull;</span> <i class="fa-solid fa-tag mr-1"></i>${category}</span>
                            <input type="text" value="${item.product}" oninput="updateInventoryItem(${item.id}, 'product', this.value)" class="bg-transparent outline-none font-bold text-neutral-800 dark:text-neutral-200 text-sm w-full focus:text-green-600 transition-colors" placeholder="Nombre del Ítem">
                        </div>
                    </td>
                    <td class="p-2 sm:p-3 text-center align-middle lg:w-[15%] min-w-[90px]">
                        <div class="flex flex-col items-center justify-center">
                            <input type="number" value="${qty}" oninput="updateInventoryItem(${item.id}, 'qty', this.value)" class="qty-input w-16 bg-neutral-100 dark:bg-neutral-800 outline-none font-black text-center text-neutral-700 dark:text-neutral-200 rounded p-1 focus:ring-2 focus:ring-green-500 transition" min="0">
                            <div class="status-badge-container">${badgeHTML}</div>
                        </div>
                    </td>
                    <td class="p-2 sm:p-3 align-middle lg:w-[20%] min-w-[120px]">
                        <div class="flex flex-col gap-1 items-end pr-2">
                            <div class="flex items-center justify-between w-full max-w-[120px]">
                                <span class="text-[10px] text-neutral-400 font-bold uppercase">Costo:</span>
                                <input type="number" value="${price}" oninput="updateInventoryItem(${item.id}, 'price', this.value)" class="w-16 sm:w-20 bg-transparent outline-none font-bold text-right text-neutral-500 dark:text-neutral-400 text-sm focus:border-b border-blue-500 transition" min="0" placeholder="$0">
                            </div>
                            <div class="flex items-center justify-between w-full max-w-[120px]">
                                <span class="text-[10px] text-neutral-400 font-bold uppercase">Venta:</span>
                                <input type="number" value="${salePrice}" oninput="updateInventoryItem(${item.id}, 'salePrice', this.value)" class="w-16 sm:w-20 bg-transparent outline-none font-bold text-right text-green-600 dark:text-green-400 text-sm focus:border-b border-green-500 transition" min="0" placeholder="$0">
                            </div>
                        </div>
                    </td>
                    <td class="p-2 sm:p-3 align-middle lg:w-[20%] min-w-[130px]">
                        <div class="flex flex-col gap-1 items-end">
                            <div class="flex items-center justify-between w-full max-w-[120px]">
                                <span class="text-[10px] text-neutral-400 font-bold uppercase" title="Unidades Vendidas">Vendidos:</span>
                                <input type="number" value="${soldQty}" oninput="updateInventoryItem(${item.id}, 'soldQty', this.value)" class="sold-input w-16 bg-transparent outline-none font-bold text-right text-purple-600 dark:text-purple-400 text-sm focus:border-b border-purple-500 transition" min="0">
                            </div>
                            <span class="profit-text text-[11px] sm:text-xs ${realProfit >= 0 ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'} font-black mt-1 tracking-tight" title="Ganancia Real Acumulada">Ganan: $${realProfit.toLocaleString('es-CL')}</span>
                        </div>
                    </td>
                    <td class="p-2 sm:p-3 lg:w-[15%] min-w-[80px] text-center align-middle">
                        <div class="flex items-center justify-end gap-1.5 sm:gap-2">
                            <button onclick="sellInventoryItem(${item.id})" class="w-7 h-7 sm:w-8 sm:h-8 rounded bg-green-100 dark:bg-green-900/50 text-green-600 dark:text-green-400 hover:bg-green-500 hover:text-white dark:hover:bg-green-600 dark:hover:text-white transition shadow-sm flex items-center justify-center opacity-80 group-hover:opacity-100 active:scale-95" title="Vender 1 unidad"><i class="fa-solid fa-hand-holding-dollar text-[10px] sm:text-sm"></i></button>
                            <button onclick="deleteInventoryItem(${item.id})" class="w-7 h-7 sm:w-8 sm:h-8 rounded text-neutral-300 dark:text-neutral-600 hover:bg-red-50 hover:text-red-500 transition opacity-30 group-hover:opacity-100 flex items-center justify-center active:scale-95"><i class="fa-solid fa-trash-can text-[10px] sm:text-sm"></i></button>
                        </div>
                    </td>
                </tr>
            `;
        }

        function updateInventoryItem(id, field, value) {
            const item = state.inventoryList.find(i => i.id === id);
            if (!item) return;
            if (field === 'price' || field === 'salePrice' || field === 'qty' || field === 'minQty' || field === 'soldQty') {
                item[field] = parseFloat(value) || 0;
            } else {
                item[field] = value;
            }
            saveData();
            
            // Actualización de DOM quirúrgica sin reemplazar el row completo (foco no se pierde)
            const row = document.getElementById(`inventory-row-${id}`);
            if(row) {
                const badgeContainer = row.querySelector('.status-badge-container');
                if (badgeContainer) badgeContainer.innerHTML = getStatusBadgeHTML(item.qty, item.minQty);

                const profitEl = row.querySelector('.profit-text');
                if (profitEl) {
                    const profit = (parseFloat(item.soldQty)||0) * ((parseFloat(item.salePrice)||0) - (parseFloat(item.price)||0));
                    profitEl.innerText = `Ganan: $${profit.toLocaleString('es-CL')}`;
                    profitEl.className = `profit-text text-xs ${profit >= 0 ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'} font-black mt-1 tracking-tight`;
                }
            }
            updateInventoryTotal();
        }

        function sellInventoryItem(id) {
            const item = state.inventoryList.find(i => i.id === id);
            if (!item) return;
            if (parseFloat(item.qty) > 0) {
                item.qty = (parseFloat(item.qty) || 0) - 1;
                item.soldQty = (parseFloat(item.soldQty) || 0) + 1;
                saveData();
                
                const row = document.getElementById(`inventory-row-${id}`);
                if (row) {
                    // Update input values directly
                    const qtyInput = row.querySelector('.qty-input');
                    if(qtyInput) qtyInput.value = item.qty;
                    
                    const soldInput = row.querySelector('.sold-input');
                    if(soldInput) soldInput.value = item.soldQty;

                    const badgeContainer = row.querySelector('.status-badge-container');
                    if (badgeContainer) badgeContainer.innerHTML = getStatusBadgeHTML(item.qty, item.minQty);

                    const profitEl = row.querySelector('.profit-text');
                    if (profitEl) {
                        const profit = item.soldQty * (item.salePrice - item.price);
                        profitEl.innerText = `Ganan: $${profit.toLocaleString('es-CL')}`;
                        profitEl.className = `profit-text text-xs ${profit >= 0 ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'} font-black mt-1 tracking-tight`;
                    }

                    row.classList.add('bg-green-100', 'dark:bg-green-900/50');
                    setTimeout(() => row.classList.remove('bg-green-100', 'dark:bg-green-900/50'), 400);
                }
                updateInventoryTotal();
                showToast("Venta registrada", "fa-hand-holding-dollar");
            } else {
                showToast("Sin stock para vender", "fa-triangle-exclamation");
            }
        }

        function deleteInventoryItem(id) {
            state.inventoryList = state.inventoryList.filter(i => i.id !== id);
            saveData();
            const row = document.getElementById(`inventory-row-${id}`);
            if (row) {
                row.classList.add('opacity-0', 'scale-95');
                setTimeout(() => {
                    row.remove();
                    const tbody = document.getElementById('inventory-table-body');
                    if (tbody && tbody.children.length === 0) {
                        tbody.innerHTML = `<tr id="empty-inventory-msg"><td colspan="5" class="text-center py-12"><div class="w-16 h-16 bg-neutral-100 dark:bg-neutral-800 rounded-full flex items-center justify-center mx-auto mb-3"><i class="fa-solid fa-box-open text-2xl text-neutral-300 dark:text-neutral-600"></i></div><p class="text-sm font-bold text-neutral-400 dark:text-neutral-500">Inventario Vacío</p><p class="text-xs text-neutral-400 mt-1">Registra tus repuestos e insumos.</p></td></tr>`;
                    }
                }, 300);
            }
            updateInventoryTotal();
        }
        
        function addInventoryItem() {
            const skuInput = document.getElementById('new-inv-sku');
            const prodInput = document.getElementById('new-inv-product');
            const catInput = document.getElementById('new-inv-category');
            const qtyInput = document.getElementById('new-inv-qty');
            const minInput = document.getElementById('new-inv-min');
            const priceInput = document.getElementById('new-inv-price');
            const salePriceInput = document.getElementById('new-inv-sale-price');

            const sku = skuInput.value.trim() || 'N/A';
            const product = prodInput.value.trim();
            const category = catInput.value;
            const qty = parseFloat(qtyInput.value) || 0;
            const minQty = parseFloat(minInput.value) || 0;
            const price = parseFloat(priceInput.value) || 0;
            const salePrice = parseFloat(salePriceInput.value) || 0;

            if (!product) { 
                showToast("Falta nombre del producto", "fa-triangle-exclamation"); 
                prodInput.focus();
                return; 
            }

            const newItem = { id: Date.now() + Math.random(), sku, product, category, qty, minQty, price, salePrice, soldQty: 0 };
            state.inventoryList.unshift(newItem); 
            saveData();
            
            const tbody = document.getElementById('inventory-table-body');
            if (tbody) {
                const emptyMsg = document.getElementById('empty-inventory-msg');
                if (emptyMsg) emptyMsg.remove();
                tbody.insertAdjacentHTML('afterbegin', getInventoryRowHTML(newItem));
            }
            
            updateInventoryTotal();
            
            // Limpiar inputs
            skuInput.value = '';
            prodInput.value = '';
            qtyInput.value = '';
            priceInput.value = '';
            salePriceInput.value = '';
            prodInput.focus();
            
            showToast("Ítem Registrado", "fa-check");
        }

        function updateInventoryTotal() {
            const totalCost = state.inventoryList.reduce((sum, item) => sum + ((parseFloat(item.price) || 0) * (parseFloat(item.qty) || 0)), 0);
            
            // La ganancia real ahora se basa solo en lo que sí se vendió (soldQty)
            const totalProfit = state.inventoryList.reduce((sum, item) => {
                const p = parseFloat(item.price) || 0;
                const sp = parseFloat(item.salePrice) || 0;
                const sq = parseFloat(item.soldQty) || 0;
                return sum + (sq * (sp - p));
            }, 0);
            
            // Update UI fluidly via innerText
            const kpiItems = document.getElementById('inv-kpi-items');
            if(kpiItems) kpiItems.innerText = state.inventoryList.length;
            
            const kpiAlerts = document.getElementById('inv-kpi-alerts');
            if(kpiAlerts) kpiAlerts.innerText = state.inventoryList.filter(i => (parseFloat(i.qty)||0) <= (parseFloat(i.minQty)||0)).length;
            
            const kpiCost = document.getElementById('inv-kpi-cost');
            if(kpiCost) {
                kpiCost.innerText = `$${totalCost.toLocaleString('es-CL')}`;
                kpiCost.title = `$${totalCost.toLocaleString('es-CL')}`;
            }

            const kpiProfit = document.getElementById('inv-kpi-profit');
            if(kpiProfit) {
                kpiProfit.innerText = `$${totalProfit.toLocaleString('es-CL')}`;
                kpiProfit.title = `$${totalProfit.toLocaleString('es-CL')}`;
                if (totalProfit < 0) kpiProfit.className = "text-lg sm:text-xl font-black text-red-500 truncate max-w-[100px] sm:max-w-full leading-none";
                else kpiProfit.className = "text-lg sm:text-xl font-black text-green-600 truncate max-w-[100px] sm:max-w-full leading-none";
            }
        }

        function clearInventoryList() {
            if (state.inventoryList.length === 0) return;
            showConfirmModal("¿Limpiar Inventario?", "Se borrarán permanentemente todos los ítems registrados.", "Limpiar Todo", function() {
                state.inventoryList = [];
                saveData();
                closeConfirmModal();
                
                const tbody = document.getElementById('inventory-table-body');
                if (tbody) {
                    tbody.innerHTML = `<tr id="empty-inventory-msg"><td colspan="5" class="text-center py-12"><div class="w-16 h-16 bg-neutral-100 dark:bg-neutral-800 rounded-full flex items-center justify-center mx-auto mb-3"><i class="fa-solid fa-box-open text-2xl text-neutral-300 dark:text-neutral-600"></i></div><p class="text-sm font-bold text-neutral-400 dark:text-neutral-500">Inventario Vacío</p><p class="text-xs text-neutral-400 mt-1">Registra tus repuestos e insumos.</p></td></tr>`;
                }
                updateInventoryTotal();
                showToast("Inventario limpio", "fa-eraser");
            });
        }

        function getShoppingListContentHTML() {
            const itemsHTML = state.shoppingList.map((item) => getShoppingRowHTML(item)).join('');
            const subtotal = state.shoppingList.reduce((sum, item) => sum + ((parseFloat(item.price) || 0) * (parseFloat(item.qty) || 1)), 0);
            const iva = Math.round(subtotal * 0.19);
            const total = subtotal + iva;

            return `
                <div class="bg-white dark:bg-neutral-900 rounded-lg shadow-sm border border-neutral-300 dark:border-neutral-700 overflow-x-auto hide-scrollbar mouse-drag">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="bg-neutral-100 dark:bg-neutral-800 text-xs text-neutral-500 dark:text-neutral-400 border-b border-neutral-200 dark:border-neutral-700">
                                <th class="p-2 sm:p-3 font-bold uppercase tracking-wider min-w-[150px]">Producto / Repuesto</th>
                                <th class="p-2 sm:p-3 font-bold uppercase tracking-wider text-center min-w-[70px]">Cant.</th>
                                <th class="p-2 sm:p-3 font-bold uppercase tracking-wider text-right min-w-[90px]">Precio Un.</th>
                                <th class="p-2 sm:p-3 min-w-[50px]"></th>
                            </tr>
                        </thead>
                        <tbody id="shopping-table-body">
                            ${itemsHTML || `<tr id="empty-shop-msg"><td colspan="4" class="text-center py-8 text-neutral-400 dark:text-neutral-500 text-sm italic font-bold">La lista está vacía</td></tr>`}
                        </tbody>
                        <tfoot class="bg-neutral-50 dark:bg-neutral-800/30">
                            <tr>
                                <td colspan="2" class="p-2 sm:p-3 text-right font-black text-xs sm:text-sm uppercase">Total Calculado:</td>
                                <td class="p-2 sm:p-3 text-right font-black text-red-600 dark:text-red-400 text-base sm:text-lg" id="shopping-total">
                                    $${total.toLocaleString('es-CL', { minimumFractionDigits: 0 })}
                                    <div class="text-[9px] sm:text-[10px] text-neutral-500 font-normal mt-1 leading-none tracking-normal">+ IVA (19%): $${iva.toLocaleString('es-CL')} | Sub: $${subtotal.toLocaleString('es-CL')}</div>
                                </td>
                                <td class="p-2 sm:p-3"></td>
                            </tr>
                            <tr>
                                <td class="p-2 sm:p-3">
                                    <input type="text" id="new-item-product" placeholder="Agregar producto..." class="w-full min-w-[130px] bg-transparent outline-none text-sm font-bold text-neutral-700 dark:text-neutral-300 placeholder-neutral-400" onkeypress="if(event.key === 'Enter') document.getElementById('new-item-qty').focus()">
                                </td>
                                <td class="p-2 sm:p-3">
                                    <input type="number" id="new-item-qty" placeholder="1" class="w-full min-w-[50px] bg-transparent outline-none text-sm font-bold text-center text-neutral-700 dark:text-neutral-300 placeholder-neutral-400" min="1" onkeypress="if(event.key === 'Enter') document.getElementById('new-item-price').focus()">
                                </td>
                                <td class="p-2 sm:p-3">
                                    <input type="number" id="new-item-price" placeholder="Valor" class="w-full min-w-[70px] bg-transparent outline-none text-sm font-bold text-right text-neutral-700 dark:text-neutral-300 placeholder-neutral-400" min="0" onkeypress="if(event.key === 'Enter') addShoppingItem()">
                                </td>
                                <td class="p-2 sm:p-3 text-center">
                                    <button onclick="addShoppingItem()" class="bg-red-600 text-white w-7 h-7 sm:w-8 sm:h-8 rounded flex items-center justify-center hover:bg-red-700 transition shadow-sm mx-auto">
                                        <i class="fa-solid fa-plus text-xs"></i>
                                    </button>
                                </td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            `;
        }

        function getServiceListContentHTML() {
            const servicesHTML = state.serviceList.map((item) => getServiceRowHTML(item)).join('');
            const subtotal = state.serviceList.reduce((sum, item) => sum + (parseFloat(item.price) || 0), 0);
            const iva = Math.round(subtotal * 0.19);
            const total = subtotal + iva;
            
            return `
                <div class="bg-white dark:bg-neutral-900 rounded-lg shadow-sm border border-neutral-300 dark:border-neutral-700 overflow-x-auto hide-scrollbar mouse-drag">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="bg-neutral-100 dark:bg-neutral-800 text-xs text-neutral-500 dark:text-neutral-400 border-b border-neutral-200 dark:border-neutral-700">
                                <th class="p-2 sm:p-3 font-bold uppercase tracking-wider min-w-[180px]">Servicio / Mano de Obra</th>
                                <th class="p-2 sm:p-3 font-bold uppercase tracking-wider text-right min-w-[100px]">Precio</th>
                                <th class="p-2 sm:p-3 min-w-[50px]"></th>
                            </tr>
                        </thead>
                        <tbody id="service-table-body">
                            ${servicesHTML || `<tr id="empty-service-msg"><td colspan="3" class="text-center py-8 text-neutral-400 dark:text-neutral-500 text-sm italic font-bold">La lista de servicios está vacía</td></tr>`}
                        </tbody>
                        <tfoot class="bg-neutral-50 dark:bg-neutral-800/30">
                            <tr>
                                <td class="p-2 sm:p-3 text-right font-black text-xs sm:text-sm uppercase">Costo Total:</td>
                                <td class="p-2 sm:p-3 text-right font-black text-red-600 dark:text-red-400 text-base sm:text-lg" id="service-total">
                                    $${total.toLocaleString('es-CL', { minimumFractionDigits: 0 })}
                                    <div class="text-[9px] sm:text-[10px] text-neutral-500 font-normal mt-1 leading-none tracking-normal">+ IVA (19%): $${iva.toLocaleString('es-CL')} | Sub: $${subtotal.toLocaleString('es-CL')}</div>
                                </td>
                                <td class="p-2 sm:p-3"></td>
                            </tr>
                            <tr>
                                <td class="p-2 sm:p-3">
                                    <input type="text" id="new-service-desc" placeholder="Agregar servicio..." class="w-full min-w-[160px] bg-transparent outline-none text-sm font-bold text-neutral-700 dark:text-neutral-300 placeholder-neutral-400" onkeypress="if(event.key === 'Enter') document.getElementById('new-service-price').focus()">
                                </td>
                                <td class="p-2 sm:p-3">
                                    <input type="number" id="new-service-price" placeholder="0" class="w-full min-w-[80px] bg-transparent outline-none text-sm font-bold text-right text-neutral-700 dark:text-neutral-300 placeholder-neutral-400" min="0" onkeypress="if(event.key === 'Enter') addServiceItem()">
                                </td>
                                <td class="p-2 sm:p-3 text-center">
                                    <button onclick="addServiceItem()" class="bg-red-600 text-white w-7 h-7 sm:w-8 sm:h-8 rounded flex items-center justify-center hover:bg-red-700 transition shadow-sm mx-auto">
                                        <i class="fa-solid fa-plus text-xs"></i>
                                    </button>
                                </td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            `;
        }

        function getInventoryListContentHTML() {
            const inventoryHTML = state.inventoryList.map((item) => getInventoryRowHTML(item)).join('');
            
            const totalCost = state.inventoryList.reduce((sum, item) => sum + ((parseFloat(item.price) || 0) * (parseFloat(item.qty) || 0)), 0);
            const totalProfit = state.inventoryList.reduce((sum, item) => {
                const p = parseFloat(item.price) || 0;
                const sp = parseFloat(item.salePrice) || 0;
                const sq = parseFloat(item.soldQty) || 0;
                return sum + (sq * (sp - p));
            }, 0);
            
            const totalItems = state.inventoryList.length;
            const lowStockCount = state.inventoryList.filter(i => (parseFloat(i.qty)||0) <= (parseFloat(i.minQty)||0)).length;

            return `
                <div class="fade-enter">
                    <!-- KPI Dashboard -->
                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 mb-6">
                        <div class="bg-white dark:bg-neutral-900 p-3 sm:p-4 rounded-lg shadow-sm border border-neutral-300 dark:border-neutral-700 border-l-4 border-l-neutral-500 flex justify-between items-center group">
                            <div>
                                <p class="text-[10px] font-bold text-neutral-400 uppercase tracking-wider mb-1">Catálogo</p>
                                <p class="text-xl sm:text-2xl font-black text-neutral-800 dark:text-neutral-100 leading-none" id="inv-kpi-items">${totalItems}</p>
                            </div>
                            <i class="fa-solid fa-boxes-stacked text-2xl text-neutral-100 dark:text-neutral-800 group-hover:scale-110 transition-transform"></i>
                        </div>
                        <div class="bg-white dark:bg-neutral-900 p-3 sm:p-4 rounded-lg shadow-sm border border-neutral-300 dark:border-neutral-700 border-l-4 border-l-yellow-500 flex justify-between items-center group">
                            <div>
                                <p class="text-[10px] font-bold text-neutral-400 uppercase tracking-wider mb-1">Alertas Stock</p>
                                <p class="text-xl sm:text-2xl font-black ${lowStockCount > 0 ? 'text-yellow-600' : 'text-neutral-300 dark:text-neutral-700'} leading-none" id="inv-kpi-alerts">${lowStockCount}</p>
                            </div>
                            <i class="fa-solid fa-triangle-exclamation text-2xl text-neutral-100 dark:text-neutral-800 group-hover:scale-110 transition-transform"></i>
                        </div>
                        <div class="bg-white dark:bg-neutral-900 p-3 sm:p-4 rounded-lg shadow-sm border border-neutral-300 dark:border-neutral-700 border-l-4 border-l-blue-500 flex justify-between items-center group overflow-hidden">
                            <div class="z-10 relative">
                                <p class="text-[10px] font-bold text-neutral-400 uppercase tracking-wider mb-1" title="Valor del stock en bodega">Inversión Actual</p>
                                <p class="text-lg sm:text-xl font-black text-blue-600 truncate max-w-[100px] sm:max-w-full leading-none" id="inv-kpi-cost" title="$${totalCost.toLocaleString('es-CL')}">$${totalCost.toLocaleString('es-CL')}</p>
                            </div>
                            <i class="fa-solid fa-money-bill-trend-up text-3xl text-neutral-100 dark:text-neutral-800 absolute right-2 opacity-50 group-hover:scale-110 transition-transform"></i>
                        </div>
                        <div class="bg-white dark:bg-neutral-900 p-3 sm:p-4 rounded-lg shadow-sm border border-neutral-300 dark:border-neutral-700 border-l-4 border-l-green-500 flex justify-between items-center group overflow-hidden">
                            <div class="z-10 relative">
                                <p class="text-[10px] font-bold text-neutral-400 uppercase tracking-wider mb-1" title="Ganancias generadas por unidades vendidas">Ganancia Real</p>
                                <p class="text-lg sm:text-xl font-black ${totalProfit >= 0 ? 'text-green-600' : 'text-red-500'} truncate max-w-[100px] sm:max-w-full leading-none" id="inv-kpi-profit" title="$${totalProfit.toLocaleString('es-CL')}">$${totalProfit.toLocaleString('es-CL')}</p>
                            </div>
                            <i class="fa-solid fa-sack-dollar text-3xl text-neutral-100 dark:text-neutral-800 absolute right-2 opacity-50 group-hover:scale-110 transition-transform"></i>
                        </div>
                    </div>

                    <!-- Add Item Form -->
                    <div class="bg-white dark:bg-neutral-900 rounded-lg shadow-sm border border-neutral-300 dark:border-neutral-700 overflow-hidden mb-6">
                        <div class="bg-neutral-100 dark:bg-neutral-800 p-3 border-b border-neutral-200 dark:border-neutral-700 flex items-center gap-2">
                            <i class="fa-solid fa-plus-circle text-green-600"></i> <h3 class="text-sm font-bold text-neutral-700 dark:text-neutral-300">Ingreso a Bodega</h3>
                        </div>
                        <div class="p-4 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-12 gap-3 items-end">
                            <div class="lg:col-span-2">
                                <label class="block text-[10px] font-bold text-neutral-400 uppercase tracking-wider mb-1">SKU/Cód.</label>
                                <input type="text" id="new-inv-sku" class="w-full p-2.5 bg-neutral-50 dark:bg-neutral-800 border border-neutral-200 dark:border-neutral-700 rounded text-sm outline-none focus:border-green-500 font-mono dark:text-white transition-colors" placeholder="Opcional">
                            </div>
                            <div class="lg:col-span-2">
                                <label class="block text-[10px] font-bold text-neutral-400 uppercase tracking-wider mb-1">Producto / Ítem *</label>
                                <input type="text" id="new-inv-product" class="w-full p-2.5 bg-neutral-50 dark:bg-neutral-800 border border-neutral-200 dark:border-neutral-700 rounded text-sm outline-none focus:border-green-500 font-bold dark:text-white transition-colors" placeholder="Ej: Filtro Aceite">
                            </div>
                            <div class="lg:col-span-2">
                                <label class="block text-[10px] font-bold text-neutral-400 uppercase tracking-wider mb-1">Categoría</label>
                                <select id="new-inv-category" class="w-full p-2.5 bg-neutral-50 dark:bg-neutral-800 border border-neutral-200 dark:border-neutral-700 rounded text-sm outline-none focus:border-green-500 dark:text-white transition-colors">
                                    <option value="Repuestos">Repuestos</option>
                                    <option value="Insumos">Insumos</option>
                                    <option value="Herramientas">Herramientas</option>
                                    <option value="Fluidos">Fluidos</option>
                                    <option value="Otros">Otros</option>
                                </select>
                            </div>
                            <div class="grid grid-cols-2 gap-2 lg:col-span-2">
                                <div>
                                    <label class="block text-[10px] font-bold text-neutral-400 uppercase tracking-wider mb-1">Stock</label>
                                    <input type="number" id="new-inv-qty" class="w-full p-2.5 bg-neutral-50 dark:bg-neutral-800 border border-neutral-200 dark:border-neutral-700 rounded text-sm outline-none focus:border-green-500 text-center font-bold dark:text-white transition-colors" placeholder="0" min="0">
                                </div>
                                <div>
                                    <label class="block text-[10px] font-bold text-neutral-400 uppercase tracking-wider mb-1" title="Alerta de Stock Bajo">Mín.</label>
                                    <input type="number" id="new-inv-min" class="w-full p-2.5 bg-neutral-50 dark:bg-neutral-800 border border-neutral-200 dark:border-neutral-700 rounded text-sm outline-none focus:border-green-500 text-center font-bold dark:text-white transition-colors" placeholder="1" min="0">
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-2 lg:col-span-3">
                                <div>
                                    <label class="block text-[10px] font-bold text-neutral-400 uppercase tracking-wider mb-1">Costo Un.</label>
                                    <input type="number" id="new-inv-price" class="w-full p-2.5 bg-neutral-50 dark:bg-neutral-800 border border-neutral-200 dark:border-neutral-700 rounded text-sm outline-none focus:border-blue-500 text-right font-bold text-blue-600 dark:text-blue-400 transition-colors" placeholder="$0" min="0">
                                </div>
                                <div>
                                    <label class="block text-[10px] font-bold text-neutral-400 uppercase tracking-wider mb-1">Venta Un.</label>
                                    <input type="number" id="new-inv-sale-price" class="w-full p-2.5 bg-neutral-50 dark:bg-neutral-800 border border-neutral-200 dark:border-neutral-700 rounded text-sm outline-none focus:border-green-500 text-right font-bold text-green-600 dark:text-green-400 transition-colors" placeholder="$0" min="0">
                                </div>
                            </div>
                            <div class="lg:col-span-1 sm:col-span-2 lg:mt-0 mt-2">
                                <button onclick="addInventoryItem()" class="w-full h-full min-h-[42px] bg-green-600 hover:bg-green-700 text-white font-bold rounded transition shadow-md text-sm flex items-center justify-center" title="Guardar"><i class="fa-solid fa-save"></i></button>
                            </div>
                        </div>
                    </div>

                    <!-- Buscador de Inventario -->
                    <div class="mb-4 relative">
                        <i class="fa-solid fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-neutral-400"></i>
                        <input type="text" id="inventory-search" placeholder="Buscar por SKU, nombre o categoría..." class="w-full pl-10 pr-4 py-3 rounded bg-white dark:bg-neutral-900 border border-neutral-300 dark:border-neutral-700 focus:ring-2 focus:ring-green-500 outline-none text-neutral-700 dark:text-neutral-200 font-bold transition shadow-sm" onkeyup="filterInventory(this.value)">
                    </div>

                    <!-- Inventory Table -->
                    <div class="bg-white dark:bg-neutral-900 rounded-lg shadow-sm border border-neutral-300 dark:border-neutral-700 overflow-x-auto hide-scrollbar mouse-drag">
                        <table class="w-full text-left border-collapse">
                            <thead>
                                <tr class="bg-neutral-100 dark:bg-neutral-800 text-xs text-neutral-500 dark:text-neutral-400 border-b border-neutral-200 dark:border-neutral-700">
                                    <th class="p-2 sm:p-3 font-bold uppercase tracking-wider lg:w-[30%] min-w-[180px]">Ítem / Detalle</th>
                                    <th class="p-2 sm:p-3 font-bold uppercase tracking-wider text-center lg:w-[15%] min-w-[90px]">Stock</th>
                                    <th class="p-2 sm:p-3 font-bold uppercase tracking-wider text-right lg:w-[20%] min-w-[120px]">Precios</th>
                                    <th class="p-2 sm:p-3 font-bold uppercase tracking-wider text-right lg:w-[20%] min-w-[130px]">Ventas / Ganancia</th>
                                    <th class="p-2 sm:p-3 lg:w-[15%] min-w-[80px]"></th>
                                </tr>
                            </thead>
                            <tbody id="inventory-table-body">
                                ${inventoryHTML || `<tr id="empty-inventory-msg"><td colspan="5" class="text-center py-12"><div class="w-16 h-16 bg-neutral-100 dark:bg-neutral-800 rounded-full flex items-center justify-center mx-auto mb-3"><i class="fa-solid fa-box-open text-2xl text-neutral-300 dark:text-neutral-600"></i></div><p class="text-sm font-bold text-neutral-400 dark:text-neutral-500">Inventario Vacío</p><p class="text-xs text-neutral-400 mt-1">Registra tus repuestos e insumos.</p></td></tr>`}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }
        
        function updateShopHeader(field, value) {
            if (field === 'title') state.shopTitle = value;
            if (field === 'address') state.shopAddress = value;
            if (field === 'note') state.shopNote = value; 
            saveData();
        }

        function clearShoppingList() {
            if (state.shoppingList.length === 0) return;
            showConfirmModal("¿Limpiar Lista?", "Se borrarán todos los productos.", "Limpiar Todo", function() {
                state.shoppingList = [];
                saveData();
                closeConfirmModal();
                const tbody = document.getElementById('shopping-table-body');
                if (tbody) {
                    tbody.innerHTML = `<tr id="empty-shop-msg"><td colspan="4" class="text-center py-8 text-neutral-400 dark:text-neutral-500 text-sm italic font-bold">La lista está vacía</td></tr>`;
                }
                updateShoppingTotal();
                showToast("Lista limpia", "fa-eraser");
            });
        }
        
        function switchShopTab(tab) {
            state.activeShopTab = tab;
            saveData(); 

            const tabs = ['items', 'services', 'inventory'];
            const inactiveClass = 'bg-neutral-100 dark:bg-neutral-800 text-neutral-500 dark:text-neutral-400 hover:text-neutral-700 dark:hover:text-neutral-200';
            const activeClass = 'bg-red-600 text-white shadow-md';
            
            tabs.forEach(t => {
                const content = document.getElementById(`shop-content-${t}`);
                const btn = document.getElementById(`shop-tab-${t}`);
                const isActive = (t === tab);
                
                if (btn) {
                    let classes = btn.className.split(' ').filter(c => !c.startsWith('bg-') && !c.startsWith('text-') && c !== 'shadow-md').join(' ');
                    btn.className = classes + ` transition flex-1 py-2 text-[10px] sm:text-xs font-bold rounded flex items-center justify-center gap-1.5 ${isActive ? activeClass : inactiveClass}`;
                }

                if (content) {
                    if (isActive) {
                        content.classList.remove('tab-content-leave');
                        content.classList.add('tab-content-enter');
                        content.style.position = 'relative'; 
                        content.style.display = 'block';
                    } else {
                        content.classList.remove('tab-content-enter');
                        content.classList.add('tab-content-leave');
                        setTimeout(() => { 
                            if(state.activeShopTab !== t) { 
                                content.style.display = 'none'; 
                                content.style.position = 'absolute';
                            }
                        }, 300);
                    }
                }
            });

            const searchEl = document.getElementById('inventory-search');
            if (searchEl) { searchEl.value = ''; filterInventory(''); }
            
            const shareBtnContainer = document.getElementById('share-btn-container');
            if (shareBtnContainer) {
                if (tab === 'items') {
                    updateShoppingTotal();
                    shareBtnContainer.innerHTML = `
                        <button onclick="clearShoppingList()" class="bg-neutral-200 dark:bg-neutral-800 text-neutral-600 dark:text-neutral-400 px-3 py-1.5 sm:px-4 sm:py-2 rounded text-xs sm:text-sm font-bold hover:bg-red-500 hover:text-white transition flex items-center gap-2" title="Limpiar Lista">
                            <i class="fa-solid fa-eraser"></i> <span class="hidden md:inline">Limpiar Lista</span>
                        </button>
                        <button onclick="downloadShoppingPDF()" class="bg-neutral-800 dark:bg-neutral-700 text-white px-3 py-1.5 sm:px-4 sm:py-2 rounded text-xs sm:text-sm font-bold shadow-lg hover:bg-neutral-700 dark:hover:bg-neutral-600 transition flex items-center gap-2">
                            <i class="fa-solid fa-share-nodes text-red-400"></i> <span class="hidden sm:inline">Compartir Productos</span>
                        </button>`;
                } else if (tab === 'services') {
                    updateServiceTotal(); 
                    shareBtnContainer.innerHTML = `
                        <button onclick="clearServiceList()" class="bg-neutral-200 dark:bg-neutral-800 text-neutral-600 dark:text-neutral-400 px-3 py-1.5 sm:px-4 sm:py-2 rounded text-xs sm:text-sm font-bold hover:bg-red-500 hover:text-white transition flex items-center gap-2" title="Limpiar Lista">
                            <i class="fa-solid fa-eraser"></i> <span class="hidden md:inline">Limpiar Servicios</span>
                        </button>
                        <button onclick="downloadServicePDF()" class="bg-neutral-800 dark:bg-neutral-700 text-white px-3 py-1.5 sm:px-4 sm:py-2 rounded text-xs sm:text-sm font-bold shadow-lg hover:bg-neutral-700 dark:hover:bg-neutral-600 transition flex items-center gap-2">
                            <i class="fa-solid fa-share-nodes text-blue-400"></i> <span class="hidden sm:inline">Compartir Servicios</span>
                        </button>`;
                } else if (tab === 'inventory') {
                    updateInventoryTotal();
                    shareBtnContainer.innerHTML = `
                        <button onclick="clearInventoryList()" class="bg-neutral-200 dark:bg-neutral-800 text-neutral-600 dark:text-neutral-400 px-3 py-1.5 sm:px-4 sm:py-2 rounded text-xs sm:text-sm font-bold hover:bg-red-500 hover:text-white transition flex items-center gap-2" title="Limpiar Inventario">
                            <i class="fa-solid fa-eraser"></i> <span class="hidden md:inline">Limpiar Inventario</span>
                        </button>
                        <button onclick="downloadInventoryPDF()" class="bg-neutral-800 dark:bg-neutral-700 text-white px-3 py-1.5 sm:px-4 sm:py-2 rounded text-xs sm:text-sm font-bold shadow-lg hover:bg-neutral-700 dark:hover:bg-neutral-600 transition flex items-center gap-2">
                            <i class="fa-solid fa-share-nodes text-green-400"></i> <span class="hidden sm:inline">Compartir Inventario</span>
                        </button>`;
                }
            }
        }
        
        function getShoppingListHTML() {
            const isItems = state.activeShopTab === 'items';
            const isInventory = state.activeShopTab === 'inventory';
            
            const activeClass = 'bg-red-600 text-white shadow-md';
            const inactiveClass = 'bg-neutral-100 dark:bg-neutral-800 text-neutral-500 dark:text-neutral-400 hover:text-neutral-700 dark:hover:text-neutral-200';

            const itemsActive = isItems ? activeClass : inactiveClass;
            const inventoryActive = isInventory ? activeClass : inactiveClass;

            const itemsContent = getShoppingListContentHTML();
            const inventoryContent = getInventoryListContentHTML();

            const itemsInitialClass = isItems ? 'tab-content-transition tab-content-enter relative block' : 'tab-content-transition tab-content-leave absolute hidden';
            const inventoryInitialClass = isInventory ? 'tab-content-transition tab-content-enter relative block' : 'tab-content-transition tab-content-leave absolute hidden';
            
            let shareButtonsHTML = '';
            if (isItems) {
                shareButtonsHTML = `<button onclick="clearShoppingList()" class="bg-neutral-200 dark:bg-neutral-800 text-neutral-600 dark:text-neutral-400 px-3 py-1.5 sm:px-4 sm:py-2 rounded text-xs sm:text-sm font-bold hover:bg-red-500 hover:text-white transition flex items-center gap-2" title="Limpiar Lista"><i class="fa-solid fa-eraser"></i> <span class="hidden md:inline">Limpiar Compras</span></button><button onclick="downloadShoppingPDF()" class="bg-neutral-800 dark:bg-neutral-700 text-white px-3 py-1.5 sm:px-4 sm:py-2 rounded text-xs sm:text-sm font-bold shadow-lg hover:bg-neutral-700 dark:hover:bg-neutral-600 transition flex items-center gap-2"><i class="fa-solid fa-share-nodes text-red-400"></i> <span class="hidden sm:inline">Exportar Compras</span></button>`;
            } else {
                shareButtonsHTML = `<button onclick="clearInventoryList()" class="bg-neutral-200 dark:bg-neutral-800 text-neutral-600 dark:text-neutral-400 px-3 py-1.5 sm:px-4 sm:py-2 rounded text-xs sm:text-sm font-bold hover:bg-red-500 hover:text-white transition flex items-center gap-2" title="Limpiar Inventario"><i class="fa-solid fa-eraser"></i> <span class="hidden md:inline">Limpiar Inventario</span></button><button onclick="downloadInventoryPDF()" class="bg-neutral-800 dark:bg-neutral-700 text-white px-3 py-1.5 sm:px-4 sm:py-2 rounded text-xs sm:text-sm font-bold shadow-lg hover:bg-neutral-700 dark:hover:bg-neutral-600 transition flex items-center gap-2"><i class="fa-solid fa-share-nodes text-green-400"></i> <span class="hidden sm:inline">Exportar Inventario</span></button>`;
            }

            return `
                <div class="pb-24 fade-enter">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
                        <h2 class="text-3xl font-black text-neutral-800 dark:text-neutral-100 tracking-tighter flex items-center gap-2">
                            <i class="fa-solid fa-boxes-stacked text-red-600"></i> Gestión
                        </h2>
                        <div class="flex gap-2 w-full sm:w-auto justify-end" id="share-btn-container">
                            ${shareButtonsHTML}
                        </div>
                    </div>

                    <div class="flex p-1 bg-neutral-200 dark:bg-neutral-700 rounded mb-6 shadow-inner gap-1">
                        <button onclick="setActiveShopTab('items')" id="shop-tab-items" class="flex-1 py-2 text-[10px] sm:text-xs font-bold rounded transition ${itemsActive} flex items-center justify-center gap-1.5"><i class="fa-solid fa-cart-arrow-down hidden sm:inline"></i> Compras</button>
                        <button onclick="setActiveShopTab('inventory')" id="shop-tab-inventory" class="flex-1 py-2 text-[10px] sm:text-xs font-bold rounded transition ${inventoryActive} flex items-center justify-center gap-1.5"><i class="fa-solid fa-box-open hidden sm:inline"></i> Inventario</button>
                    </div>

                    <div class="bg-white dark:bg-neutral-900 rounded-lg shadow-sm border border-neutral-300 dark:border-neutral-700 overflow-hidden mb-6">
                        <div class="p-4 border-b border-neutral-200 dark:border-neutral-800 bg-neutral-50 dark:bg-neutral-800/50">
                            <label class="block text-xs font-bold text-neutral-400 dark:text-neutral-500 uppercase tracking-wider mb-1">Título del Documento</label>
                            <input type="text" id="shop-title" value="${state.shopTitle}" onchange="updateShopHeader('title', this.value)" class="w-full bg-transparent text-xl font-black text-neutral-800 dark:text-neutral-100 outline-none border-b border-transparent focus:border-red-500 transition placeholder-neutral-300" placeholder="Ej: Repuestos Motor V8">
                        </div>
                        <div class="p-4 border-b border-neutral-200 dark:border-neutral-800">
                            <label class="block text-xs font-bold text-neutral-400 dark:text-neutral-500 uppercase tracking-wider mb-1">Dirección del Taller (para PDF)</label>
                            <input type="text" id="shop-address" value="${state.shopAddress}" onchange="updateShopHeader('address', this.value)" class="w-full bg-transparent text-sm font-bold text-neutral-600 dark:text-neutral-400 outline-none border-b border-transparent focus:border-red-500 transition placeholder-neutral-300" placeholder="Ej: Av. Principal 123, Santiago">
                        </div>
                        <div class="p-4">
                            <label class="block text-xs font-bold text-neutral-400 dark:text-neutral-500 uppercase tracking-wider mb-1">Nota al pie / Observaciones</label>
                            <input type="text" id="shop-note" value="${state.shopNote || ''}" onchange="updateShopHeader('note', this.value)" class="w-full bg-transparent text-sm font-bold text-neutral-600 dark:text-neutral-400 outline-none border-b border-transparent focus:border-blue-500 transition placeholder-neutral-300" placeholder="Ej: Solicitar factura a nombre de...">
                        </div>
                    </div>
                    
                    <div id="shop-content-wrapper" class="relative"> 
                        <div id="shop-content-items" class="${itemsInitialClass}">
                            ${itemsContent}
                        </div>
                        <div id="shop-content-inventory" class="${inventoryInitialClass}">
                            ${inventoryContent}
                        </div>
                    </div>
                </div>
            `;
        }

        function setActiveShopTab(tab) {
            if (state.view === 'shopping_list' && document.getElementById('shop-tab-items')) {
                switchShopTab(tab);
            } else {
                state.activeShopTab = tab;
                renderView('shopping_list');
            }
        }

        async function generateCleanPDF(contentHTML, title, fileName) {
            showToast("Generando PDF...", "fa-spinner fa-spin");

            const tempContainer = document.createElement('div');
            tempContainer.style.position = 'fixed';
            tempContainer.style.left = '-9999px';
            tempContainer.style.top = '0';
            tempContainer.style.width = '595px'; 
            tempContainer.style.backgroundColor = '#ffffff';
            tempContainer.style.zIndex = '-1';
            tempContainer.innerHTML = contentHTML;
            document.body.appendChild(tempContainer);

            try {
                // Pausa para asegurar que carguen los estilos
                await new Promise(resolve => setTimeout(resolve, 300));
                
                const canvas = await html2canvas(tempContainer, { 
                    scale: 1.5,
                    useCORS: true, 
                    logging: false,
                    allowTaint: true,
                    backgroundColor: '#ffffff'
                });
                
                const imgData = canvas.toDataURL('image/jpeg', 0.8);
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
                const imgProps = doc.getImageProperties(imgData);
                const pdfWidth = doc.internal.pageSize.getWidth();
                const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
                
                doc.addImage(imgData, 'JPEG', 0, 0, pdfWidth, pdfHeight);
                
                const pdfBlob = doc.output('blob');
                const file = new File([pdfBlob], fileName, { type: 'application/pdf' });

                // Solución Definitiva Android: Convertimos el blob a Base64 para una descarga/lectura 100% segura
                const reader = new FileReader();
                reader.readAsDataURL(pdfBlob);
                reader.onloadend = function() {
                    const base64data = reader.result;
                    
                    // Ocultamos el toast de "Generando..." mostrando uno invisible
                    showToast("¡Procesado!", "fa-check");

                    // Creamos el menú puente interactivo
                    const modalId = 'pdf-action-' + Date.now();
                    const modalHtml = `
                        <div id="${modalId}" class="fixed inset-0 bg-neutral-900/80 z-[100] flex items-center justify-center p-4 backdrop-blur-sm fade-enter">
                            <div class="bg-white dark:bg-neutral-900 rounded-xl shadow-2xl w-full max-w-xs p-6 border-t-4 border-red-600 text-center relative">
                                <button id="btn-close-top-${modalId}" class="absolute top-3 right-3 w-8 h-8 rounded bg-neutral-100 dark:bg-neutral-800 text-neutral-500 hover:text-red-500 transition flex items-center justify-center"><i class="fa-solid fa-xmark"></i></button>
                                <div class="w-16 h-16 bg-red-50 dark:bg-red-900/30 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4 border-4 border-red-100 dark:border-red-900/50">
                                    <i class="fa-solid fa-file-pdf text-3xl"></i>
                                </div>
                                <h3 class="text-xl font-black text-neutral-800 dark:text-neutral-100 mb-1">Documento Listo</h3>
                                <p class="text-xs text-neutral-500 dark:text-neutral-400 mb-6 font-mono truncate px-2">${fileName}</p>
                                <div class="flex flex-col gap-3">
                                    <button id="btn-share-${modalId}" class="w-full px-5 py-3.5 bg-red-600 text-white rounded-lg font-bold text-sm shadow-lg hover:bg-red-700 active:scale-95 transition flex items-center justify-center gap-2">
                                        <i class="fa-solid fa-share-nodes text-lg"></i> Compartir Archivo
                                    </button>
                                    <button id="btn-down-${modalId}" class="w-full px-5 py-3.5 bg-neutral-800 dark:bg-neutral-700 text-white rounded-lg font-bold text-sm shadow-lg hover:bg-neutral-700 active:scale-95 transition flex items-center justify-center gap-2">
                                        <i class="fa-solid fa-download text-lg"></i> Guardar en Teléfono
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    document.body.insertAdjacentHTML('beforeend', modalHtml);
                    
                    const modalEl = document.getElementById(modalId);
                    
                    // Acción: COMPARTIR (Ahora el dedo del usuario autoriza a Android instantáneamente)
                    document.getElementById(`btn-share-${modalId}`).onclick = async () => {
                        if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
                            try {
                                await navigator.share({ files: [file], title: title, text: "Cotización / Detalle adjunto." });
                                modalEl.remove();
                            } catch (e) {
                                console.log("Compartir cancelado");
                            }
                        } else {
                            showToast("Tu dispositivo no soporta compartir", "fa-triangle-exclamation");
                        }
                    };
                    
                    // Acción: DESCARGAR (Usando Base64 para que la App Web de Android no lo bloquee)
                    document.getElementById(`btn-down-${modalId}`).onclick = () => {
                        const a = document.createElement('a');
                        a.href = base64data;
                        a.download = fileName;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        modalEl.remove();
                        showToast("Descarga exitosa", "fa-download");
                    };
                    
                    // Acción: CERRAR
                    document.getElementById(`btn-close-top-${modalId}`).onclick = () => {
                        modalEl.remove();
                    };
                };

            } catch (err) {
                console.error("Error al generar PDF:", err);
                showToast("Error crítico al generar PDF", "fa-triangle-exclamation");
            } finally {
                if (document.body.contains(tempContainer)) {
                    document.body.removeChild(tempContainer);
                }
            }
        }

        async function downloadShoppingPDF() {
            if (state.shoppingList.length === 0) {
                showToast("Lista de productos vacía", "fa-triangle-exclamation");
                return;
            }

            const subtotal = state.shoppingList.reduce((sum, item) => sum + ((parseFloat(item.price) || 0) * (parseFloat(item.qty) || 1)), 0);
            const iva = Math.round(subtotal * 0.19);
            const total = subtotal + iva;
            const totalDisplay = `$${total.toLocaleString('es-CL', { minimumFractionDigits: 0 })}`;
            const ivaDisplay = `$${iva.toLocaleString('es-CL', { minimumFractionDigits: 0 })}`;
            const subtotalDisplay = `$${subtotal.toLocaleString('es-CL', { minimumFractionDigits: 0 })}`;

            const listItemsHTML = state.shoppingList.map((item) => {
                const sub = (parseFloat(item.price) || 0) * (parseFloat(item.qty) || 1);
                return `
                <tr style="border-bottom: 1px solid #eee;">
                    <td style="padding: 10px 15px; color: #333; font-weight: 500;">${item.product}</td>
                    <td style="padding: 10px 15px; color: #333; text-align: center;">${item.qty}</td>
                    <td style="padding: 10px 15px; color: #dc2626; font-weight: 700; text-align: right; width: 120px;">$${sub.toLocaleString('es-CL', { minimumFractionDigits: 0 })}</td>
                </tr>
            `}).join('');

            const addressText = state.shopAddress ? `<p style="margin: 5px 0 20px 0; color: #666; font-size: 14px;">Dirección: ${state.shopAddress}</p>` : '';
            const noteText = state.shopNote ? `
                <div style="margin-top: 30px;">
                    <strong style="font-size: 14px; color: #999; text-transform: uppercase;">OBSERVACIONES:</strong>
                    <p style="margin-top: 5px; font-style: italic; font-size: 14px;">${state.shopNote}</p>
                </div>` : '';

            const contentHTML = `
                <div style="padding: 40px; font-family: 'Roboto Condensed', sans-serif; color: #000; line-height: 1.2;">
                    <h1 style="font-size: 28px; font-weight: 700; margin-bottom: 5px;">${state.shopTitle || "Lista de Compras"}</h1>
                    ${addressText}
                    
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 30px; border: 1px solid #ddd; border-radius: 4px; overflow: hidden;">
                        <thead>
                            <tr style="background-color: #dc2626; color: white; font-weight: 700;">
                                <th style="padding: 10px 15px; text-align: left;">Producto / Repuesto</th>
                                <th style="padding: 10px 15px; text-align: center; width: 80px;">Cant.</th>
                                <th style="padding: 10px 15px; text-align: right; width: 120px;">Subtotal</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${listItemsHTML}
                        </tbody>
                        <tfoot>
                             <tr style="background-color: #f0f0f0; font-weight: 700; border-top: 2px solid #ddd;">
                                <td colspan="2" style="padding: 10px 15px; text-align: right; font-size: 16px;">TOTAL (+IVA)</td>
                                <td style="padding: 10px 15px; color: #dc2626; font-weight: 900; text-align: right; font-size: 18px;">${totalDisplay}
                                    <div style="font-size: 10px; color: #666; font-weight: 400; margin-top: 2px;">Subtotal: ${subtotalDisplay} | IVA (19%): ${ivaDisplay}</div>
                                </td>
                            </tr>
                        </tfoot>
                    </table>
                    
                    ${noteText}
                </div>
            `;
            
            const fileName = `Lista_Compras_${new Date().toISOString().slice(0,10)}.pdf`;
            await generateCleanPDF(contentHTML, state.shopTitle || "Lista de Compras", fileName);
        }

        async function downloadServicePDF() {
            if (state.serviceList.length === 0) {
                showToast("Lista de servicios vacía", "fa-triangle-exclamation");
                return;
            }
            
            const subtotal = state.serviceList.reduce((sum, item) => sum + (parseFloat(item.price) || 0), 0);
            const iva = Math.round(subtotal * 0.19);
            const total = subtotal + iva;
            const totalDisplay = `$${total.toLocaleString('es-CL', { minimumFractionDigits: 0 })}`;
            const ivaDisplay = `$${iva.toLocaleString('es-CL', { minimumFractionDigits: 0 })}`;
            const subtotalDisplay = `$${subtotal.toLocaleString('es-CL', { minimumFractionDigits: 0 })}`;
            
            const listItemsHTML = state.serviceList.map((item) => `
                <tr style="border-bottom: 1px solid #eee;">
                    <td style="padding: 10px 15px; color: #333; font-weight: 500;">${item.service}</td>
                    <td style="padding: 10px 15px; color: #dc2626; font-weight: 700; text-align: right; width: 120px;">$${(parseFloat(item.price) || 0).toLocaleString('es-CL', { minimumFractionDigits: 0 })}</td>
                </tr>
            `).join('');

            const addressText = state.shopAddress ? `<p style="margin: 5px 0 20px 0; color: #666; font-size: 14px;">Dirección: ${state.shopAddress}</p>` : '';
            const noteText = state.shopNote ? `
                <div style="margin-top: 30px;">
                    <strong style="font-size: 14px; color: #999; text-transform: uppercase;">OBSERVACIONES:</strong>
                    <p style="margin-top: 5px; font-style: italic; font-size: 14px;">${state.shopNote}</p>
                </div>` : '';

            const title = state.shopTitle.replace('Lista de Compras', 'Detalle de Servicios') || "Detalle de Servicios";

            const contentHTML = `
                <div style="padding: 40px; font-family: 'Roboto Condensed', sans-serif; color: #000; line-height: 1.2;">
                    <h1 style="font-size: 28px; font-weight: 700; margin-bottom: 5px;">${title}</h1>
                    ${addressText}
                    
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 4px; overflow: hidden;">
                        <thead>
                            <tr style="background-color: #dc2626; color: white; font-weight: 700;">
                                <th style="padding: 10px 15px; text-align: left;">Servicio / Detalle</th>
                                <th style="padding: 10px 15px; text-align: right; width: 120px;">Precio</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${listItemsHTML}
                        </tbody>
                        <tfoot>
                             <tr style="background-color: #f0f0f0; font-weight: 700; border-top: 2px solid #ddd;">
                                <td style="padding: 10px 15px; text-align: right; font-size: 16px;">TOTAL (+IVA)</td>
                                <td style="padding: 10px 15px; color: #dc2626; font-weight: 900; text-align: right; font-size: 18px;">${totalDisplay}
                                    <div style="font-size: 10px; color: #666; font-weight: 400; margin-top: 2px;">Subtotal: ${subtotalDisplay} | IVA (19%): ${ivaDisplay}</div>
                                </td>
                            </tr>
                        </tfoot>
                    </table>
                    
                    ${noteText}
                </div>
            `;
            
            const fileName = `Servicios_${new Date().toISOString().slice(0,10)}.pdf`;
            await generateCleanPDF(contentHTML, title, fileName);
        }

        async function downloadInventoryPDF() {
            if (state.inventoryList.length === 0) {
                showToast("El inventario está vacío", "fa-triangle-exclamation");
                return;
            }
            
            const totalCost = state.inventoryList.reduce((sum, item) => sum + ((parseFloat(item.price) || 0) * (parseFloat(item.qty) || 0)), 0);
            
            const totalProfit = state.inventoryList.reduce((sum, item) => {
                const p = parseFloat(item.price) || 0;
                const sp = parseFloat(item.salePrice) || 0;
                const sq = parseFloat(item.soldQty) || 0;
                return sum + (sq * (sp - p));
            }, 0);
            
            const listItemsHTML = state.inventoryList.map((item) => {
                const cost = parseFloat(item.price) || 0;
                const sale = parseFloat(item.salePrice) || 0;
                const sq = parseFloat(item.soldQty) || 0;
                const profit = sq * (sale - cost);
                
                const sku = item.sku || '---';
                return `
                <tr style="border-bottom: 1px solid #eee; font-size: 10px;">
                    <td style="padding: 6px 8px; color: #666; font-family: monospace; width: 12%;">${sku}</td>
                    <td style="padding: 6px 8px; color: #333; font-weight: bold; width: 30%;">${item.product}</td>
                    <td style="padding: 6px 8px; color: #333; text-align: center; width: 8%; font-weight: bold;">${item.qty}</td>
                    <td style="padding: 6px 8px; color: #2563eb; text-align: center; width: 8%; font-weight: bold;">${sq}</td>
                    <td style="padding: 6px 8px; color: #666; text-align: right; width: 14%;">$${cost.toLocaleString('es-CL')}</td>
                    <td style="padding: 6px 8px; color: #666; text-align: right; width: 14%;">$${sale.toLocaleString('es-CL')}</td>
                    <td style="padding: 6px 8px; color: ${profit >= 0 ? '#16a34a' : '#dc2626'}; font-weight: bold; text-align: right; width: 14%;">$${profit.toLocaleString('es-CL')}</td>
                </tr>
            `}).join('');

            const addressText = state.shopAddress ? `<p style="margin: 5px 0 20px 0; color: #666; font-size: 14px;">Dirección: ${state.shopAddress}</p>` : '';
            const noteText = state.shopNote ? `
                <div style="margin-top: 30px;">
                    <strong style="font-size: 14px; color: #999; text-transform: uppercase;">OBSERVACIONES:</strong>
                    <p style="margin-top: 5px; font-style: italic; font-size: 14px;">${state.shopNote}</p>
                </div>` : '';

            const title = state.shopTitle.replace('Lista de Compras', 'Reporte de Bodega') || "Reporte de Bodega e Ventas";

            const contentHTML = `
                <div style="padding: 40px; font-family: 'Roboto Condensed', sans-serif; color: #000; line-height: 1.2;">
                    <div style="display: flex; justify-content: space-between; border-bottom: 2px solid #16a34a; padding-bottom: 10px; margin-bottom: 20px;">
                        <div>
                            <h1 style="font-size: 28px; font-weight: 700; margin: 0 0 5px 0; color: #171717;">${title}</h1>
                            ${addressText}
                        </div>
                        <div style="text-align: right; color: #666;">
                            <p style="margin: 0; font-size: 12px; font-weight: bold;">Total Ítems en Catálogo: ${state.inventoryList.length}</p>
                            <p style="margin: 5px 0 0 0; font-size: 12px;">Fecha: ${new Date().toLocaleDateString()}</p>
                        </div>
                    </div>
                    
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 4px; overflow: hidden;">
                        <thead>
                            <tr style="background-color: #16a34a; color: white; font-weight: 700; font-size: 11px;">
                                <th style="padding: 8px; text-align: left;">SKU</th>
                                <th style="padding: 8px; text-align: left;">Producto</th>
                                <th style="padding: 8px; text-align: center;">Stock</th>
                                <th style="padding: 8px; text-align: center;">Ventas</th>
                                <th style="padding: 8px; text-align: right;">Costo Un.</th>
                                <th style="padding: 8px; text-align: right;">Venta Un.</th>
                                <th style="padding: 8px; text-align: right;">Ganancia Real</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${listItemsHTML}
                        </tbody>
                        <tfoot>
                             <tr style="background-color: #f0f0f0; font-weight: 700; border-top: 2px solid #ddd;">
                                <td colspan="3"></td>
                                <td colspan="2" style="padding: 10px; text-align: right; font-size: 12px; color: #666;">
                                    Inversión Estancada:<br>
                                    <span style="color:#000;">Ganancia Obtenida:</span>
                                </td>
                                <td colspan="2" style="padding: 10px; text-align: right; font-size: 14px;">
                                    <span style="color: #2563eb;">$${totalCost.toLocaleString('es-CL')}</span><br>
                                    <span style="color: ${totalProfit >= 0 ? '#16a34a' : '#dc2626'}; font-weight: 900;">$${totalProfit.toLocaleString('es-CL')}</span>
                                </td>
                            </tr>
                        </tfoot>
                    </table>
                    
                    ${noteText}
                </div>
            `;
            
            const fileName = `Inventario_Bodega_${new Date().toISOString().slice(0,10)}.pdf`;
            await generateCleanPDF(contentHTML, title, fileName);
        }

        async function downloadWorkOrderPDF(patientId) {
            const p = state.patients.find(x => x.id === patientId);
            if (!p) return;
            
            if (p.tasks.length === 0) {
                showToast("Agrega servicios a la orden primero", "fa-triangle-exclamation");
                return;
            }

            const subtotal = p.tasks.reduce((sum, item) => sum + (parseFloat(item.price) || 0), 0);
            const iva = Math.round(subtotal * 0.19);
            const total = subtotal + iva;
            
            const listItemsHTML = p.tasks.map((item) => `
                <tr style="border-bottom: 1px solid #eee;">
                    <td style="padding: 10px 15px; color: #333; font-weight: 500;">
                        <span style="font-size: 10px; color: ${item.done ? '#16a34a' : '#999'}; margin-right: 5px;">[${item.done ? 'LISTO' : 'PEND.'}]</span> 
                        ${item.text}
                    </td>
                    <td style="padding: 10px 15px; color: #dc2626; font-weight: 700; text-align: right; width: 120px;">$${(parseFloat(item.price) || 0).toLocaleString('es-CL')}</td>
                </tr>
            `).join('');

            const shopData = state.appTitle || "Mecamonico Taller";
            const addressText = state.shopAddress ? `<p style="margin: 5px 0 0 0; color: #666; font-size: 14px;">Dirección: ${state.shopAddress}</p>` : '';

            const contentHTML = `
                <div style="padding: 40px; font-family: 'Roboto Condensed', sans-serif; color: #000; line-height: 1.2;">
                    <div style="display: flex; justify-content: space-between; border-bottom: 3px solid #dc2626; padding-bottom: 15px; margin-bottom: 25px;">
                        <div>
                            <h1 style="font-size: 32px; font-weight: 900; margin: 0; color: #171717;">${shopData}</h1>
                            ${addressText}
                        </div>
                        <div style="text-align: right;">
                            <h2 style="margin: 0; font-size: 20px; color: #dc2626;">COTIZACIÓN / O.T.</h2>
                            <p style="margin: 5px 0 0 0; font-size: 14px; color: #666;">Fecha: ${new Date().toLocaleDateString('es-CL')}</p>
                        </div>
                    </div>

                    <div style="background-color: #f5f5f5; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
                        <p style="margin: 0 0 5px 0; font-size: 14px;"><strong>Cliente / Modelo:</strong> ${p.name}</p>
                        <p style="margin: 0 0 5px 0; font-size: 14px;"><strong>Patente:</strong> ${p.room}</p>
                        <p style="margin: 0 0 5px 0; font-size: 14px;"><strong>Contacto:</strong> ${p.contact || '---'}</p>
                        <p style="margin: 0; font-size: 14px; color: #dc2626;"><strong>Falla Inicial / Diagnóstico:</strong> ${p.dx}</p>
                    </div>
                    
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 4px; overflow: hidden;">
                        <thead>
                            <tr style="background-color: #dc2626; color: white; font-weight: 700;">
                                <th style="padding: 10px 15px; text-align: left;">Detalle de Servicio / Repuesto</th>
                                <th style="padding: 10px 15px; text-align: right; width: 120px;">Valor</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${listItemsHTML}
                        </tbody>
                        <tfoot>
                             <tr style="background-color: #f0f0f0; font-weight: 700; border-top: 2px solid #ddd;">
                                <td style="padding: 10px 15px; text-align: right; font-size: 16px;">TOTAL (+IVA)</td>
                                <td style="padding: 10px 15px; color: #dc2626; font-weight: 900; text-align: right; font-size: 18px;">$${total.toLocaleString('es-CL')}
                                    <div style="font-size: 10px; color: #666; font-weight: 400; margin-top: 2px;">Sub: $${subtotal.toLocaleString('es-CL')} | IVA: $${iva.toLocaleString('es-CL')}</div>
                                </td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            `;
            
            const fileName = `Cotizacion_${p.room.replace(/[^a-zA-Z0-9]/g, '')}_${new Date().toISOString().slice(0,10)}.pdf`;
            await generateCleanPDF(contentHTML, `Cotización ${p.room}`, fileName);
        }
        
        async function shareNote(noteId) {
            const note = state.notes.find(n => n.id === noteId);
            if (!note) {
                showToast("No se encontró el apunte", "fa-triangle-exclamation");
                return;
            }

            const textContent = note.text || '';
            const formattedText = textContent.replace(/\n/g, '<br>');

            let imagesHTML = '';
            if (note.images && note.images.length > 0) {
                imagesHTML = `<div style="margin-top: 20px; display: flex; flex-direction: column; gap: 15px; align-items: center;">` +
                    note.images.map(img => `<img src="${img}" style="max-width: 100%; max-height: 400px; border-radius: 4px; object-fit: contain;">`).join('') +
                    `</div>`;
            } else if (note.image) { 
                imagesHTML = `<div style="margin-top: 20px; text-align: center;">
                    <img src="${note.image}" style="max-width: 100%; max-height: 400px; border-radius: 4px; object-fit: contain;">
                </div>`;
            }

            // Diseño puramente en blanco: Sin títulos, sin fechas, sin bordes.
            const contentHTML = `
                <div style="padding: 40px; font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; color: #171717; line-height: 1.6;">
                    <div style="font-size: 15px; text-align: justify; color: #333;">
                        ${formattedText}
                    </div>
                    ${imagesHTML}
                </div>
            `;

            const safeTitle = textContent.substring(0, 15).replace(/[^a-zA-Z0-9]/g, '_');
            const fileName = `Apunte_${safeTitle || 'SinTitulo'}_${new Date().toISOString().slice(0,10)}.pdf`;
            
            await generateCleanPDF(contentHTML, "Apunte de Bitácora", fileName);
        }

        function performContentSwap(viewName) {
            const container = document.getElementById('app-container');
            state.view = viewName; 
            state.editingNoteId = null; 
            document.querySelectorAll('.nav-btn').forEach(btn => { if(btn.dataset.target === viewName) btn.classList.add('active'); else btn.classList.remove('active'); }); 
            let containerClass = "app-view-wrapper fade-enter min-h-full "; 
            if (viewName === 'dashboard' || viewName === 'notes' || viewName === 'links' || viewName === 'work_orders' || viewName === 'shopping_list') containerClass += "w-full max-w-7xl mx-auto"; else containerClass += "max-w-md mx-auto"; 
            let contentHTML = '';
            try { 
                switch(viewName) { 
                    case 'dashboard': contentHTML = getDashboardHTML(); break; 
                    case 'turnario': contentHTML = getTurnarioHTML(); break; 
                    case 'todo': contentHTML = getTodoHTML(); break; 
                    case 'notes': contentHTML = getNotesHTML(); break; 
                    case 'links': contentHTML = getLinksHTML(); break; 
                    case 'work_orders': contentHTML = getWorkOrdersHTML(); break; 
                    case 'shopping_list': contentHTML = getShoppingListHTML(); break; 
                    default: contentHTML = getDashboardHTML(); 
                } 
            } catch (e) { console.error(e); contentHTML = `<div class="p-8 text-center text-red-400">Error.</div>`; } 

            const wrapper = document.createElement('div'); 
            wrapper.className = containerClass; 
            wrapper.innerHTML = contentHTML; 
            container.replaceChildren(wrapper); 
            container.scrollTop = 0; 
            
            if (viewName === 'notes') { 
                updateImagePreview();
            } 
            if (viewName === 'shopping_list') {
                updateShoppingTotal();
                updateServiceTotal(); 
                updateInventoryTotal();
                
                const itemsContent = document.getElementById('shop-content-items');
                const servicesContent = document.getElementById('shop-content-services');
                const inventoryContent = document.getElementById('shop-content-inventory');
                
                if(itemsContent) { itemsContent.style.display = 'none'; itemsContent.style.position = 'absolute'; }
                if(servicesContent) { servicesContent.style.display = 'none'; servicesContent.style.position = 'absolute'; }
                if(inventoryContent) { inventoryContent.style.display = 'none'; inventoryContent.style.position = 'absolute'; }
                
                if (state.activeShopTab === 'items' && itemsContent) {
                    itemsContent.style.display = 'block'; itemsContent.style.position = 'relative'; 
                } else if (state.activeShopTab === 'services' && servicesContent) {
                    servicesContent.style.display = 'block'; servicesContent.style.position = 'relative'; 
                } else if (state.activeShopTab === 'inventory' && inventoryContent) {
                    inventoryContent.style.display = 'block'; inventoryContent.style.position = 'relative'; 
                }
            }
            saveData();
        }

        function renderView(viewName) {
            const container = document.getElementById('app-container');
            const currentWrapper = container.querySelector('.app-view-wrapper');

            if (currentWrapper && state.view !== null) {
                if (state.view === viewName) {
                    performContentSwap(viewName);
                    return;
                }
                
                currentWrapper.classList.remove('fade-enter');
                currentWrapper.classList.add('fade-leave');
                
                setTimeout(() => {
                    performContentSwap(viewName);
                }, 200); 
            } else {
                performContentSwap(viewName);
            }
        }

        function filterInventory(query) {
            const term = query.toLowerCase();
            const tbody = document.getElementById('inventory-table-body');
            if (!tbody) return;
            Array.from(tbody.querySelectorAll('tr')).forEach(tr => {
                if (tr.id === 'empty-inventory-msg') return;
                
                // Recolectar todo el texto visual y los values de los inputs (Para buscar por SKU, Nombre, Categoría)
                let rowText = tr.innerText.toLowerCase();
                tr.querySelectorAll('input[type="text"]').forEach(inp => {
                    rowText += ' ' + inp.value.toLowerCase();
                });
                
                tr.style.display = rowText.includes(term) ? '' : 'none';
            });
        }
        
        function filterNotes(query) {
            document.getElementById('notes-list').innerHTML = generateNotesListHTML(query);
        }
        
        function filterInfo(query) {
            const term = query.toLowerCase();
            const isWeb = state.activeInfoTab === 'web';
            const listId = isWeb ? 'links-list' : 'pdfs-list';
            const list = document.getElementById(listId);
            if (!list) return;
            Array.from(list.children).forEach(child => {
                if (child.classList.contains('opacity-40')) return; 
                const text = child.innerText.toLowerCase();
                child.style.display = text.includes(term) ? '' : 'none';
            });
        }

        // --- SISTEMA DE BÚSQUEDA UNIVERSAL ---
        window.globalSearchActions = [];

        function handleUniversalSearch(query, mode) {
            const resultsContainer = document.getElementById(`${mode}-search-results`);
            if (!query || query.trim().length < 2) {
                resultsContainer.classList.add('hidden');
                return;
            }
            const term = query.toLowerCase().trim();
            let results = [];

            // 1. Órdenes / Taller
            (state.patients || []).forEach(p => {
                if (p.name.toLowerCase().includes(term) || p.room.toLowerCase().includes(term) || p.dx.toLowerCase().includes(term)) {
                    results.push({ type: 'Vehículo', title: `${p.name} (${p.room})`, desc: p.dx, icon: 'fa-car-side', color: 'text-blue-500', bg: 'bg-blue-100 dark:bg-blue-900/30', 
                    action: () => { 
                        renderView('work_orders'); 
                        setTimeout(() => highlightElement(`wo-card-${p.id}`), 500); 
                    } });
                }
            });

            // 2. Inventario
            (state.inventoryList || []).forEach(i => {
                if (i.product.toLowerCase().includes(term) || (i.sku && i.sku.toLowerCase().includes(term)) || (i.category && i.category.toLowerCase().includes(term))) {
                    results.push({ type: 'Inventario', title: i.product, desc: `Stock: ${i.qty} | SKU: ${i.sku||'N/A'}`, icon: 'fa-box-open', color: 'text-green-600', bg: 'bg-green-100 dark:bg-green-900/30', 
                    action: () => { 
                        setActiveShopTab('inventory'); 
                        setTimeout(() => highlightElement(`inventory-row-${i.id}`), 500); 
                    } });
                }
            });

            // 3. Bitácora / Apuntes
            (state.notes || []).forEach(n => {
                if (n.text.toLowerCase().includes(term)) {
                    let preview = n.text.replace(/\n/g, ' ');
                    if(preview.length > 40) preview = preview.substring(0, 40) + '...';
                    results.push({ type: 'Apunte', title: preview, desc: 'Bitácora Técnica', icon: 'fa-book-open', color: 'text-yellow-600 dark:text-yellow-500', bg: 'bg-yellow-100 dark:bg-yellow-900/30', 
                    action: () => { 
                        state.currentFolderId = 'all'; // Forzamos ir a la vista general de notas
                        renderView('notes'); 
                        setTimeout(() => highlightElement(`note-${n.id}`), 500); 
                    } });
                }
            });

            // 4. Manuales PDF
            (state.pdfs || []).forEach(p => {
                if (p.title.toLowerCase().includes(term)) {
                    results.push({ type: 'Manual', title: p.title, desc: 'Documentación PDF', icon: 'fa-file-pdf', color: 'text-red-500', bg: 'bg-red-100 dark:bg-red-900/30', 
                    action: () => { 
                        state.activeInfoTab = 'pdf'; // Forzamos la vista de PDF
                        if(state.view !== 'links') renderView('links');
                        else setInfoTab('pdf');
                        // Abrimos directamente el PDF
                        setTimeout(() => openPdfReader(p.id), 500); 
                    } });
                }
            });

            // 5. Enlaces
            (state.links || []).forEach(l => {
                if (l.title.toLowerCase().includes(term) || l.url.toLowerCase().includes(term)) {
                    results.push({ type: 'Recurso Web', title: l.title, desc: l.url, icon: 'fa-link', color: 'text-purple-500', bg: 'bg-purple-100 dark:bg-purple-900/30', 
                    action: () => { 
                        state.activeInfoTab = 'web';
                        if(state.view !== 'links') renderView('links');
                        else setInfoTab('web');
                        setTimeout(() => highlightElement(`link-${l.id}`), 500); 
                    } });
                }
            });

            // 6. Tareas Pendientes
            (state.todos || []).forEach(t => {
                if (t.text.toLowerCase().includes(term)) {
                    results.push({ type: 'Tarea', title: t.text, desc: t.done ? 'Completada' : 'Pendiente', icon: 'fa-clipboard-check', color: 'text-neutral-500', bg: 'bg-neutral-200 dark:bg-neutral-700', 
                    action: () => { 
                        renderView('todo'); 
                        setTimeout(() => highlightElement(`todo-${t.id}`), 500); 
                    } });
                }
            });

            if (results.length === 0) {
                resultsContainer.innerHTML = `<div class="p-5 text-sm font-bold text-neutral-400 dark:text-neutral-500 text-center"><i class="fa-solid fa-magnifying-glass-minus mb-2 text-2xl opacity-50 block"></i> No hay resultados para "${query}"</div>`;
            } else {
                window.globalSearchActions = results.slice(0, 15); // Limitar a 15 resultados para no saturar
                resultsContainer.innerHTML = window.globalSearchActions.map((r, idx) => `
                    <div class="p-3 border-b border-neutral-100 dark:border-neutral-700 hover:bg-neutral-50 dark:hover:bg-neutral-700 cursor-pointer flex items-center gap-3 transition" onmousedown="executeGlobalSearch(${idx}, '${mode}')">
                        <div class="w-10 h-10 rounded-lg ${r.bg} flex items-center justify-center shrink-0 shadow-sm"><i class="fa-solid ${r.icon} ${r.color} text-lg"></i></div>
                        <div class="flex-1 min-w-0">
                            <div class="flex justify-between items-baseline mb-0.5">
                                <p class="text-[9px] font-black uppercase tracking-wider ${r.color} opacity-90">${r.type}</p>
                            </div>
                            <p class="text-sm font-bold truncate leading-tight">${r.title}</p>
                            <p class="text-[11px] text-neutral-500 dark:text-neutral-400 truncate mt-0.5">${r.desc}</p>
                        </div>
                        <i class="fa-solid fa-chevron-right text-neutral-300 dark:text-neutral-600 text-xs shrink-0"></i>
                    </div>
                `).join('');
            }
            resultsContainer.classList.remove('hidden');
        }

        function executeGlobalSearch(index, mode) {
            if (window.globalSearchActions && window.globalSearchActions[index]) {
                const action = window.globalSearchActions[index].action;
                const inputEl = document.getElementById(`${mode}-search-input`);
                if (inputEl) {
                    inputEl.value = '';
                    inputEl.blur(); // Ocultar el teclado en móviles
                }
                document.getElementById(`${mode}-search-results`).classList.add('hidden');
                if(mode === 'mobile') {
                    document.getElementById('mobile-search-container').classList.add('hidden');
                }
                action();
            }
        }

        function hideUniversalSearch(mode) {
            // Un pequeño delay para permitir que el onmousedown de las tarjetas se ejecute antes de ocultarlas
            setTimeout(() => {
                const el = document.getElementById(`${mode}-search-results`);
                if(el) el.classList.add('hidden');
            }, 200);
        }

        function toggleMobileSearch() {
            const container = document.getElementById('mobile-search-container');
            container.classList.toggle('hidden');
            if (!container.classList.contains('hidden')) {
                setTimeout(() => document.getElementById('mobile-search-input').focus(), 50);
            }
        }

        function highlightElement(id) {
            const el = document.getElementById(id);
            if (el) {
                el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                
                // Efecto visual de resaltado
                const originalBg = el.style.backgroundColor;
                const originalTransition = el.style.transition;
                
                el.style.transition = 'all 0.5s ease';
                el.classList.add('ring-4', 'ring-red-500', 'ring-offset-2', 'dark:ring-offset-neutral-900');
                
                setTimeout(() => {
                    el.classList.remove('ring-4', 'ring-red-500', 'ring-offset-2', 'dark:ring-offset-neutral-900');
                    setTimeout(() => { el.style.transition = originalTransition; }, 500);
                }, 2000);
            }
        }

        // --- SISTEMA FINANCIERO (MODAL) ---
        function updateDashboardFinanceDOM() {
            const container = document.getElementById('finance-widget-container');
            const header = document.getElementById('profile-card-header');
            if (!container) return; // Si no está en el dashboard ignora

            if (!state.showFinanceWidget) {
                container.classList.remove('flex');
                container.classList.add('hidden');
                if(header) header.className = "flex items-center gap-4"; // Quita el borde inferior
                return;
            } else {
                container.classList.remove('hidden');
                container.classList.add('flex');
                if(header) header.className = "flex items-center gap-4 border-b border-neutral-100 dark:border-neutral-800 pb-2";
            }

            const today = new Date(); 
            const year = today.getFullYear(); 
            const month = String(today.getMonth() + 1).padStart(2, '0'); 
            const day = String(today.getDate()).padStart(2, '0'); 
            const dateKey = `${year}-${month}-${day}`;

            const dailyTxs = (state.transactions || []).filter(t => t.date === dateKey);
            const dailyIncome = dailyTxs.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const dailyExpense = dailyTxs.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            const dailyProfit = dailyIncome - dailyExpense;
            const signStr = dailyProfit < 0 ? '-' : (dailyProfit > 0 ? '+' : '');

            const isPositive = dailyProfit >= 0;
            const profitColor = isPositive ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400';
            
            const baseClass = "items-center justify-between p-2.5 rounded-lg border transition-all duration-300 shadow-sm group relative mt-3";
            const bgClass = isPositive ? 'bg-green-50 dark:bg-green-900/10 border-green-200 dark:border-green-800/50 hover:bg-green-100 dark:hover:bg-green-900/30' : 'bg-red-50 dark:bg-red-900/10 border-red-200 dark:border-red-800/50 hover:bg-red-100 dark:hover:bg-red-900/30';
            container.className = `flex ${baseClass} ${bgClass}`;

            const amountEl = document.getElementById('finance-widget-amount');
            if (amountEl) {
                amountEl.innerText = `${signStr}$${Math.abs(dailyProfit).toLocaleString('es-CL')}`;
                amountEl.className = `text-2xl font-black ${profitColor} tracking-tight mr-1 mt-2.5`;
            }

            const iconBg = document.getElementById('finance-widget-icon-bg');
            if (iconBg) {
                iconBg.className = `w-10 h-10 rounded-full bg-white dark:bg-neutral-800 flex items-center justify-center shadow-sm group-hover:scale-105 transition shrink-0 ${profitColor}`;
            }
            
            const textColor = document.getElementById('finance-widget-text-color');
            if (textColor) {
                textColor.className = profitColor;
            }
        }

        function openFinanceModal() {
            currentFinanceDate = new Date();
            const y = currentFinanceDate.getFullYear();
            const m = String(currentFinanceDate.getMonth() + 1).padStart(2, '0');
            const d = String(currentFinanceDate.getDate()).padStart(2, '0');
            const finDateEl = document.getElementById('fin-date');
            if(finDateEl) finDateEl.value = `${y}-${m}-${d}`;
            
            renderFinanceModalContent();
            document.body.classList.add('modal-open');
            document.getElementById('finance-modal').classList.remove('hidden');
        }

        function closeFinanceModal() {
            document.body.classList.remove('modal-open');
            document.getElementById('finance-modal').classList.add('hidden');
            updateDashboardFinanceDOM();
        }

        function changeFinanceMonth(delta) {
            currentFinanceDate.setMonth(currentFinanceDate.getMonth() + delta);
            renderFinanceModalContent();
        }

        function renderFinanceModalContent() {
            const year = currentFinanceDate.getFullYear();
            const month = currentFinanceDate.getMonth();
            const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
            document.getElementById('finance-month-title').innerText = `${monthNames[month]} ${year}`;

            const monthPrefix = `${year}-${String(month + 1).padStart(2, '0')}`;
            const monthTxs = (state.transactions || []).filter(t => t.date.startsWith(monthPrefix)).sort((a, b) => b.date.localeCompare(a.date) || b.id - a.id);

            let income = 0; let expense = 0;
            monthTxs.forEach(t => {
                if (t.type === 'income') income += t.amount;
                else expense += t.amount;
            });
            const balance = income - expense;

            document.getElementById('finance-income').innerText = `$${income.toLocaleString('es-CL')}`;
            document.getElementById('finance-expense').innerText = `$${expense.toLocaleString('es-CL')}`;
            
            const balanceEl = document.getElementById('finance-balance');
            const sign = balance < 0 ? '-' : (balance > 0 ? '+' : '');
            balanceEl.innerText = `${sign}$${Math.abs(balance).toLocaleString('es-CL')}`;
            balanceEl.className = `text-xl font-black ${balance >= 0 ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}`;

            const listContainer = document.getElementById('finance-list');
            if (monthTxs.length === 0) {
                listContainer.innerHTML = `<div class="flex flex-col items-center justify-center py-10 opacity-50"><i class="fa-solid fa-receipt text-4xl mb-3 text-neutral-400"></i><p class="text-sm font-bold text-neutral-500">Sin movimientos registrados</p><p class="text-xs mt-1 text-neutral-400">Este mes está vacío.</p></div>`;
            } else {
                listContainer.innerHTML = monthTxs.map(t => {
                    const isInc = t.type === 'income';
                    const sSign = isInc ? '+' : '-';
                    const color = isInc ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400';
                    const bgIcon = isInc ? 'bg-green-100 dark:bg-green-900/30 border-green-200 dark:border-green-800' : 'bg-red-100 dark:bg-red-900/30 border-red-200 dark:border-red-800';
                    const icon = isInc ? 'fa-arrow-trend-up' : 'fa-arrow-trend-down';
                    
                    const [y, m, d] = t.date.split('-');
                    const dateObj = new Date(y, m - 1, d);
                    const dateStr = dateObj.toLocaleDateString('es-ES', { day: '2-digit', month: 'short' });

                    return `
                    <div class="flex items-center justify-between p-3 mb-1.5 rounded border border-neutral-100 dark:border-neutral-800 bg-neutral-50/50 dark:bg-neutral-800/20 hover:bg-neutral-50 dark:hover:bg-neutral-800/50 transition">
                        <div class="flex items-center gap-3 w-[65%]">
                            <div class="w-10 h-10 rounded-lg flex items-center justify-center border ${bgIcon} ${color} shrink-0"><i class="fa-solid ${icon} text-sm"></i></div>
                            <div class="min-w-0">
                                <p class="text-sm font-bold text-neutral-800 dark:text-neutral-200 truncate pr-2">${t.concept}</p>
                                <p class="text-[10px] font-mono text-neutral-400 dark:text-neutral-500 mt-0.5"><i class="fa-regular fa-calendar mr-1"></i>${dateStr}</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-3 shrink-0">
                            <span class="font-black ${color} text-sm whitespace-nowrap">${sSign}$${t.amount.toLocaleString('es-CL')}</span>
                            <button onclick="deleteTransaction(${t.id})" class="text-neutral-300 dark:text-neutral-600 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/30 w-7 h-7 rounded flex items-center justify-center transition"><i class="fa-solid fa-trash-can text-xs"></i></button>
                        </div>
                    </div>`;
                }).join('');
            }
        }

        function addTransaction() {
            const concept = document.getElementById('fin-concept').value.trim();
            const amount = parseFloat(document.getElementById('fin-amount').value);
            const type = document.getElementById('fin-type').value;
            const date = document.getElementById('fin-date').value;

            if (!concept || isNaN(amount) || amount <= 0 || !date) {
                showToast("Completa los datos", "fa-triangle-exclamation");
                return;
            }

            const newTx = { id: Date.now(), concept, amount, type, date };
            if (!state.transactions) state.transactions = [];
            state.transactions.push(newTx);
            saveData();

            document.getElementById('fin-concept').value = '';
            document.getElementById('fin-amount').value = '';
            
            // Re-evaluar fecha actual del modal para no sacarlo del mes actual al agregar
            const txDate = new Date(date + 'T12:00:00');
            currentFinanceDate = txDate; 

            renderFinanceModalContent();
            showToast("Movimiento registrado", "fa-check");
            document.getElementById('fin-concept').focus();
        }

        function deleteTransaction(id) {
            state.transactions = state.transactions.filter(t => t.id !== id);
            saveData();
            renderFinanceModalContent();
            showToast("Registro eliminado", "fa-trash");
        }

        // --- SISTEMA DE CONFIGURACIÓN GLOBAL ---
        const moduleNames = {
            'dashboard': { icon: 'fa-warehouse', name: 'Inicio', locked: true }, // Nunca se oculta
            'work_orders': { icon: 'fa-car-side', name: 'Taller', locked: false },
            'shopping_list': { icon: 'fa-boxes-stacked', name: 'Gestión', locked: false },
            'todo': { icon: 'fa-clipboard-list', name: 'Tareas', locked: false },
            'turnario': { icon: 'fa-calendar-days', name: 'Calendario', locked: false },
            'notes': { icon: 'fa-book-open', name: 'Apuntes', locked: false },
            'links': { icon: 'fa-toolbox', name: 'Información', locked: false }
        };

        // --- SISTEMA DE TEMAS ---
        function setAppTheme(themeName) {
            if (!window.themesRGB[themeName]) return;
            const palette = window.themesRGB[themeName];
            const root = document.documentElement;
            
            // Actualizar variables CSS en tiempo real
            for (const [weight, rgb] of Object.entries(palette)) {
                root.style.setProperty(`--theme-${weight}`, rgb);
            }
            root.style.setProperty('--mech-primary', `rgb(${palette[600]})`);
            
            // Guardar para evitar parpadeo al recargar
            localStorage.setItem('mech_theme', themeName);
            
            // Guardar en base de datos
            state.appTheme = themeName;
            saveData();
            
            updateThemeButtonsUI(themeName);
            showToast("Tema actualizado", "fa-palette");
        }

        function updateThemeButtonsUI(activeTheme) {
            const colors = ['rojo', 'azul', 'verde', 'naranja', 'morado'];
            colors.forEach(c => {
                const btn = document.getElementById(`theme-btn-${c}`);
                if (btn) {
                    if (c === activeTheme) {
                        btn.classList.add('ring-neutral-400', 'dark:ring-neutral-200', 'ring-offset-2', 'dark:ring-offset-neutral-900');
                        btn.classList.remove('ring-transparent');
                    } else {
                        btn.classList.remove('ring-neutral-400', 'dark:ring-neutral-200', 'ring-offset-2', 'dark:ring-offset-neutral-900');
                        btn.classList.add('ring-transparent');
                    }
                }
            });
        }

        function openSettingsModal() {
            document.getElementById('toggle-finance-widget').checked = state.showFinanceWidget;
            
            // Resaltar botón de tema actual
            updateThemeButtonsUI(state.appTheme || localStorage.getItem('mech_theme') || 'rojo');

            const list = document.getElementById('modules-settings-list');
            list.innerHTML = Object.entries(moduleNames).map(([key, data]) => `
                <label class="flex items-center justify-between p-2.5 rounded bg-neutral-50 dark:bg-neutral-800/30 border border-neutral-200 dark:border-neutral-700 ${data.locked ? 'opacity-60 cursor-not-allowed' : 'cursor-pointer hover:bg-neutral-100 dark:hover:bg-neutral-800'} transition">
                    <span class="text-sm font-bold text-neutral-700 dark:text-neutral-300 flex items-center gap-3"><i class="fa-solid ${data.icon} text-neutral-400 w-4 text-center"></i> ${data.name}</span>
                    <input type="checkbox" ${state.visibleModules.includes(key) ? 'checked' : ''} ${data.locked ? 'disabled' : ''} onchange="toggleModuleSetting('${key}', this.checked)" class="w-5 h-5 accent-red-600">
                </label>
            `).join('');

            document.body.classList.add('modal-open');
            document.getElementById('settings-modal').classList.remove('hidden');
        }

        function closeSettingsModal() {
            document.body.classList.remove('modal-open');
            document.getElementById('settings-modal').classList.add('hidden');
        }

        function toggleFinanceSetting(checked) {
            state.showFinanceWidget = checked;
            saveData();
            updateDashboardFinanceDOM();
        }

        function hideFinanceWidgetDirectly(event) {
            event.stopPropagation(); // Evita que se abra el modal
            state.showFinanceWidget = false;
            saveData();
            updateDashboardFinanceDOM();
            showToast("Balance oculto. Actívalo en Configuración.", "fa-eye-slash");
        }

        function toggleModuleSetting(key, checked) {
            if (checked && !state.visibleModules.includes(key)) {
                state.visibleModules.push(key);
            } else if (!checked && state.visibleModules.includes(key)) {
                state.visibleModules = state.visibleModules.filter(m => m !== key);
                // Si oculta la vista actual, lo enviamos al dashboard
                if (state.view === key) {
                    renderView('dashboard'); 
                }
            }
            saveData();
            updateNavVisibility();
        }

        function updateNavVisibility() {
            document.querySelectorAll('.nav-btn').forEach(btn => {
                const target = btn.dataset.target;
                if (state.visibleModules.includes(target)) {
                    btn.classList.remove('hidden');
                } else {
                    btn.classList.add('hidden');
                }
            });
        }

        // Inicializar la aplicación
        // --- SISTEMA DE HISTORIAL DE ÓRDENES ---
        function openHistoryModal() {
            document.body.classList.add('modal-open');
            document.getElementById('history-modal').classList.remove('hidden');
            document.getElementById('history-search-input').value = '';
            renderHistoryList();
            setTimeout(() => document.getElementById('history-search-input').focus(), 100);
        }

        function closeHistoryModal() {
            document.body.classList.remove('modal-open');
            document.getElementById('history-modal').classList.add('hidden');
        }

        function renderHistoryList(query = '') {
            const container = document.getElementById('history-list-container');
            let archived = (state.patients || []).filter(p => p.status === 'archivada');
            
            if (query.trim()) {
                const term = query.toLowerCase().trim();
                archived = archived.filter(p => p.room.toLowerCase().includes(term) || p.name.toLowerCase().includes(term));
            }

            // Ordenar por fecha de archivo (más reciente primero)
            archived.sort((a, b) => {
                const da = a.archiveDate ? new Date(a.archiveDate).getTime() : 0;
                const db = b.archiveDate ? new Date(b.archiveDate).getTime() : 0;
                return db - da;
            });

            if (archived.length === 0) {
                container.innerHTML = `<div class="text-center py-10 opacity-50"><i class="fa-solid fa-box-archive text-4xl mb-3 text-neutral-400"></i><p class="text-sm font-bold text-neutral-500">No hay registros archivados</p></div>`;
                return;
            }

            container.innerHTML = archived.map(p => {
                const dateStr = p.archiveDate ? new Date(p.archiveDate).toLocaleDateString('es-CL') : 'Fecha desconocida';
                const tasksHtml = p.tasks && p.tasks.length > 0 
                    ? p.tasks.map(t => `<li class="text-sm flex items-start gap-2 mb-1"><i class="fa-solid fa-check text-green-500 mt-1"></i> <span class="text-neutral-600 dark:text-neutral-300">${t.text}</span></li>`).join('')
                    : `<li class="text-sm text-neutral-400 italic">Sin detalles registrados</li>`;
                
                return `
                <div class="bg-white dark:bg-neutral-800 border border-neutral-200 dark:border-neutral-700 rounded-lg p-4 mb-3 shadow-sm hover:shadow transition">
                    <div class="flex justify-between items-start mb-3 border-b border-neutral-100 dark:border-neutral-700 pb-2">
                        <div>
                            <span class="inline-block px-2 py-0.5 rounded bg-neutral-200 dark:bg-neutral-700 text-neutral-600 dark:text-neutral-300 text-[10px] font-bold tracking-widest mb-1 shadow-sm">${p.room}</span>
                            <h4 class="text-lg font-black text-neutral-800 dark:text-neutral-100">${p.name}</h4>
                            <p class="text-xs font-bold text-neutral-500 dark:text-neutral-400 mt-0.5"><i class="fa-solid fa-calendar-check mr-1"></i> Archivado el ${dateStr}</p>
                        </div>
                        <button onclick="restorePatient(${p.id})" class="text-xs bg-neutral-100 dark:bg-neutral-700 text-neutral-600 dark:text-neutral-300 px-3 py-1.5 rounded hover:bg-blue-500 hover:text-white transition font-bold" title="Devolver al taller">
                            <i class="fa-solid fa-rotate-left mr-1"></i> Restaurar
                        </button>
                    </div>
                    <div>
                        <p class="text-sm font-bold text-red-600 mb-2"><i class="fa-solid fa-wrench text-xs mr-1 opacity-70"></i> Servicio inicial: ${p.dx}</p>
                        <ul class="pl-1">
                            ${tasksHtml}
                        </ul>
                    </div>
                </div>`;
            }).join('');
        }

        function restorePatient(id) {
            const p = state.patients.find(x => x.id === id);
            if (p) {
                p.status = 'activa';
                p.archiveDate = null;
                saveData();
                renderHistoryList(document.getElementById('history-search-input').value);
                if (state.view === 'work_orders' || state.view === 'dashboard') renderView(state.view);
                showToast("Vehículo restaurado al Taller", "fa-rotate-left");
            }
        }
        window.onload = init;
    </script>
</body>
</html>
